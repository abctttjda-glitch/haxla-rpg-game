<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Job Master Tower v4.6.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:8px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:4px; cursor:pointer; padding:8px; font-size:11px; }
button:active { background: #444; }
.active-toggle { background: #006400; border-color: #0f0; }

/* ãƒ¡ã‚¤ãƒ³UI */
.hero-status-panel { background:var(--panel); border:1px solid var(--accent); padding:10px; border-radius:4px; margin-bottom:6px; display:grid; grid-template-columns: 1fr 1.5fr; gap:10px; }
.exp-bar { width: 100%; background: #222; height: 5px; margin-top: 4px; }
.exp-fill { background: #3498db; height: 100%; width: 0%; transition: width 0.3s; }

.enemy-box { text-align: center; padding: 10px; border: 1px solid var(--border); background: #000; margin-bottom: 6px; }
.hp-bar { width: 100%; background:#200; height:12px; border:1px solid #400; margin-top:4px; }
.hp-fill { background:linear-gradient(90deg, #900, #f00); height:100%; width:100%; }

.log-area { flex: 1; background:#000; border:1px solid var(--border); overflow-y:auto; padding:8px; font-size:11px; line-height:1.3; display:flex; flex-direction:column-reverse; margin-bottom:6px; }

.battle-actions { display: flex; gap: 4px; margin-bottom: 8px; }
#btnAttack { flex: 2; height: 45px; background: #400; font-weight: bold; border: 1px solid #822; }

.btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.98); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:92%; padding:15px; overflow-y:auto; }
.list-row { border-bottom:1px solid #222; padding:10px 0; }
.st-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.step-btns button { padding: 4px 8px; margin-left: 2px; }
</style>
</head>
<body>

<div class="hero-status-panel">
    <div>
        <small id="jobLabel" style="color:var(--accent)">---</small><br>
        <b style="font-size:16px;">Lv.<span id="hLv">1</span></b><br>
        <div style="font-size:10px;">
            Next: <span id="nextExp">0</span><br>
            <div class="exp-bar"><div id="expFill" class="exp-fill"></div></div>
        </div>
    </div>
    <div style="font-size:11px;">
        HP : <b id="hHp">0/0</b><br>
        ATK: <b id="hAtk">0</b> / DEF: <b id="hDef">0</b><br>
        PP : <b id="hPp" style="color:#3498db">0</b> / SP: <b id="hSp" style="color:var(--accent)">0</b>
    </div>
</div>

<div class="enemy-box">
    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
        <span onclick="changeFloor(-1)">â—€</span>
        <b id="eName">---</b>
        <span onclick="changeFloor(1)">â–¶</span>
    </div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
    <div id="eHpNum" style="font-size:10px;">0 / 0</div>
</div>

<div class="log-area" id="log"></div>

<div class="battle-actions">
    <button id="btnAttack">æ”»æ’ƒ</button>
    <button id="btnAuto" onclick="toggleAuto()">AUTO: OFF</button>
</div>

<div class="btn-grid">
    <button onclick="openM('statM')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
    <button onclick="openM('jobM')">ã‚¸ãƒ§ãƒ–</button>
    <button onclick="openM('skillM')">ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">ã‚¢ã‚¤ãƒ†ãƒ </button>
</div>

<div id="statM" class="modal"><div class="modal-content">
    <h3>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¼·åŒ– (PP:<span id="mPp">0</span>)</h3>
    <button id="btnAutoAllot" onclick="toggleAutoAllot()">è‡ªå‹•ã‚¹ãƒ†æŒ¯ã‚Š: OFF</button>
    <div style="margin:15px 0;">
        <div class="st-row">
            <span>åŠ›(ATK)</span>
            <div class="step-btns">
                <button onclick="modST('atk',1)">+1</button><button onclick="modST('atk',10)">+10</button><button onclick="modST('atk',100)">+100</button>
            </div>
        </div>
        <div class="st-row">
            <span>å®ˆ(DEF)</span>
            <div class="step-btns">
                <button onclick="modST('def',1)">+1</button><button onclick="modST('def',10)">+10</button><button onclick="modST('def',100)">+100</button>
            </div>
        </div>
        <div class="st-row">
            <span>å‘½(HPx10)</span>
            <div class="step-btns">
                <button onclick="modST('hp',1)">+1</button><button onclick="modST('hp',10)">+10</button><button onclick="modST('hp',100)">+100</button>
            </div>
        </div>
    </div>
    <button onclick="resetPP()" style="color:#e74c3c">PPå…¨æŒ¯ã‚Šç›´ã—</button><br><br>
    <button onclick="closeM('statM')" style="width:100%">é–‰ã˜ã‚‹</button>
</div></div>

<div id="jobM" class="modal"><div class="modal-content"><h3>ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–(20ç¨®)</h3><div id="jobList"></div><br><button onclick="closeM('jobM')">æˆ»ã‚‹</button></div></div>
<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ <span id="curJobTitle"></span> ã‚¹ã‚­ãƒ«</h3><div id="sList"></div><br><button onclick="closeM('skillM')">æˆ»ã‚‹</button></div></div>
<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ </h3><div id="iList"></div><br><button onclick="closeM('equipM')">æˆ»ã‚‹</button></div></div>

<script>
const SAVE_KEY = "Slayer_v4.6.0";
let floor=1, maxFloor=1, sp=0, pp=0, auto=false, autoAllot=false, inBattle=false;
let st = { hp:20, atk:10, def:10 }; 
let hero = { lv:1, exp:0, job:'warrior', eq:{w:null, a:null} };
let inventory = [], skills = {};

const JOB_DATA = {
    warrior: { n:"æˆ¦å£«", s:["å¼·æ’ƒ", "é‡è£…", "ä¸€é–ƒ", "é€†é±—", "ä¸å±ˆ", "å’†å“®", "é›éŒ¬", "çªç ´", "ç·´æ°—", "å¥¥ç¾©"] },
    mage: { n:"é­”è¡“å¸«", s:["ç«ç‚", "ç‘æƒ³", "é­”åŠ›", "é›·æ’ƒ", "è© å”±", "å¸é­”", "çµç•Œ", "è³¢çŸ¥", "å¢—å¹…", "æ¥µå¤§"] },
    thief: { n:"ç›—è³Š", s:["æ€¥æ‰€", "å›é¿", "å¼·æ¬²", "å¥‡è¥²", "ä¿Šæ•", "æ¯’åˆƒ", "éš å¯†", "ç›®åˆ©ã", "é€ƒèµ°", "ç¥é€Ÿ"] },
    paladin: { n:"è–é¨å£«", s:["çŒ®èº«", "è–ç›¾", "å›å¾©", "é‰„å£", "åŠ è­·", "å¯©åˆ¤", "è€æ€§", "æ²»ç™’", "å¨åœ§", "ä¸æ»…"] }
    // ... ä»–16ç¨®
};

function updateUI() {
    let sA=0, sD=0, sH=0;
    Object.keys(skills).forEach(j => {
        Object.keys(skills[j]).forEach(sid => {
            const lv = skills[j][sid];
            sA += lv*2; sD += lv*1; sH += lv*20;
        });
    });
    
    let eA = hero.eq.w ? hero.eq.w.atk : 0;
    let eD = hero.eq.a ? hero.eq.a.def : 0;

    hero.maxHp = st.hp * 10 + sH;
    hero.atk = st.atk + sA + eA;
    hero.def = st.def + sD + eD;
    
    const nextVal = hero.lv * 60;
    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hPp").innerText = pp;
    document.getElementById("hSp").innerText = sp;
    document.getElementById("nextExp").innerText = nextVal - hero.exp;
    document.getElementById("expFill").style.width = (hero.exp / nextVal * 100) + "%";
    document.getElementById("jobLabel").innerText = (JOB_DATA[hero.job]||{n:hero.job}).n;
    document.getElementById("mPp").innerText = pp;
    document.getElementById("btnAutoAllot").className = autoAllot ? "active-toggle" : "";
    document.getElementById("btnAutoAllot").innerText = "è‡ªå‹•ã‚¹ãƒ†æŒ¯ã‚Š: " + (autoAllot?"ON":"OFF");
}

function modST(k, v) {
    let amt = Math.min(v, pp);
    if(amt > 0) { st[k] += amt; pp -= amt; }
    updateUI(); save();
}

function resetPP() {
    pp += (st.hp - 20) + (st.atk - 10) + (st.def - 10);
    st = { hp:20, atk:10, def:10 };
    updateUI(); save();
}

function toggleAutoAllot() { autoAllot = !autoAllot; updateUI(); }
function toggleAuto() { auto = !auto; document.getElementById("btnAuto").className = auto ? "active-toggle" : ""; }

function addLog(msg, col="") {
    const l = document.getElementById("log");
    const d = document.createElement("div"); if(col) d.style.color = col;
    d.innerText = `> ${msg}`; l.prepend(d);
    if(l.childNodes.length > 25) l.removeChild(l.lastChild);
}

function changeFloor(v) {
    let n = floor + v;
    if(n >= 1 && n <= maxFloor) { floor = n; inBattle = false; nextBattle(); updateUI(); }
}

let enemy = null;
function nextBattle() {
    if(inBattle) return;
    const isB = (floor % 50 === 0);
    const m = Math.pow(1.05, floor-1) * (isB ? 4 : 1);
    enemy = {
        name: (isB?"ã€BOSSã€‘":"") + "éšå±¤ã®å®ˆè­·è€… " + floor + "F",
        hp: Math.floor((100 + floor*15) * m),
        atk: Math.floor((10 + floor*1.5) * m),
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    inBattle = true; updateE();
}

function updateE() {
    if(!enemy) return;
    document.getElementById("eHpFill").style.width = (enemy.hp/enemy.maxHp*100) + "%";
    document.getElementById("eHpNum").innerText = `${Math.floor(enemy.hp)} / ${enemy.maxHp}`;
}

function pAtk() {
    if(!inBattle || !enemy) return;
    enemy.hp -= Math.max(1, hero.atk - enemy.atk*0.05);
    updateE();
    if(enemy.hp <= 0) {
        const xp = 20 + floor;
        addLog(`${enemy.name}æ’ƒç ´ï¼ ${xp}EXPç²å¾—`, "#2ecc71");
        hero.exp += xp;
        if(hero.exp >= hero.lv * 60) {
            hero.exp = 0; hero.lv++; pp += 5; sp += 1;
            if(autoAllot) { 
                st.atk += 2; st.def += 1; st.hp += 2; pp -= 5; 
                addLog("è‡ªå‹•ã‚¹ãƒ†æŒ¯ã‚Šå®Ÿè¡Œ (ATK+2 DEF+1 HP+2)");
            }
            addLog(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ PP+5 SP+1`, "#3498db");
        }
        if(Math.random() < 0.2) drop();
        if(floor === maxFloor) maxFloor++;
        floor++; inBattle = false; save(); updateUI();
        setTimeout(nextBattle, 200);
    }
}

function drop() {
    const isW = Math.random() > 0.5;
    const l = Math.floor(floor/5) + 1;
    const i = { id:Date.now(), n:`(Lv.${l}) `+(isW?"è‹±é›„ã®å‰£":"é­”ç‹ã®é§"), type:isW?'w':'a', atk:isW?l*12:0, def:isW?0:l*10 };
    inventory.push(i);
    addLog(`å…¥æ‰‹ï¼š${i.n} [${isW?'ATK':'DEF'}+${isW?i.atk:i.def}]`, "#d4af37");
}

setInterval(() => { if(auto && inBattle) pAtk(); }, 100);
setInterval(() => { if(inBattle) {
    hero.hp -= Math.max(1, enemy.atk - hero.def);
    updateUI();
    if(hero.hp <= 0) { inBattle=false; hero.hp=hero.maxHp; setTimeout(nextBattle, 1000); }
}}, 1000);

// ãŸãŸã‹ã†ãƒœã‚¿ãƒ³
const btnAtk = document.getElementById("btnAttack");
btnAtk.addEventListener("touchstart", (e) => { e.preventDefault(); pAtk(); });
btnAtk.addEventListener("mousedown", pAtk);

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='jobM'?'jobList':id==='skillM'?'sList':'iList');
    if(!d) return; d.innerHTML = "";
    if(id==='jobM') Object.keys(JOB_DATA).concat(["monk","samurai","ninja","archer","assassin","priest","bard","fencer","sage","necromancer","berserker","mechanic","dragoon","alchemist","darknight","guardian"]).forEach(k => {
        d.innerHTML += `<div class="list-row"><b>${(JOB_DATA[k]||{n:k}).n}</b> <button onclick="changeJob('${k}')">è»¢è·</button></div>`;
    });
    if(id==='skillM') {
        const skills_list = (JOB_DATA[hero.job]||{s:["å…±é€šæŠ€è¡“"]}).s;
        skills_list.forEach((sn, i) => {
            const sid = hero.job+"_"+i; const lv = (skills[hero.job]||{})[sid]||0;
            d.innerHTML += `<div class="list-row"><b>${sn} (Lv.${lv})</b> <button onclick="buyS('${sid}')">å¼·åŒ–</button></div>`;
        });
    }
    if(id==='equipM') inventory.forEach(i => {
        const isEq = hero.eq.w?.id === i.id || hero.eq.a?.id === i.id;
        d.innerHTML += `<div class="list-row"><b>${i.n}</b> [${i.atk?`ATK+${i.atk}`:`DEF+${i.def}`}] <button onclick="eqI(${i.id})" ${isEq?'disabled':''}>è£…å‚™</button></div>`;
    });
}

function changeJob(k) { hero.job = k; updateUI(); save(); openM('jobM'); }
function buyS(id) { if(sp>=1){ sp--; if(!skills[hero.job]) skills[hero.job]={}; skills[hero.job][id]=(skills[hero.job][id]||0)+1; updateUI(); save(); openM('skillM'); } }
function eqI(id) { const i = inventory.find(x=>x.id===id); hero.eq[i.type]=i; updateUI(); save(); openM('equipM'); }
function closeM(id) { document.getElementById(id).style.display = "none"; }
function save() { localStorage.setItem(SAVE_KEY, JSON.stringify({ hero, st, skills, inventory, floor, maxFloor, sp, pp, auto, autoAllot })); }
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) { const d = JSON.parse(s); hero=d.hero; st=d.st; skills=d.skills; inventory=d.inventory; floor=d.floor; maxFloor=d.maxFloor; sp=d.sp; pp=d.pp; auto=d.auto; autoAllot=d.autoAllot||false; }
    hero.hp = hero.maxHp;
}
load(); updateUI(); nextBattle();
</script>
</body>
</html>

