<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Job Master Tower v4.3.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #222; --btn: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:8px; overflow:hidden; }
button { background:var(--btn); color:#eee; border:1px solid #444; border-radius:4px; cursor:pointer; padding:10px; font-size:12px; }
button:active { background: #555; }
button:disabled { opacity: 0.1; }

/* æ•µUI */
.tower-info { text-align: center; border: 1px solid #333; padding: 4px; margin-bottom: 4px; font-size: 12px; }
.enemy-box { text-align: center; padding: 12px; border: 1px solid var(--border); background: #000; margin-bottom: 8px; }
.hp-bar { width: 100%; background:#200; height:12px; border:1px solid #400; margin-top:6px; overflow:hidden; }
.hp-fill { background:linear-gradient(90deg, #800, #f22); height:100%; width:100%; transition: width 0.2s; }

/* æˆ¦é—˜ãƒ­ã‚° */
.log-area { flex: 1; background:#000; border:1px solid var(--border); overflow-y:auto; padding:8px; font-size:11px; line-height:1.5; display:flex; flex-direction:column-reverse; margin-bottom:8px; }

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.battle-actions { display: flex; gap: 8px; margin-bottom: 8px; }
#btnAttack { flex: 1; height: 60px; background: #400; border: 2px solid #822; font-weight: bold; font-size: 16px; }

/* ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.98); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:92%; padding:15px; overflow-y:auto; }
.list-row { border-bottom:1px solid #222; padding:12px 0; display:flex; justify-content:space-between; align-items:center; }
.st-control { display:flex; align-items:center; gap:10px; }
.st-btn { width:34px; height:34px; padding:0; font-size:18px; }
</style>
</head>
<body>

<div class="tower-info">
    <b style="color:var(--accent)">Trial Tower <span id="floor">1</span>F</b>
</div>

<div class="enemy-box">
    <div id="eName" style="font-size:16px; font-weight:bold;">---</div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
    <div id="eHpNum" style="font-size:11px; margin-top:4px;">0 / 0</div>
</div>

<div class="log-area" id="log"></div>

<div class="battle-actions">
    <button id="btnAttack">ãŸãŸã‹ã†</button>
</div>

<div class="btn-grid">
    <button onclick="openM('statM')">ğŸ“Š çŠ¶æ…‹</button>
    <button onclick="openM('jobM')">ğŸ›¡ï¸ è·ç¨®</button>
    <button onclick="openM('skillM')">ğŸ“ è¡“æ³•</button>
    <button onclick="openM('equipM')">ğŸ“¦ é“å…·</button>
</div>

<div id="statM" class="modal"><div class="modal-content">
    <h3>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (PP:<span id="mPp">0</span>)</h3>
    <div style="background:#000; padding:15px; border-radius:5px;">
        <div class="list-row"><span>åŠ› (ATK+3)</span><div class="st-control"><button class="st-btn" onclick="modST('atk',-1)">-</button><b id="stAtk">0</b><button class="st-btn" onclick="modST('atk',1)">+</button></div></div>
        <div class="list-row"><span>å®ˆ (DEF+2)</span><div class="st-control"><button class="st-btn" onclick="modST('def',-1)">-</button><b id="stDef">0</b><button class="st-btn" onclick="modST('def',1)">+</button></div></div>
        <div class="list-row"><span>å‘½ (HP+50)</span><div class="st-control"><button class="st-btn" onclick="modST('hp',-1)">-</button><b id="stHp">0</b><button class="st-btn" onclick="modST('hp',1)">+</button></div></div>
    </div>
    <p style="font-size:11px; color:#888;">â€»PPã¯ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã§ç²å¾—ã€‚è‡ªç”±ã«æŒ¯ã‚Šç›´ã—å¯èƒ½ã§ã™ã€‚</p>
    <button onclick="closeM('statM')" style="width:100%">é–‰ã˜ã‚‹</button>
</div></div>

<div id="jobM" class="modal"><div class="modal-content"><h3>ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–ãƒã‚§ãƒ³ã‚¸</h3><div id="jobList"></div><br><button onclick="closeM('jobM')" style="width:100%">æˆ»ã‚‹</button></div></div>
<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ <span id="curJobTitle"></span> ã‚¹ã‚­ãƒ« (SP:<span id="mSp">0</span>)</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">æˆ»ã‚‹</button></div></div>
<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ </h3><div id="iList"></div><br><h3>âœ¨ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ</h3><div id="aList"></div><br><button onclick="closeM('equipM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<script>
const SAVE_KEY = "Slayer_v4.3.0";
let floor=1, sp=0, pp=0, inBattle=false;
let st = { atk:0, def:0, hp:0 }; 
let hero = { lv:1, exp:0, hp:200, maxHp:200, job:'hero', eq:{w:null, a:null, r:null} };
let inventory = [], artifacts = [], skills = {};

const JOBS = {
    hero:{n:"å‹‡è€…"}, paladin:{n:"è–é¨å£«"}, berserker:{n:"ç‹‚æˆ¦å£«"}, ninja:{n:"å¿è€…"}, 
    dragoon:{n:"ç«œé¨å£«"}, sage:{n:"è³¢è€…"}, assassin:{n:"æš—æ®ºè€…"}, samurai:{n:"ä¾"},
    monk:{n:"ãƒ¢ãƒ³ã‚¯"}, hunter:{n:"ç‹©äºº"}, bard:{n:"åŸéŠè©©äºº"}, lich:{n:"æ­»éœŠè¡“å¸«"}
};

// å…¨ã‚¸ãƒ§ãƒ–ã«ãƒ‘ãƒƒã‚·ãƒ–5ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–5ã‚’å®šç¾©ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ä¸€éƒ¨è©³ç´°åŒ–ï¼‰
const JOB_SKILLS = {};
Object.keys(JOBS).forEach(k => {
    JOB_SKILLS[k] = [
        {id:k+"_p1", n:"ãƒ‘ãƒƒã‚·ãƒ– I", type:"P", d:"ATK+5", max:10, eff:{atk:5}},
        {id:k+"_p2", n:"ãƒ‘ãƒƒã‚·ãƒ– II", type:"P", d:"DEF+5", max:10, eff:{def:5}},
        {id:k+"_p3", n:"ãƒ‘ãƒƒã‚·ãƒ– III", type:"P", d:"HP+100", max:10, eff:{hp:100}},
        {id:k+"_p4", n:"ãƒ‘ãƒƒã‚·ãƒ– IV", type:"P", d:"CRIT+1%", max:10, eff:{crit:0.01}},
        {id:k+"_p5", n:"ãƒ‘ãƒƒã‚·ãƒ– V", type:"P", d:"EXP+5%", max:10, eff:{exp:0.05}},
        {id:k+"_a1", n:"ã‚¢ã‚¯ãƒ†ã‚£ãƒ– I", type:"A", d:"10%ã§2å€æ’ƒ", max:10, eff:{mult:2, chance:0.1}},
        {id:k+"_a2", n:"ã‚¢ã‚¯ãƒ†ã‚£ãƒ– II", type:"A", d:"5%ã§å›å¾©", max:10},
        {id:k+"_a3", n:"ã‚¢ã‚¯ãƒ†ã‚£ãƒ– III", type:"A", d:"ç‰¹æ®ŠåŠ¹æœ", max:10},
        {id:k+"_a4", n:"ã‚¢ã‚¯ãƒ†ã‚£ãƒ– IV", type:"A", d:"ç¯„å›²æ”»æ’ƒ", max:10},
        {id:k+"_a5", n:"ã‚¢ã‚¯ãƒ†ã‚£ãƒ– V", type:"A", d:"å¥¥ç¾©", max:10},
    ];
});

function updateUI() {
    let sA=0, sD=0, sH=0, sCr=0, sE=0;
    Object.keys(skills).forEach(j => {
        Object.keys(skills[j]).forEach(sid => {
            const s = JOB_SKILLS[j].find(x=>x.id===sid);
            if(!s || s.type !== "P") return;
            const lv = skills[j][sid];
            if(s.eff.atk) sA += s.eff.atk * lv;
            if(s.eff.def) sD += s.eff.def * lv;
            if(s.eff.hp) sH += s.eff.hp * lv;
            if(s.eff.crit) sCr += s.eff.crit * lv;
            if(s.eff.exp) sE += s.eff.exp * lv;
        });
    });
    
    let eA=0, eD=0, eH=0;
    ['w','a','r'].forEach(t => { if(hero.eq[t]) { eA += hero.eq[t].atk; eD += hero.eq[t].def; eH += hero.eq[t].hp; } });

    hero.maxHp = 200 + st.hp*50 + sH + eH;
    hero.atk = 15 + st.atk*3 + sA + eA;
    hero.def = 10 + st.def*2 + sD + eD;
    hero.crit = sCr;
    hero.expBonus = sE;

    document.getElementById("floor").innerText = floor;
    document.getElementById("stAtk").innerText = st.atk;
    document.getElementById("stDef").innerText = st.def;
    document.getElementById("stHp").innerText = st.hp;
    document.getElementById("mPp").innerText = pp;
    document.getElementById("mSp").innerText = sp;
}

function modST(k, v) {
    if(v > 0 && pp > 0) { st[k]++; pp--; }
    else if(v < 0 && st[k] > 0) { st[k]--; pp++; }
    updateUI(); save();
}

function addLog(msg, col="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    if(col) d.style.color = col;
    d.innerText = `> ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 25) l.removeChild(l.lastChild);
}

// æˆ¦é—˜ãƒ­ã‚¸ãƒƒã‚¯
let currentEnemy = null;
function nextBattle() {
    if(inBattle) return;
    const isB = (floor % 50 === 0);
    const p = Math.pow(1.06, floor-1) * (isB ? 5 : 1);
    currentEnemy = {
        name: isB ? `ã€BOSSã€‘${floor}Fã®å®ˆè­·è€…` : `é­”ç‰© Lv.${floor}`,
        hp: Math.floor((100 + floor*20) * p),
        atk: Math.floor((10 + floor*2) * p),
    };
    currentEnemy.maxHp = currentEnemy.hp;
    document.getElementById("eName").innerText = currentEnemy.name;
    document.getElementById("eName").style.color = isB ? "#f22" : "#ccc";
    inBattle = true;
    updateEnemyUI();
}

function updateEnemyUI() {
    if(!currentEnemy) return;
    document.getElementById("eHpFill").style.width = (currentEnemy.hp/currentEnemy.maxHp*100) + "%";
    document.getElementById("eHpNum").innerText = `${Math.floor(currentEnemy.hp)} / ${currentEnemy.maxHp}`;
}

function playerAttack() {
    if(!inBattle || !currentEnemy) return;
    let d = Math.max(1, hero.atk - currentEnemy.atk*0.05);
    if(Math.random() < hero.crit) { d *= 2; addLog("ä¼šå¿ƒï¼", "#d4af37"); }
    currentEnemy.hp -= d;
    updateEnemyUI();
    if(currentEnemy.hp <= 0) win();
}

function win() {
    addLog(`${currentEnemy.name} ã‚’æ’ƒç ´ã€‚`);
    hero.exp += (30 + floor) * (1 + hero.expBonus);
    if(hero.exp >= 100) { hero.lv++; hero.exp=0; sp++; pp++; addLog("LvUP!", "#3498db"); }
    if(floor % 100 === 0) dropArtifact();
    else if(Math.random() < 0.2) dropItem();
    floor++; inBattle = false; save(); updateUI();
    setTimeout(nextBattle, 600);
}

function enemyTurn() {
    if(!inBattle || !currentEnemy) return;
    hero.hp -= Math.max(1, currentEnemy.atk - hero.def);
    updateUI();
    if(hero.hp <= 0) {
        addLog("æ•—åŒ—...", "#e74c3c");
        hero.hp = hero.maxHp; inBattle = false;
        setTimeout(nextBattle, 1500);
    }
}

// ãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼ˆã‚ªãƒ¼ãƒˆã¯åŠåˆ†ã®é€Ÿåº¦ï¼š0.3ç§’é–“éš”ï¼‰
setInterval(() => { if(inBattle) playerAttack(); }, 300);
setInterval(() => { if(inBattle) enemyTurn(); }, 1000);

// ãŸãŸã‹ã†ãƒœã‚¿ãƒ³ï¼ˆé•·æŠ¼ã—å¯¾å¿œï¼‰
const atkBtn = document.getElementById("btnAttack");
let atkTimer;
const startAtk = (e) => { e.preventDefault(); playerAttack(); atkTimer = setInterval(playerAttack, 100); };
const endAtk = () => clearInterval(atkTimer);
atkBtn.addEventListener("mousedown", startAtk);
atkBtn.addEventListener("mouseup", endAtk);
atkBtn.addEventListener("touchstart", startAtk);
atkBtn.addEventListener("touchend", endAtk);

function dropItem() {
    const lv = Math.floor(floor/10)+1;
    const item = { id:Date.now(), name:`éšå±¤ã®å‰£+${lv}`, type:'w', atk:lv*10, def:0, hp:0 };
    inventory.push(item);
    addLog(`æ‹¾ï¼š${item.name}`, "#2ecc71");
}

function dropArtifact() {
    const art = { name: "å¤ã®å®ç‰", d: "å…¨èƒ½åŠ›+5%" };
    artifacts.push(art);
    addLog(`â˜…ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå…¥æ‰‹ï¼š${art.name}`, "#d4af37");
}

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='jobM'?'jobList':id==='skillM'?'sList':id==='statM'?'':'iList');
    if(!d) return;
    d.innerHTML = "";
    if(id==='jobM') Object.keys(JOBS).forEach(k => {
        d.innerHTML += `<div class="list-row"><b>${JOBS[k].n}</b><button onclick="changeJob('${k}')" ${hero.job===k?'disabled':''}>ãƒã‚§ãƒ³ã‚¸</button></div>`;
    });
    if(id==='skillM') {
        document.getElementById("curJobTitle").innerText = JOBS[hero.job].n;
        JOB_SKILLS[hero.job].forEach(s => {
            if(!skills[hero.job]) skills[hero.job] = {};
            const lv = skills[hero.job][s.id] || 0;
            d.innerHTML += `<div class="list-row"><div><b>[${s.type}] ${s.n} Lv.${lv}</b><br><small>${s.d}</small></div>
                <button onclick="buyS('${s.id}')" ${lv>=s.max||sp<1?'disabled':''}>å¼·åŒ–</button></div>`;
        });
    }
    if(id==='equipM') {
        inventory.forEach(i => {
            const isEq = Object.values(hero.eq).some(e => e && e.id === i.id);
            d.innerHTML += `<div class="list-row"><b>${i.name}</b><div><button onclick="eqI(${i.id})" ${isEq?'disabled':''}>è£…å‚™</button><button onclick="sellI(${i.id})">å»ƒæ£„</button></div></div>`;
        });
        const al = document.getElementById("aList"); al.innerHTML = "";
        artifacts.forEach(a => { al.innerHTML += `<div class="list-row"><b>${a.name}</b><small>${a.d}</small></div>`; });
    }
}

function changeJob(k) { hero.job = k; updateUI(); save(); openM('jobM'); addLog(`${JOBS[k].n}ã«å°±ã„ãŸã€‚`); }
function buyS(id) { if(sp>=1){ sp--; skills[hero.job][id] = (skills[hero.job][id]||0)+1; updateUI(); save(); openM('skillM'); } }
function eqI(id) { const i = inventory.find(x=>x.id===id); hero.eq[i.type]=i; updateUI(); save(); openM('equipM'); }
function sellI(id) { inventory = inventory.filter(x=>x.id!==id); Object.keys(hero.eq).forEach(k=>{if(hero.eq[k]&&hero.eq[k].id===id)hero.eq[k]=null;}); updateUI(); save(); openM('equipM'); }
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() { localStorage.setItem(SAVE_KEY, JSON.stringify({ hero, st, skills, inventory, artifacts, floor, sp, pp })); }
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) { const d = JSON.parse(s); hero=d.hero; st=d.st; skills=d.skills; inventory=d.inventory; artifacts=d.artifacts||[]; floor=d.floor; sp=d.sp; pp=d.pp; }
    hero.hp = hero.maxHp;
}
load(); updateUI(); nextBattle();
</script>
</body>
</html>
