<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Job Master & Infinite Tower v4.2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #222; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:6px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:2px; cursor:pointer; padding:8px; font-size:11px; transition: 0.1s; }
button:active { background: #444; }
button:disabled { opacity: 0.1; }

/* æ•µãƒ»éšå±¤æƒ…å ±ï¼ˆä¸­å¤®å¯„ã›ã§è¦‹ã‚„ã™ãï¼‰ */
.tower-info { text-align: center; background: #1a1a1a; border: 1px solid #333; padding: 6px; margin-bottom: 6px; }
.enemy-box { text-align: center; padding: 8px; border: 1px solid var(--border); background: #000; margin-bottom: 6px; }
.hp-bar { width: 100%; background:#200; height:10px; border:1px solid #400; margin-top:4px; position: relative; }
.hp-fill { background:#a00; height:100%; width:100%; transition: width 0.1s; }

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°UI */
.hero-detail { background:var(--panel); border:1px solid var(--accent); padding:10px; border-radius:4px; margin-bottom:6px; }
.hero-main { display: flex; justify-content: space-between; align-items: flex-start; }
.hero-job-tag { background: var(--accent); color: #000; padding: 2px 6px; font-size: 10px; font-weight: bold; border-radius: 2px; }

/* ãƒ­ã‚°ï¼ˆé©åº¦ãªé•·ã•ã«å»¶é•·ï¼‰ */
.log-area { flex: 1; background:#000; border:1px solid var(--border); overflow-y:auto; padding:6px; font-size:11px; line-height:1.4; display:flex; flex-direction:column-reverse; margin-bottom:6px; }

.btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; padding-bottom: 10px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:90%; padding:15px; overflow-y:auto; }
.row-item { border-bottom:1px solid #222; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
.item-desc { font-size: 10px; color: #888; }
</style>
</head>
<body>

<div class="tower-info">
    <b style="color:var(--accent)">Trial Tower - <span id="floor">1</span>F</b>
</div>

<div class="enemy-box">
    <div id="eName" style="font-size:14px; font-weight:bold; letter-spacing: 1px;">---</div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
    <div id="eHpNum" style="font-size:10px; margin-top:2px;">0 / 0</div>
</div>

<div class="hero-detail">
    <div class="hero-main">
        <div>
            <span class="hero-job-tag" id="hJobName">NOVICE</span><br>
            <b style="font-size:16px;">Lv.<span id="hLv">1</span></b> <span id="hHp" style="font-size:12px;">0/0</span>
        </div>
        <div style="text-align:right;">
            PP: <b id="hPp" style="color:#3498db">0</b> / SP: <b id="hSp" style="color:var(--accent)">0</b>
        </div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; font-size:11px; color:#aaa; border-top:1px solid #222; margin-top:6px; padding-top:4px;">
        <span>ATK: <b id="hAtk" style="color:#eee">0</b> <button onclick="addPP('atk')" id="btnAtk" style="padding:0 4px; visibility:hidden;">+</button></span>
        <span>DEF: <b id="hDef" style="color:#eee">0</b> <button onclick="addPP('def')" id="btnDef" style="padding:0 4px; visibility:hidden;">+</button></span>
        <span>CRIT: <b id="hCrit" style="color:#eee">0%</b></span>
        <span>MAX HP <button onclick="addPP('hp')" id="btnHp" style="padding:0 4px; visibility:hidden;">+</button></span>
    </div>
</div>

<div class="log-area" id="log"></div>

<div class="btn-grid">
    <button onclick="openM('jobM')">ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–</button>
    <button onclick="openM('skillM')">ğŸ“ ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ </button>
</div>

<div id="jobM" class="modal"><div class="modal-content"><h3>ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–ãƒã‚§ãƒ³ã‚¸</h3><div id="jobList"></div><br><button onclick="closeM('jobM')" style="width:100%">æˆ»ã‚‹</button></div></div>
<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ <span id="curJobTitle">ã‚¹ã‚­ãƒ«</span> å¼·åŒ–</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">æˆ»ã‚‹</button></div></div>
<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ </h3><div id="iList"></div><br><button onclick="closeM('equipM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<script>
const SAVE_KEY = "Slayer_v4.2.0";
let floor=1, sp=0, pp=0, inBattle=false;
let baseStats = { atk:10, def:10, hp:0 }; // PPã§æŒ¯ã£ãŸåˆ†
let hero = { lv:1, exp:0, hp:150, maxHp:150, job:'novice', eq:{w:null, a:null, r:null} };
let inventory = [], skills = {};

const JOBS = {
    novice: { n: "ãƒãƒ¼ãƒ“ã‚¹", d: "å…¨ã¦ã®å§‹ã¾ã‚Šã€‚", req: 0 },
    warrior: { n: "æˆ¦å£«", d: "ç‰©ç†æ”»æ’ƒã®å°‚é–€å®¶ã€‚", req: 5 },
    mage: { n: "é­”è¡“å¸«", d: "é«˜ã„ä¼šå¿ƒç‡ã‚’èª‡ã‚‹ã€‚", req: 5 },
    thief: { n: "ç›—è³Š", d: "çµŒé¨“å€¤ç¨¼ãã«ç‰¹åŒ–ã€‚", req: 8 },
    paladin: { n: "è–é¨å£«", d: "å®ˆå‚™ã¨ç”Ÿå­˜ã®æ¥µã¿ã€‚", req: 15 },
    assassin: { n: "æš—æ®ºè€…", d: "å¿…æ®ºã®ä¸€æ’ƒã‚’æ”¾ã¤ã€‚", req: 15 },
    berserker: { n: "ç‹‚æˆ¦å£«", d: "æ”»æ’ƒã“ããŒæœ€å¤§ã®é˜²å¾¡ã€‚", req: 20 }
};

const SKILL_DATA = {
    novice: [{ id:"n1", n:"åŸºç¤ä½“åŠ›", d:"æœ€å¤§HP+50", max:10, eff:{hp:50} }],
    warrior: [{ id:"w1", n:"è…•åŠ›å¼·åŒ–", d:"ATK+10", max:30, eff:{atk:10} }],
    mage: [{ id:"m1", n:"é›†ä¸­åŠ›", d:"CRIT+2%", max:15, eff:{crit:0.02} }],
    thief: [{ id:"t1", n:"æ¢æ±‚å¿ƒ", d:"EXP+10%", max:10, eff:{exp:0.1} }],
    paladin: [{ id:"p1", n:"ç¥è–ãªã‚‹ç›¾", d:"DEF+15", max:50, eff:{def:15} }],
    assassin: [{ id:"a1", n:"æ€¥æ‰€çªã", d:"CRIT+5%", max:20, eff:{crit:0.05} }],
    berserker: [{ id:"b1", n:"ç ´å£Šè¡å‹•", d:"ATK+25", max:50, eff:{atk:25} }]
};

function updateUI() {
    let sA=0, sD=0, sH=0, sCr=0, sE=0;
    Object.keys(skills).forEach(j => {
        Object.keys(skills[j]).forEach(sid => {
            const s = SKILL_DATA[j].find(x=>x.id===sid);
            const lv = skills[j][sid];
            if(s.eff.atk) sA += s.eff.atk * lv;
            if(s.eff.def) sD += s.eff.def * lv;
            if(s.eff.hp) sH += s.eff.hp * lv;
            if(s.eff.crit) sCr += s.eff.crit * lv;
            if(s.eff.exp) sE += s.eff.exp * lv;
        });
    });
    
    let eA=0, eD=0, eH=0;
    ['w','a','r'].forEach(t => { if(hero.eq[t]) { eA += hero.eq[t].atk; eD += hero.eq[t].def; eH += hero.eq[t].hp; } });

    hero.maxHp = 150 + baseStats.hp * 30 + sH + eH;
    hero.atk = baseStats.atk + sA + eA;
    hero.def = baseStats.def + sD + eD;
    hero.crit = sCr;
    hero.expBonus = sE;

    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hCrit").innerText = Math.round(hero.crit * 100) + "%";
    document.getElementById("hPp").innerText = pp;
    document.getElementById("hSp").innerText = sp;
    document.getElementById("floor").innerText = floor;
    document.getElementById("hJobName").innerText = JOBS[hero.job].n.toUpperCase();

    const vis = pp > 0 ? "visible" : "hidden";
    document.getElementById("btnAtk").style.visibility = vis;
    document.getElementById("btnDef").style.visibility = vis;
    document.getElementById("btnHp").style.visibility = vis;
}

function addPP(type) {
    if(pp <= 0) return;
    pp--;
    if(type==='atk') baseStats.atk += 3;
    if(type==='def') baseStats.def += 2;
    if(type==='hp') baseStats.hp += 1;
    updateUI(); save();
}

function addLog(msg, col="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    if(col) d.style.color = col;
    d.innerText = `> ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 30) l.removeChild(l.lastChild);
}

function nextBattle() {
    if(inBattle) return;
    const isBoss = (floor % 50 === 0);
    const p = Math.pow(1.07, floor-1) * (isBoss ? 4 : 1);
    const enemy = {
        name: isBoss ? `ã€BOSSã€‘${generateEName(true)}` : generateEName(false),
        hp: Math.floor((60 + floor * 15) * p),
        atk: Math.floor((5 + floor * 1.5) * p),
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    document.getElementById("eName").style.color = isBoss ? "#ff4757" : "#ccc";
    runBattle(enemy, isBoss);
}

function runBattle(e, isBoss) {
    inBattle = true;
    const it = setInterval(() => {
        let d = Math.max(1, hero.atk - (e.atk*0.05));
        if(Math.random() < hero.crit) { d *= 2.5; addLog("ä¼šå¿ƒã®ä¸€æ’ƒï¼", "#f1c40f"); }
        e.hp -= d;

        if(e.hp <= 0) {
            clearInterval(it);
            addLog(`${e.name} ã‚’è¨ä¼ã€‚`);
            hero.exp += (25 + floor) * (1 + hero.expBonus);
            if(hero.exp >= 100) { hero.lv++; hero.exp=0; sp++; pp++; addLog(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼PP+1 SP+1ã‚’ç²å¾—`, "#3498db"); }
            if(isBoss || Math.random() < 0.15) dropItem();
            floor++; inBattle = false; save(); updateUI();
            setTimeout(nextBattle, 400);
        } else {
            hero.hp -= Math.max(1, e.atk - hero.def);
            document.getElementById("eHpFill").style.width = (e.hp/e.maxHp*100) + "%";
            document.getElementById("eHpNum").innerText = `${Math.floor(e.hp)} / ${e.maxHp}`;
            updateUI();
            if(hero.hp <= 0) {
                clearInterval(it);
                addLog(`å‹‡è€…ã¯åŠ›å°½ããŸ...`, "#e74c3c");
                hero.hp = hero.maxHp; inBattle = false;
                setTimeout(nextBattle, 1200);
            }
        }
    }, 150);
}

function generateEName(boss) {
    const a = ["é‚ªæ‚ªãª", "æ·±æ·µã®", "å‘ªã‚ã‚ŒãŸ", "ç‹‚æ°—ã®", "å¤ä»£ã®"];
    const b = ["ã‚´ãƒ¼ãƒ¬ãƒ ", "ã‚­ãƒ¡ãƒ©", "ãƒ¯ã‚¤ãƒãƒ¼ãƒ³", "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", "ãƒ¬ã‚¤ã‚¹"];
    return a[Math.floor(Math.random()*a.length)] + b[Math.floor(Math.random()*b.length)] + (boss ? "ãƒ»ç‹" : "");
}

function dropItem() {
    const lv = Math.floor(floor/10) + 1;
    const types = [{t:'w',n:'å‰£',s:'ATK'}, {t:'a',n:'é§',s:'DEF'}, {t:'r',n:'æŒ‡è¼ª',s:'HP'}];
    const tt = types[Math.floor(Math.random()*3)];
    const item = { 
        id: Date.now(), type: tt.t, name: `éšå±¤ã®${tt.n}+${lv}`,
        atk: tt.t==='w'? lv*8 : 0, def: tt.t==='a'? lv*6 : 0, hp: tt.t==='r'? lv*100 : 0
    };
    inventory.push(item);
    addLog(`ã‚¢ã‚¤ãƒ†ãƒ å…¥æ‰‹: ${item.name}`, "#2ecc71");
}

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='jobM'?'jobList':id==='skillM'?'sList':'iList');
    d.innerHTML = "";
    if(id==='jobM') Object.keys(JOBS).forEach(k => {
        const j = JOBS[k]; const lock = hero.lv < j.req;
        d.innerHTML += `<div class="row-item"><div><b>${j.n}</b><br><span class="item-desc">${j.d} (Lv.${j.req})</span></div>
            <button onclick="changeJob('${k}')" ${lock || hero.job===k ?'disabled':''}>é¸æŠ</button></div>`;
    });
    if(id==='skillM') {
        document.getElementById("curJobTitle").innerText = JOBS[hero.job].n;
        SKILL_DATA[hero.job].forEach(s => {
            if(!skills[hero.job]) skills[hero.job] = {};
            const lv = skills[hero.job][s.id] || 0;
            d.innerHTML += `<div class="row-item"><div><b>${s.n} Lv.${lv}/${s.max}</b><br><span class="item-desc">${s.d}</span></div>
                <button onclick="buyS('${s.id}')" ${lv>=s.max||sp<1?'disabled':''}>å¼·åŒ–</button></div>`;
        });
    }
    if(id==='equipM') inventory.forEach(item => {
        const isEq = Object.values(hero.eq).some(e => e && e.id === item.id);
        const stats = item.atk?`ATK+${item.atk}`:item.def?`DEF+${item.def}`:`HP+${item.hp}`;
        d.innerHTML += `<div class="row-item"><div><b>${item.name}</b><br><span class="item-desc">æ€§èƒ½: ${stats}</span></div>
            <div><button onclick="equipI(${item.id})" ${isEq?'disabled':''}>${isEq?'è£…å‚™ä¸­':'è£…å‚™'}</button>
            <button onclick="sellI(${item.id})">å£²å´</button></div></div>`;
    });
}

function changeJob(k) { hero.job = k; updateUI(); save(); openM('jobM'); addLog(`${JOBS[k].n}ã«è»¢è·ï¼`); }
function buyS(id) { if(sp>=1){ sp--; skills[hero.job][id] = (skills[hero.job][id]||0)+1; updateUI(); save(); openM('skillM'); } }
function equipI(id) { const i = inventory.find(x=>x.id===id); hero.eq[i.type]=i; updateUI(); save(); openM('equipM'); }
function sellI(id) { inventory = inventory.filter(x=>x.id!==id); Object.keys(hero.eq).forEach(k=>{if(hero.eq[k]&&hero.eq[k].id===id)hero.eq[k]=null;}); updateUI(); save(); openM('equipM'); }
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() { localStorage.setItem(SAVE_KEY, JSON.stringify({ hero, skills, inventory, floor, sp, pp, baseStats })); }
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) { const d = JSON.parse(s); hero=d.hero; skills=d.skills; inventory=d.inventory; floor=d.floor; sp=d.sp; pp=d.pp||0; baseStats=d.baseStats||baseStats; }
    hero.hp = hero.maxHp;
}
load(); updateUI(); nextBattle();
</script>
</body>
</html>
