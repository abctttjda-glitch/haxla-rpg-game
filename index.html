<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Job Master Tower v4.9.1 [Fix & Polish]</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:8px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:4px; cursor:pointer; padding:8px; font-size:11px; }

/* æŠ¼ã—ãŸã‚‰ã‚ã‹ã‚‹ãƒœã‚¿ãƒ³ã®è‰²å¤‰åŒ– */
.auto-on-green { background: #008000 !important; color: #fff !important; border: 1px solid #0f0 !important; font-weight: bold; box-shadow: 0 0 5px #0f0; }
.active-battle-on { background: #b38f00 !important; color: #000 !important; font-weight: bold; }

.hero-status-panel { background:var(--panel); border:1px solid var(--accent); padding:10px; border-radius:4px; margin-bottom:6px; display:grid; grid-template-columns: 1fr 1.5fr; gap:10px; }
.exp-bar { width: 100%; background: #222; height: 5px; margin-top: 4px; overflow: hidden; }
.exp-fill { background: #3498db; height: 100%; width: 0%; transition: width 0.3s; }

.enemy-box { text-align: center; padding: 10px; border: 1px solid var(--border); background: #000; margin-bottom: 6px; min-height: 80px; }
.hp-bar { width: 100%; background:#200; height:12px; border:1px solid #400; margin-top:4px; overflow: hidden; }
.hp-fill { background:linear-gradient(90deg, #900, #f00); height:100%; width:100%; }

.log-area { flex: 1; background:#000; border:1px solid var(--border); overflow-y:auto; padding:8px; font-size:11px; line-height:1.3; display:flex; flex-direction:column-reverse; margin-bottom:6px; }
.battle-actions { display: flex; gap: 4px; margin-bottom: 8px; }
#btnAttack { flex: 2; height: 45px; background: #400; font-weight: bold; border: 1px solid #822; }

.btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.98); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:92%; padding:15px; overflow-y:auto; }
.st-row { background: #1a1a1a; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #333; }
.list-row { border-bottom:1px solid #222; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>

<div class="hero-status-panel">
    <div>
        <small id="jobLabel" style="color:var(--accent); font-weight:bold;">---</small><br>
        <b style="font-size:16px;">Lv.<span id="hLv">1</span></b>
        <div class="exp-bar"><div id="expFill" class="exp-fill"></div></div>
    </div>
    <div style="font-size:11px;">
        HP : <b id="hHp">0/0</b><br>
        æ”»æ’ƒ: <b id="hAtk">0</b> / é˜²å¾¡: <b id="hDef">0</b><br>
        PP : <b id="hPp" style="color:#3498db">0</b> / SP: <b id="hSp" style="color:var(--accent)">0</b>
    </div>
</div>

<div class="enemy-box">
    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
        <button onclick="changeFloor(-1)">â—€æˆ»ã‚‹</button>
        <b id="eName">æ•µã‚’ç´¢æ•µä¸­...</b>
        <button onclick="changeFloor(1)">é€²ã‚€â–¶</button>
    </div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
    <div id="eHpNum" style="font-size:10px; margin-top:2px;">0 / 0</div>
</div>

<div class="log-area" id="log"></div>

<div class="battle-actions">
    <button id="btnAttack" onclick="pAtk()">æ”»æ’ƒ</button>
    <button id="btnAuto" onclick="toggleAuto()">è‡ªå‹•æˆ¦é—˜: OFF</button>
</div>

<div class="btn-grid">
    <button onclick="openM('statM')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
    <button onclick="openM('jobM')">ã‚¸ãƒ§ãƒ–</button>
    <button onclick="openM('skillM')">ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">ã‚¢ã‚¤ãƒ†ãƒ </button>
</div>

<div id="statM" class="modal"><div class="modal-content">
    <h3>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¼·åŒ–</h3>
    <div class="st-row">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b>æ”»æ’ƒåŠ›</b> 
            <button id="auto_atk" onclick="toggleAutoTarget('atk')">è‡ªå‹•æŒ¯ã‚Š:OFF</button>
        </div>
        <div style="margin-top:5px;"><button onclick="modST('atk',1)">+1</button><button onclick="modST('atk',10)">+10</button><button onclick="modST('atk',100)">+100</button></div>
    </div>
    <div class="st-row">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b>é˜²å¾¡åŠ›</b> 
            <button id="auto_def" onclick="toggleAutoTarget('def')">è‡ªå‹•æŒ¯ã‚Š:OFF</button>
        </div>
        <div style="margin-top:5px;"><button onclick="modST('def',1)">+1</button><button onclick="modST('def',10)">+10</button><button onclick="modST('def',100)">+100</button></div>
    </div>
    <div class="st-row">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b>æœ€å¤§HP</b> 
            <button id="auto_hp" onclick="toggleAutoTarget('hp')">è‡ªå‹•æŒ¯ã‚Š:OFF</button>
        </div>
        <div style="margin-top:5px;"><button onclick="modST('hp',1)">+1</button><button onclick="modST('hp',10)">+10</button><button onclick="modST('hp',100)">+100</button></div>
    </div>
    <button onclick="resetPP()" style="color:#ff4d4d; width:100%; border-color:#500; margin-bottom:10px;">PPã‚’å…¨å›å(æŒ¯ã‚Šç›´ã—)</button>
    <button onclick="closeM('statM')" style="width:100%; height:40px;">é–‰ã˜ã‚‹</button>
</div></div>

<div id="jobM" class="modal"><div class="modal-content"><h3>ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–ãƒã‚§ãƒ³ã‚¸</h3><div id="jobList"></div><br><button onclick="closeM('jobM')">æˆ»ã‚‹</button></div></div>
<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ <span id="curJobTitle"></span> ã‚¹ã‚­ãƒ«</h3><div id="sList"></div><br><button onclick="closeM('skillM')">æˆ»ã‚‹</button></div></div>
<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ </h3><div id="iList"></div><br><button onclick="closeM('equipM')">æˆ»ã‚‹</button></div></div>

<script>
const SAVE_KEY = "JOB_MASTER_ULTIMATE_SAVE";
let floor=1, maxFloor=1, sp=0, pp=0, autoBattle=false;
let autoTargets = { atk:false, def:false, hp:false };
let st = { hp:20, atk:10, def:10 }; 
let hero = { lv:1, exp:0, job:'warrior', hp:200, eq:{w:null, a:null} };
let inventory = [], skills = {};
let enemy = null;

const JOB_INFO = {
    warrior: { n:"æˆ¦å£«", s:[{n:"ãªãæ‰•ã„", d:"ATKç‰¹åŒ–", w:[5,1,10]}, {n:"ç›¾å—ã‘", d:"DEFç‰¹åŒ–", w:[1,5,20]}, {n:"å¥®èµ·", d:"å‡ç­‰å¼·åŒ–", w:[3,3,30]}, {n:"æ¨ã¦èº«", d:"æ”»æ’ƒæ¥µæŒ¯ã‚Š", w:[8,0,5]}, {n:"é‹¼ã®è‚‰ä½“", d:"HPå¤§å¹…å¢—", w:[1,2,100]}, {n:"å…œå‰²ã‚Š", d:"æ”»æ’ƒå¼·åŒ–", w:[6,1,10]}, {n:"é›„å«ã³", d:"æ”»/HPå¼·åŒ–", w:[4,1,40]}, {n:"é€£æ’ƒ", d:"æ”»æ’ƒå¼·åŒ–", w:[5,2,10]}, {n:"ä¸å±ˆã®é—˜å¿—", d:"é˜²/HPå¼·åŒ–", w:[2,4,60]}, {n:"ç©¶æ¥µæ–¬", d:"æ”»æ’ƒæ¥µé™", w:[10,1,10]}] },
    mage: { n:"é­”è¡“å¸«", s:[{n:"ç«çƒ", d:"æ”»æ’ƒå¼·åŒ–", w:[6,1,5]}, {n:"é­”åŠ›è²¯ã‚", d:"æ”»æ’ƒå¼·åŒ–", w:[5,1,10]}, {n:"æ°·çµ", d:"é˜²å¾¡å¼·åŒ–", w:[2,5,15]}, {n:"é­”è¡“éšœå£", d:"é˜²å¾¡å¼·åŒ–", w:[1,6,20]}, {n:"äºŒé‡è© å”±", d:"æ”»æ’ƒå¼·åŒ–", w:[7,1,5]}, {n:"é›·é³´", d:"æ”»æ’ƒå¼·åŒ–", w:[8,1,5]}, {n:"çŸ¥æµã®æ³‰", d:"é˜²/HPå¼·åŒ–", w:[2,3,50]}, {n:"å¸é­”", d:"HPå¼·åŒ–", w:[3,2,60]}, {n:"æ™‚ç©ºæ­ªæ›²", d:"é˜²å¾¡å¼·åŒ–", w:[1,8,10]}, {n:"ç¦å‘ª", d:"æ”»æ’ƒç‰¹åŒ–", w:[12,0,5]}] }
};

function save() { localStorage.setItem(SAVE_KEY, JSON.stringify({ hero, st, skills, inventory, floor, maxFloor, sp, pp, autoTargets })); }

function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if (saved) {
        const d = JSON.parse(saved);
        hero = {...hero, ...d.hero};
        st = {...st, ...d.st};
        skills = d.skills || {};
        inventory = d.inventory || [];
        floor = d.floor || 1;
        maxFloor = d.maxFloor || 1;
        sp = d.sp || 0;
        pp = d.pp || 0;
        autoTargets = d.autoTargets || { atk:false, def:false, hp:false };
    }
}

function updateUI() {
    let sA=0, sD=0, sH=0;
    Object.keys(skills).forEach(jKey => {
        const info = JOB_INFO[jKey]; if(!info) return;
        Object.keys(skills[jKey]).forEach(sIdx => {
            const lv = skills[jKey][sIdx]; const w = info.s[sIdx].w;
            sA += lv * w[0]; sD += lv * w[1]; sH += lv * w[2];
        });
    });
    let eA = hero.eq.w ? hero.eq.w.atk : 0;
    let eD = hero.eq.a ? hero.eq.a.def : 0;
    hero.maxHp = (st.hp * 10) + sH;
    if(hero.hp === undefined || hero.hp > hero.maxHp) hero.hp = hero.maxHp;
    hero.atk = st.atk + sA + eA;
    hero.def = st.def + sD + eD;
    
    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hPp").innerText = pp;
    document.getElementById("hSp").innerText = sp;
    const nxt = hero.lv * 50;
    document.getElementById("expFill").style.width = (hero.exp / nxt * 100) + "%";
    document.getElementById("jobLabel").innerText = JOB_INFO[hero.job]?.n || "å†’é™ºè€…";

    // è‡ªå‹•ã‚¹ãƒ†æŒ¯ã‚Šãƒœã‚¿ãƒ³ã®è‰²å¤‰æ›´
    ["atk","def","hp"].forEach(t => {
        const b = document.getElementById("auto_"+t);
        if(b){
            if(autoTargets[t]) { b.classList.add("auto-on-green"); b.innerText = "è‡ªå‹•æŒ¯ã‚Š:ON"; }
            else { b.classList.remove("auto-on-green"); b.innerText = "è‡ªå‹•æŒ¯ã‚Š:OFF"; }
        }
    });
    
    // è‡ªå‹•æˆ¦é—˜ãƒœã‚¿ãƒ³ã®è‰²å¤‰æ›´
    const ab = document.getElementById("btnAuto");
    if(autoBattle) { ab.classList.add("active-battle-on"); ab.innerText = "è‡ªå‹•æˆ¦é—˜: ON"; }
    else { ab.classList.remove("active-battle-on"); ab.innerText = "è‡ªå‹•æˆ¦é—˜: OFF"; }
}

function modST(k, v) { let a = Math.min(v, pp); if(a > 0){ st[k] += a; pp -= a; } updateUI(); save(); }
function resetPP() { pp += (st.hp - 20) + (st.atk - 10) + (st.def - 10); st = { hp:20, atk:10, def:10 }; updateUI(); save(); }
function toggleAutoTarget(type) { autoTargets[type] = !autoTargets[type]; updateUI(); save(); }
function toggleAuto() { autoBattle = !autoBattle; updateUI(); }

function nextBattle() {
    const isB = (floor % 50 === 0);
    const m = Math.pow(1.04, floor-1) * (isB ? 3.5 : 1);
    enemy = {
        name: (isB?"ã€BOSSã€‘":"") + floor + "éšã®é­”ç‰©",
        hp: Math.floor((100 + floor*20) * m),
        atk: Math.floor((8 + floor*1.8) * m),
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    updateE();
}

function updateE() {
    if(!enemy) return;
    document.getElementById("eHpFill").style.width = (enemy.hp/enemy.maxHp*100) + "%";
    document.getElementById("eHpNum").innerText = `${Math.floor(enemy.hp)} / ${enemy.maxHp}`;
}

function pAtk() {
    if(!enemy) { nextBattle(); return; }
    enemy.hp -= Math.max(1, hero.atk - enemy.atk*0.05);
    updateE();
    if(enemy.hp <= 0) {
        const xp = 20 + floor;
        addLog(`${enemy.name}ã‚’è¨ä¼ã€‚ ${xp}EXPç²å¾—`, "#2ecc71");
        hero.exp += xp;
        if(hero.exp >= hero.lv * 50) {
            hero.lv++; hero.exp=0; pp += 5; sp += 1;
            addLog(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ PP+5 SP+1`, "#3498db");
            let ts = Object.keys(autoTargets).filter(k => autoTargets[k]);
            if(ts.length > 0) { let p = Math.floor(pp / ts.length); ts.forEach(t => { st[t] += p; pp -= p; }); }
        }
        if(Math.random() < 0.2 || floor % 50 === 0) drop();
        if(floor === maxFloor) maxFloor++;
        floor++; save(); updateUI(); nextBattle();
    }
}

function drop() {
    const isW = Math.random() > 0.5;
    const l = Math.floor(floor/5) + 1;
    const i = { id:Date.now(), n:`[ãƒ¬ã‚¢] `+(isW?"æ­¦å™¨":"é˜²å…·")+`+${l}`, type:isW?'w':'a', atk:isW?l*20:0, def:isW?0:l*15 };
    inventory.push(i);
    addLog(`å…¥æ‰‹ï¼š${i.n}`, "#d4af37");
}

function addLog(msg, col="") {
    const l = document.getElementById("log");
    const d = document.createElement("div"); if(col) d.style.color = col;
    d.innerText = `> ${msg}`; l.prepend(d);
    if(l.childNodes.length > 20) l.removeChild(l.lastChild);
}

setInterval(() => { if(autoBattle) pAtk(); }, 120);
setInterval(() => { if(enemy) {
    hero.hp -= Math.max(1, enemy.atk - hero.def);
    updateUI();
    if(hero.hp <= 0) { hero.hp = hero.maxHp; floor = Math.max(1, floor-1); nextBattle(); addLog("æ•—é€€...éšå±¤ã‚’ä¸‹ã’ã‚‹ã€‚","#e74c3c"); }
}}, 1000);

function changeFloor(v) { let n = floor + v; if(n >= 1 && n <= maxFloor){ floor = n; nextBattle(); } }
function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='jobM'?'jobList':id==='skillM'?'sList':'iList');
    if(!d) return; d.innerHTML = "";
    if(id==='jobM') Object.keys(JOB_INFO).forEach(k => {
        d.innerHTML += `<div class="list-row"><b>${JOB_INFO[k].n}</b> <button onclick="changeJob('${k}')" ${hero.job===k?'disabled':''}>è»¢è·</button></div>`;
    });
    if(id==='skillM') {
        const j = JOB_INFO[hero.job]; if(!j) return;
        document.getElementById("curJobTitle").innerText = j.n;
        j.s.forEach((sObj, i) => {
            const lv = (skills[hero.job]||{})[i]||0;
            d.innerHTML += `<div class="list-row"><div><b>${sObj.n} (Lv.${lv})</b><br><small style="color:#888;">${sObj.d}</small></div> <button onclick="buyS(${i})">å¼·åŒ–</button></div>`;
        });
    }
    if(id==='equipM') inventory.forEach(i => {
        const isEq = hero.eq.w?.id === i.id || hero.eq.a?.id === i.id;
        d.innerHTML += `<div class="list-row"><div><b>${i.n}</b><br><small>${i.atk?`æ”»+${i.atk}`:`é˜²+${i.def}`}</small></div> <button onclick="eqI(${i.id})" ${isEq?'disabled':''}>è£…å‚™</button></div>`;
    });
}
function changeJob(k) { hero.job = k; updateUI(); save(); openM('jobM'); }
function buyS(idx) { if(sp>=1){ sp--; if(!skills[hero.job]) skills[hero.job]={}; skills[hero.job][idx]=(skills[hero.job][idx]||0)+1; updateUI(); save(); openM('skillM'); } }
function eqI(id) { const i = inventory.find(x=>x.id===id); hero.eq[i.type]=i; updateUI(); save(); openM('equipM'); }
function closeM(id) { document.getElementById(id).style.display = "none"; }

// èµ·å‹•å‡¦ç†
window.onload = () => { load(); updateUI(); nextBattle(); };
</script>
</body>
</html>
