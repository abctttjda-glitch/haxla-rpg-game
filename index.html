<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v3.1.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --main-bg: #111; --panel-bg: #1e1e1e; --accent: #f1c40f; --text: #eee; --btn-bg: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:12px; padding:4px; height: 100dvh; overflow:hidden; display:flex; flex-direction:column; }
.panel { background:var(--panel-bg); border:1px solid #444; border-radius:6px; padding:4px; margin-bottom:4px; }
button { background:var(--btn-bg); color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; font-weight:bold; }
button:active { opacity: 0.7; }
.active { background:var(--accent) !important; color:#000 !important; }
.toggleOn { background:#2ecc71 !important; color:#000 !important; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header { display: grid; grid-template-columns: 1fr 1.2fr; gap: 4px; height: 46px; }
.top-right { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }

/* æ•µHP */
.enemy-box { display: flex; align-items: center; gap: 5px; height: 22px; margin-bottom: 4px; }
.hp-bar-outer { flex-grow: 1; background:#333; height:12px; border-radius:6px; overflow:hidden; position:relative; border:1px solid #555; }
.hp-bar-inner { background:#e74c3c; height:100%; width:0%; transition: width 0.1s; }
.hp-text { position:absolute; width:100%; text-align:center; font-size:9px; top:0; line-height:10px; font-weight:bold; }

/* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒƒãƒ‰ã‚¹ãƒšãƒ¼ã‚¹æ’²æ»…ç‰ˆï¼‰ */
.main-content { display: flex; flex: 1; min-height: 0; gap: 4px; margin-bottom: 4px; }
.left-col { flex: 1.2; display: flex; flex-direction: column; gap: 2px; overflow-y: auto; }
.log { flex: 1; background:#000; padding:4px; overflow-y:auto; display:flex; flex-direction:column-reverse; font-size: 10px; border-radius: 4px; border: 1px solid #333; line-height: 1.3; }

.char-card { border: 1px solid #333; border-radius: 4px; padding: 6px 4px; margin-bottom: 2px; background: rgba(255,255,255,0.03); }
.char-head { display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; margin-bottom: 2px; }

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.footer { height: 50px; display: grid; grid-template-columns: 1fr 2fr; gap: 4px; }
.footer button { font-size: 16px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#2c3e50; border:2px solid #555; border-radius:10px; width:90%; max-width:320px; padding:15px; }

.up-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }
.area-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
.area-btn { padding: 15px; font-size: 14px; }
</style>
</head>
<body>

<div class="header">
    <div class="panel" onclick="openPetInfo()">
        <strong><span id="floor">1</span>F</strong> <small>(<span id="holy">0</span>Pt)</small>
        <div style="font-size:9px; color:#a29bfe;">ğŸ¾Lv<span id="petLv">1</span> ğŸš©<span id="killCount">0/10</span></div>
    </div>
    <div class="top-right">
        <button onclick="openModal('upgradeModal')">âœ¨å¼·åŒ–</button>
        <button onclick="openModal('gachaModal')">ğŸã‚¬ãƒãƒ£</button>
        <button onclick="openModal('areaModal')" style="grid-column: span 2; font-size:11px; background:#4a69bd;">ğŸš©éšå±¤ç§»å‹•</button>
    </div>
</div>

<div class="panel enemy-box">
    <div id="enemyName" style="font-size:10px; min-width:70px; font-weight:bold;">---</div>
    <div class="hp-bar-outer">
        <div id="enemyHpBar" class="hp-bar-inner"></div>
        <div id="enemyHpNum" class="hp-text">0/0</div>
    </div>
</div>

<div class="main-content">
    <div class="left-col" id="partyList"></div>
    <div class="log" id="log"></div>
</div>

<div class="footer">
    <button onclick="stepDungeon()">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<div id="areaModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0; text-align:center;">ğŸš© ã‚¨ãƒªã‚¢é¸æŠ</h3>
        <p style="font-size:10px; color:#ccc; text-align:center;">è¸ç ´æ¸ˆã¿ã®éšå±¤ã¸ç§»å‹•ã§ãã¾ã™</p>
        <div class="area-grid" id="areaGrid"></div>
        <button onclick="closeModal('areaModal')" style="width:100%; margin-top:15px; background:#444; padding:10px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="charModal" class="modal"><div class="modal-content" id="m-content"></div></div>
<div id="petModal" class="modal"><div class="modal-content" id="pet-content"></div></div>
<div id="upgradeModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0; text-align:center;">âœ¨ è–æ¯ã®åŠ è­· (Pt:<span id="holy2">0</span>)</h3>
        <div id="upgradeRows"></div>
        <button id="autoUpBtn" style="width:100%; padding:10px; margin-top:5px;" onclick="toggleAutoUpgrade()">è‡ªå‹•å¼·åŒ–: OFF</button>
        <button onclick="closeModal('upgradeModal')" style="width:100%; margin-top:10px; background:#444;">é–‰ã˜ã‚‹</button>
    </div>
</div>
<div id="gachaModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 style="margin:0; color:var(--accent);">ğŸ è–æ¯ã‚¬ãƒãƒ£ ğŸ</h3>
        <div style="background:#1a1a1a; padding:15px; border-radius:8px; margin:10px 0; border:1px gold solid;">
            <div id="gachaItem" style="font-size:20px; min-height:30px;">ï¼Ÿ</div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <button onclick="playGacha(1)" style="padding:12px 0;">1é€£ (1Pt)</button>
            <button onclick="playGacha(10)" style="padding:12px 0; background:#8e44ad;">10é€£ (10Pt)</button>
        </div>
        <button onclick="closeModal('gachaModal')" style="width:100%; margin-top:10px; background:#444;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
const SAVE_KEY = "HolyRPG_LayoutFix_v3.1";
let floor=1, maxReachedFloor=1, kills=0, totalKills=0, holy=0, petLv=1;
let bonus={atk:0, def:0, hp:0, exp:0}, autoIsOn=false, autoUpgrade=false;
let party=[], enemy=null;

const JOB_DATA = {
    "ã›ã‚“ã—": {h:200, a:18, d:18, s:[{lv:1,n:"å¼·æ’ƒ"},{lv:10,n:"å…œå‰²ã‚Š"},{lv:25,n:"ä¸å±ˆã®å’†å“®"}]},
    "ã¨ã†ãã": {h:130, a:16, d:12, s:[{lv:1,n:"æ€¥æ‰€çªã"},{lv:10,n:"æ¯’åˆƒ"},{lv:25,n:"ç¥é€Ÿã®ç›—ã¿"}]},
    "ã¾ã»ã†ã¤ã‹ã„": {h:110, a:32, d:8, s:[{lv:1,n:"ç«ç‚çƒ"},{lv:10,n:"é›·æ’ƒ"},{lv:25,n:"ãƒ¡ãƒ†ã‚ª"}]},
    "ãã†ã‚Šã‚‡": {h:150, a:14, d:14, s:[{lv:1,n:"ãƒ’ãƒ¼ãƒ«"},{lv:10,n:"è–ãªã‚‹å£"},{lv:25,n:"ç¥ã®ç¦éŸ³"}]},
    "å‹‡è€…": {h:400, a:60, d:40, s:[{lv:1,n:"è¦‡ç‹æ–¬"},{lv:20,n:"å¤©ç½°"},{lv:50,n:"çµ‚ç„‰ã®å…‰"}]}
};

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.alive=true;
        this.weapon={val:0}; this.armor={val:0};
    }
    updateStats() {
        const j = JOB_DATA[this.job];
        const growth = 1 + (this.level - 1) * 0.07; 
        this.maxHp = Math.floor((j.h + bonus.hp + (this.level-1)*30) * growth);
        this.atk = Math.floor((j.a + bonus.atk + (this.level-1)*5 + this.weapon.val) * growth);
        this.def = Math.floor((j.d + bonus.def + (this.level-1)*4 + this.armor.val) * growth);
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function updateUI() {
    document.getElementById("floor").innerText = floor;
    document.getElementById("holy").innerText = holy;
    document.getElementById("holy2").innerText = holy;
    document.getElementById("killCount").innerText = `${kills%10}/10`;
    document.getElementById("petLv").innerText = petLv;

    const pList = document.getElementById("partyList");
    pList.innerHTML = "";
    party.forEach((c, i) => {
        c.updateStats();
        const div = document.createElement("div");
        div.className = "char-card";
        div.onclick = () => showCharDetail(i);
        div.innerHTML = `
            <div class="char-head"><span>${c.icon}${c.name} Lv${c.level}</span><span>HP:${Math.floor(c.hp)}</span></div>
            <div style="font-size:9px; color:#aaa;">${c.job} | âš”ï¸${c.weapon.val} ğŸ›¡ï¸${c.armor.val}</div>
        `;
        pList.appendChild(div);
    });

    const upRows = document.getElementById("upgradeRows");
    upRows.innerHTML = "";
    [{k:'atk',n:'æ”»æ’ƒ'},{k:'def',n:'é˜²å¾¡'},{k:'hp',n:'HP'},{k:'exp',n:'çµŒé¨“'}].forEach(s => {
        const row = document.createElement("div");
        row.className = "up-row";
        row.innerHTML = `<span>${s.n}: ${bonus[s.k]}</span>
            <div style="display:flex; gap:4px;">
                <button style="width:30px;" onclick="changeBonus('${s.k}',-1)">-</button>
                <button style="width:30px;" onclick="changeBonus('${s.k}',1)">+</button>
                <button style="width:40px;" onclick="changeBonus('${s.k}',10)">+10</button>
            </div>`;
        upRows.appendChild(row);
    });
    
    // éšå±¤é¸æŠãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
    const areaGrid = document.getElementById("areaGrid");
    areaGrid.innerHTML = "";
    for(let i=1; i<=maxReachedFloor; i+=50) {
        const btn = document.createElement("button");
        btn.className = "area-btn";
        btn.innerText = i + "F";
        btn.onclick = () => jumpTo(i);
        areaGrid.appendChild(btn);
    }
    // ç¾åœ¨ã®æœ€å¤§éšå±¤ã‚‚è¿½åŠ 
    if(maxReachedFloor % 50 !== 1) {
        const mBtn = document.createElement("button");
        mBtn.className = "area-btn";
        mBtn.innerText = maxReachedFloor + "F";
        mBtn.onclick = () => jumpTo(maxReachedFloor);
        areaGrid.appendChild(mBtn);
    }

    document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : "";
}

function jumpTo(f) { floor = f; closeModal('areaModal'); addLog(`ğŸš© ${f}Fã¸ç§»å‹•ã—ã¾ã—ãŸ`); updateUI(); }
function changeBonus(key, val) {
    if(val > 0) { const cost = Math.min(val, holy); bonus[key] += cost; holy -= cost; }
    else { const back = Math.min(Math.abs(val), bonus[key]); bonus[key] -= back; holy += back; }
    updateUI(); save();
}

function playGacha(times) {
    if(holy < times) return;
    holy -= times;
    for(let i=0; i<times; i++) {
        const r = Math.random();
        const target = party[Math.floor(Math.random()*party.length)];
        if(r < 0.45) target.weapon.val += 5;
        else if(r < 0.9) target.armor.val += 5;
        else target.level += 1;
    }
    document.getElementById("gachaItem").innerText = times + "å›ã‚¬ãƒãƒ£å®Œäº†ï¼";
    updateUI(); save();
}

function showCharDetail(idx) {
    const c = party[idx];
    const skills = JOB_DATA[c.job].s.filter(s => c.level >= s.lv);
    document.getElementById("m-content").innerHTML = `<h3>${c.icon}${c.name}</h3><p>${c.job} Lv${c.level}</p><strong>ã‚¹ã‚­ãƒ«:</strong><div style="font-size:11px; color:var(--accent);">${skills.map(s=>"ãƒ»"+s.n).join("<br>")}</div><button onclick="closeModal('charModal')" style="width:100%; margin-top:10px; padding:10px;">é–‰ã˜ã‚‹</button>`;
    openModal("charModal");
}

function addLog(t, color="#eee") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    line.style.color = color; line.innerText = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 40) lb.removeChild(lb.firstChild);
}

function stepDungeon() {
    if(enemy) return;
    const mons = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚³ãƒœãƒ«ãƒˆ","ã‚ªãƒ¼ã‚¯","é§æ­¦è€…","åœ°é¾"];
    const name = (floor%10===0?"BOSS ":"") + mons[Math.min(4, Math.floor(floor/25))];
    const pow = Math.pow(1.07, Math.floor(floor/5));
    enemy = { name: name, maxHp:(200+floor*60)*pow, hp:0, atk:(10+floor*6)*pow, def:(5+floor*4)*pow };
    enemy.hp = enemy.maxHp;
    battleLoop();
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            let dmg = Math.max(1, c.atk - enemy.def);
            if(Math.random() < 0.2) {
                const s = JOB_DATA[c.job].s.filter(sk => c.level >= sk.lv).pop();
                if(s) { 
                    if(c.job === "ãã†ã‚Šã‚‡") { c.hp = Math.min(c.maxHp, c.hp + c.atk); addLog(`ğŸ•Šï¸${s.n}`); }
                    else { dmg *= 2; addLog(`${c.icon}${s.n}!`, "#3498db"); }
                }
            }
            enemy.hp -= dmg;
            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); kills++; totalKills++;
                if(kills % 10 === 0) { holy++; if(autoUpgrade) changeBonus('atk', 1); }
                if(totalKills % 50 === 0) petLv++;
                party.forEach(char => { char.exp += 35; if(char.exp>=100){ char.level++; char.exp=0; char.hp=char.maxHp; } });
                floor++; if(floor>maxReachedFloor) maxReachedFloor=floor;
                enemy=null; save(); if(autoIsOn) setTimeout(stepDungeon, 50);
                updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t){ clearInterval(it); floor=Math.max(1, floor-3); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0) t.alive=false;
        }
        document.getElementById("enemyName").innerText = enemy ? enemy.name : "---";
        document.getElementById("enemyHpNum").innerText = enemy ? `${Math.floor(enemy.hp)}` : "0";
        document.getElementById("enemyHpBar").style.width = enemy ? (enemy.hp/enemy.maxHp*100)+"%" : "0%";
        updateUI();
    }, 70);
}

function openModal(id) { document.getElementById(id).style.display = "flex"; if(id==='areaModal') updateUI(); }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; updateUI(); }

function save() {
    const data = { floor, maxReachedFloor, holy, bonus, petLv, totalKills, autoUpgrade, party: party.map(c => ({
        name:c.name, job:c.job, icon:c.icon, level:c.level, hp:c.hp, weapon:c.weapon, armor:c.armor
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}
function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        try {
            const d = JSON.parse(saved);
            floor=d.floor||1; maxReachedFloor=d.maxReachedFloor||1; holy=d.holy||0; bonus=d.bonus||{atk:0,def:0,hp:0,exp:0}; 
            petLv=d.petLv||1; totalKills=d.totalKills||0; autoUpgrade=d.autoUpgrade||false;
            party = d.party.map(p => { 
                let c=new Character(p.name, p.job, p.icon); c.level=p.level; c.hp=p.hp; 
                c.weapon=p.weapon||{val:0}; c.armor=p.armor||{val:0}; return c; 
            });
        } catch(e) { initParty(); }
    } else { initParty(); }
}
function initParty() {
    party = [new Character("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Character("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Character("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Character("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
}
load(); updateUI();
</script>
</body>
</html>
