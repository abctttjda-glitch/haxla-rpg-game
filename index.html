<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Job & Tower v4.1.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #222; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:6px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:2px; cursor:pointer; padding:8px; font-size:11px; }
button:disabled { opacity: 0.1; }

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è©³ç´°UIï¼ˆå¼·åŒ–ï¼‰ */
.hero-detail { background:var(--panel); border:1px solid var(--accent); padding:10px; border-radius:4px; margin-bottom:6px; }
.hero-main { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
.hero-job-tag { background: var(--accent); color: #000; padding: 2px 6px; font-size: 10px; font-weight: bold; border-radius: 2px; }

/* æ•µãƒ»éšå±¤æƒ…å ± */
.tower-info { text-align: center; background: #1a1a1a; border: 1px solid #333; padding: 4px; margin-bottom: 6px; }
.enemy-box { padding: 4px; border-bottom: 1px solid #222; }
.hp-bar { width: 100%; background:#200; height:8px; border:1px solid #400; margin-top:2px; }
.hp-fill { background:#a00; height:100%; width:100%; transition: width 0.1s; }

/* ãƒ­ã‚°ï¼ˆçŸ­ç¸®ï¼‰ */
.log-mini { height: 80px; background:#000; border:1px solid var(--border); overflow-y:auto; padding:4px; font-size:10px; line-height:1.2; display:flex; flex-direction:column-reverse; }

.btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: auto; padding-bottom: 10px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:90%; padding:15px; overflow-y:auto; }
.tree-node { border-bottom:1px solid #222; padding:8px 0; display:flex; justify-content:space-between; align-items:center; }
.job-card { border:1px solid #444; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>

<div class="tower-info">
    <b style="color:var(--accent)">Trial Tower - <span id="floor">1</span>F</b>
</div>

<div class="enemy-box">
    <div style="display:flex; justify-content:space-between; font-size:11px;">
        <span id="eName" style="font-weight:bold;">---</span>
        <span id="eHpNum"></span>
    </div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
</div>

<div class="hero-detail">
    <div class="hero-main">
        <div>
            <span class="hero-job-tag" id="hJobName">NOVICE</span><br>
            <b style="font-size:18px;">Lv.<span id="hLv">1</span></b>
        </div>
        <div style="text-align:right;">
            HP: <span id="hHp">0/0</span><br>
            SP: <b id="hSp" style="color:var(--accent)">0</b>
        </div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; font-size:11px; color:#aaa; border-top:1px solid #222; pt:4px;">
        <span>ATK: <b id="hAtk" style="color:#eee">0</b></span>
        <span>DEF: <b id="hDef" style="color:#eee">0</b></span>
        <span>CRIT: <b id="hCrit" style="color:#eee">0%</b></span>
        <span>EXP: <b id="hExp" style="color:#eee">0%</b></span>
    </div>
</div>

<div class="log-mini" id="log"></div>

<div class="btn-grid">
    <button onclick="openM('jobM')">ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–</button>
    <button onclick="openM('skillM')">ğŸ“ ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">ğŸ“¦ è£…å‚™å“</button>
</div>

<div id="jobM" class="modal"><div class="modal-content"><h3>ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–ãƒã‚§ãƒ³ã‚¸</h3><div id="jobList"></div><br><button onclick="closeM('jobM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>

<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ <span id="curJobTitle">ã‚¹ã‚­ãƒ«</span> å¼·åŒ–</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>

<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3><div id="iList"></div><br><button onclick="closeM('equipM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>

<script>
const SAVE_KEY = "Slayer_JobTower_v4.1";
let floor=1, sp=0, inBattle=false;
let hero = { lv:1, exp:0, hp:150, maxHp:150, atk:20, def:15, job:'novice', eq:{w:null, a:null, r:null} };
let inventory = [], skills = {}; // skills[job][skillId] = level

const JOBS = {
    novice: { n: "ãƒãƒ¼ãƒ“ã‚¹", d: "å†’é™ºã®å§‹ã¾ã‚Šã€‚åŸºæœ¬èƒ½åŠ›ãŒå¹³å‡çš„ã€‚" },
    warrior: { n: "ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼", d: "å‰è¡›ã®ãƒ—ãƒ­ã€‚ATKã¨HPã®ä¼¸ã³ãŒè‰¯ã„ã€‚", req: 5 },
    mage: { n: "ãƒ¡ã‚¤ã‚¸", d: "é­”é“ã®æ¢ç©¶è€…ã€‚ATKã¨ä¼šå¿ƒã«ç‰¹åŒ–ã€‚", req: 5 },
    guardian: { n: "ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³", d: "é‰„å£ã®å®ˆã‚Šã€‚DEFãŒå¤§å¹…ã«ä¸Šæ˜‡ã€‚", req: 10 }
};

const SKILL_DATA = {
    novice: [
        { id:"nv_1", n:"åŸºç¤é›éŒ¬", d:"ATK+2", max:20, eff:{atk:2} },
        { id:"nv_2", n:"æ ¹æ€§", d:"HP+20", max:20, eff:{hp:20} }
    ],
    warrior: [
        { id:"wa_1", n:"å‰›è…•", d:"ATK+8", max:50, eff:{atk:8} },
        { id:"wa_2", n:"æˆ¦é—˜æ°‘æ—", d:"HP+100", max:50, eff:{hp:100} },
        { id:"wa_3", n:"ä¸€æ’ƒå¿…æ®º", d:"CRIT+2%", max:10, eff:{crit:0.02} }
    ],
    mage: [
        { id:"ma_1", n:"é­”åŠ›å¢—å¹…", d:"ATK+12", max:50, eff:{atk:12} },
        { id:"ma_2", n:"ç‘æƒ³", d:"EXP+5%", max:10, eff:{exp:0.05} }
    ],
    guardian: [
        { id:"gu_1", n:"é‰„å£", d:"DEF+15", max:100, eff:{def:15} },
        { id:"gu_2", n:"å®ˆè­·ç¥ã®åŠ è­·", d:"HP+300", max:100, eff:{hp:300} }
    ]
};

function updateUI() {
    let sA=0, sD=0, sH=0, sCr=0, sE=0;
    // å…¨ã‚¹ã‚­ãƒ«ã®åˆç®—ï¼ˆãƒ‘ãƒƒã‚·ãƒ–ã¨ã—ã¦ç´¯ç©ï¼‰
    Object.keys(skills).forEach(j => {
        Object.keys(skills[j]).forEach(sid => {
            const s = SKILL_DATA[j].find(x=>x.id===sid);
            const lv = skills[j][sid];
            if(s.eff.atk) sA += s.eff.atk * lv;
            if(s.eff.def) sD += s.eff.def * lv;
            if(s.eff.hp) sH += s.eff.hp * lv;
            if(s.eff.crit) sCr += s.eff.crit * lv;
            if(s.eff.exp) sE += s.eff.exp * lv;
        });
    });
    
    let eA=0, eD=0, eH=0;
    ['w','a','r'].forEach(t => { if(hero.eq[t]) { eA += hero.eq[t].atk; eD += hero.eq[t].def; eH += hero.eq[t].hp; } });

    const g = 1 + (hero.lv - 1) * 0.06;
    hero.maxHp = Math.floor((150 + sH + eH + (hero.lv-1)*30) * g);
    hero.atk = Math.floor((20 + sA + eA + (hero.lv-1)*6) * g);
    hero.def = Math.floor((15 + sD + eD + (hero.lv-1)*5) * g);
    hero.crit = (sCr * 100).toFixed(1);
    hero.expBonus = sE;

    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hCrit").innerText = hero.crit + "%";
    document.getElementById("hExp").innerText = "+" + Math.round(sE*100) + "%";
    document.getElementById("hSp").innerText = sp;
    document.getElementById("floor").innerText = floor;
    document.getElementById("hJobName").innerText = JOBS[hero.job].n.toUpperCase();
}

function addLog(msg, col="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    if(col) d.style.color = col;
    d.innerText = `> ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 20) l.removeChild(l.lastChild);
}

function nextBattle() {
    if(inBattle) return;
    const isBoss = (floor % 50 === 0);
    const p = Math.pow(1.08, floor-1) * (isBoss ? 4 : 1);
    
    const enemy = {
        name: isBoss ? `ã€éšå±¤ä¸»ã€‘${generateEnemyName(true)}` : generateEnemyName(false),
        hp: (80 + floor * 20) * p,
        atk: (5 + floor * 2) * p,
        maxHp: 0
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    document.getElementById("eName").style.color = isBoss ? "#e74c3c" : "#ccc";
    runBattle(enemy, isBoss);
}

function runBattle(e, isBoss) {
    inBattle = true;
    const it = setInterval(() => {
        let d = Math.max(1, hero.atk - (e.atk*0.05));
        if(Math.random() < (hero.crit/100)) { d *= 2.5; addLog("CRITICAL!", "#f1c40f"); }
        e.hp -= d;

        if(e.hp <= 0) {
            clearInterval(it);
            addLog(`${e.name} ã‚’æ’ƒç ´ã€‚`);
            hero.exp += (20 + floor) * (1 + hero.expBonus);
            if(hero.exp >= 100) { hero.lv++; hero.exp=0; sp += 2; addLog(`LEVEL UP! SP+2`, "#f1c40f"); }
            if(isBoss || Math.random() < 0.1) dropItem();
            floor++; inBattle = false; save(); updateUI();
            setTimeout(nextBattle, 400);
        } else {
            hero.hp -= Math.max(1, e.atk - hero.def);
            document.getElementById("eHpFill").style.width = (e.hp/e.maxHp*100) + "%";
            document.getElementById("eHpNum").innerText = Math.floor(e.hp);
            updateUI();
            if(hero.hp <= 0) {
                clearInterval(it);
                addLog(`å‹‡è€…ã¯å€’ã‚ŒãŸ... å†æŒ‘æˆ¦ã€‚`, "#e74c3c");
                hero.hp = hero.maxHp; inBattle = false;
                setTimeout(nextBattle, 1000);
            }
        }
    }, 150);
}

function generateEnemyName(boss) {
    const list = boss ? ["ãƒ‡ãƒ“ãƒ«", "ãƒ‰ãƒ©ã‚´ãƒ³", "ãƒªãƒƒãƒ", "ã‚´ãƒ¼ãƒ¬ãƒ "] : ["ã‚¹ãƒ©ã‚¤ãƒ ", "ã‚´ãƒ–ãƒªãƒ³", "ã‚³ãƒœãƒ«ãƒˆ", "ãƒãƒƒãƒˆ"];
    return list[Math.floor(Math.random()*list.length)] + (boss ? "ãƒ»ãƒ­ãƒ¼ãƒ‰" : "");
}

function dropItem() {
    const pow = 1 + floor / 50;
    const item = { id: Date.now(), type: 'w', name: `éšå±¤ã®å‰£+${Math.floor(pow)}`, atk: Math.floor(pow*15), def:0, hp:0 };
    if(Math.random() < 0.3) { item.type='a'; item.name=`éšå±¤ã®é§+${Math.floor(pow)}`; item.def=Math.floor(pow*12); item.atk=0; }
    inventory.push(item);
    addLog(`ã‚¢ã‚¤ãƒ†ãƒ å…¥æ‰‹: ${item.name}`, "#2ecc71");
}

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='jobM'?'jobList':id==='skillM'?'sList':'iList');
    d.innerHTML = "";
    if(id==='jobM') Object.keys(JOBS).forEach(k => {
        const j = JOBS[k]; const lock = hero.lv < j.req;
        d.innerHTML += `<div class="job-card"><div><b>${j.n}</b><br><small>${j.d}${lock?`<br>(Lv.${j.req}ã§é–‹æ”¾)` : ''}</small></div>
            <button onclick="changeJob('${k}')" ${lock || hero.job===k ?'disabled':''}>${hero.job===k?'ç¾åœ¨':'è»¢è·'}</button></div>`;
    });
    if(id==='skillM') {
        document.getElementById("curJobTitle").innerText = JOBS[hero.job].n;
        SKILL_DATA[hero.job].forEach(s => {
            if(!skills[hero.job]) skills[hero.job] = {};
            const lv = skills[hero.job][s.id] || 0;
            d.innerHTML += `<div class="tree-node"><div><b>${s.n} Lv.${lv}/${s.max}</b><br><small>${s.d}</small></div>
                <button onclick="buyS('${s.id}')" ${lv>=s.max||sp<1?'disabled':''}>å¼·åŒ–</button></div>`;
        });
    }
    if(id==='equipM') inventory.forEach(item => {
        const isEq = Object.values(hero.eq).some(e => e && e.id === item.id);
        d.innerHTML += `<div class="item-card" style="border:1px solid #333; padding:5px; margin-bottom:5px;"><b>${item.name}</b><br>
            <button onclick="equipI(${item.id})" ${isEq?'disabled':''}>${isEq?'è£…å‚™ä¸­':'è£…å‚™'}</button>
            <button onclick="sellI(${item.id})">å£²å´</button></div>`;
    });
}

function changeJob(k) { hero.job = k; updateUI(); save(); openM('jobM'); addLog(`${JOBS[k].n}ã«è»¢è·ã—ã¾ã—ãŸã€‚`); }
function buyS(id) { if(sp>=1){ sp--; skills[hero.job][id] = (skills[hero.job][id]||0)+1; updateUI(); save(); openM('skillM'); } }
function equipI(id) { const i = inventory.find(x=>x.id===id); hero.eq[i.type]=i; updateUI(); save(); openM('equipM'); }
function sellI(id) { inventory = inventory.filter(x=>x.id!==id); Object.keys(hero.eq).forEach(k=>{if(hero.eq[k]&&hero.eq[k].id===id)hero.eq[k]=null;}); updateUI(); save(); openM('equipM'); }
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() { localStorage.setItem(SAVE_KEY, JSON.stringify({ hero, skills, inventory, floor, sp })); }
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) { const d = JSON.parse(s); hero=d.hero; skills=d.skills; inventory=d.inventory; floor=d.floor; sp=d.sp; }
    hero.hp = hero.maxHp;
}
load(); updateUI(); nextBattle();
</script>
</body>
</html>
