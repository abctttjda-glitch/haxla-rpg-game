<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v2.7.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --main-bg: #111; --panel-bg: #1e1e1e; --accent: #f1c40f; --text: #eee; --btn-bg: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
/* dvhã‚’ä½¿ç”¨ã—ã¦ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã«éš ã‚Œã‚‹ã®ã‚’é˜²ã */
body { 
    margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:12px; padding:4px;
    height: 100vh; height: 100dvh; overflow:hidden; display:flex; flex-direction:column;
}
.panel { background:var(--panel-bg); border:1px solid #444; border-radius:6px; padding:4px; margin-bottom:4px; }
button { background:var(--btn-bg); color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; font-weight:bold; }
.active { background:var(--accent) !important; color:#000 !important; }
.toggleOn { background:#2ecc71 !important; color:#000 !important; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
.header { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; height: 45px; }
.top-right { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }

/* æ•µHPï¼šç´°ã */
.enemy-box { display: flex; align-items: center; gap: 5px; height: 20px; margin-bottom: 4px; }
.hp-bar-outer { flex-grow: 1; background:#333; height:12px; border-radius:6px; overflow:hidden; position:relative; border:1px solid #555; }
.hp-bar-inner { background:#e74c3c; height:100%; width:0%; transition: width 0.1s; }
.hp-text { position:absolute; width:100%; text-align:center; font-size:9px; top:0; line-height:10px; }

/* ãƒ¡ã‚¤ãƒ³ï¼šãƒ‘ãƒ¼ãƒ†ã‚£é‡è¦– */
.main-content { display: flex; flex: 1; min-height: 0; gap: 4px; margin-bottom: 4px; }
.party-list { flex: 1.5; overflow-y: auto; }
.log { flex: 1; background:#000; padding:2px; overflow-y:auto; display:flex; flex-direction:column-reverse; font-size: 9px; border-radius: 4px; border: 1px solid #333; }

.char-card { border-bottom: 1px solid #333; padding: 4px 0; cursor: pointer; }
.char-head { display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; }
.job-label { color: var(--accent); font-size: 9px; background: rgba(241,196,15,0.1); padding: 0 2px; border-radius: 2px; }

/* æ“ä½œç³»ï¼šçµ¶å¯¾ã«éš ã•ãªã„ */
.footer { height: 50px; display: grid; grid-template-columns: 1fr 2fr; gap: 4px; }
.footer button { font-size: 16px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#2c3e50; border:2px solid #555; border-radius:10px; width:90%; max-width:320px; padding:15px; }
</style>
</head>
<body>

<div class="header">
    <div class="panel">
        <strong><span id="floor">1</span>F</strong> <small>(<span id="holy">0</span>Pt)</small>
        <div style="font-size:9px; color:#a29bfe;">ğŸ¾Lv<span id="petLv">1</span> <span id="killCount">0/10</span></div>
    </div>
    <div class="top-right">
        <button onclick="openModal('upgradeModal')">âœ¨å¼·åŒ–</button>
        <button onclick="openModal('casinoModal')">ğŸ°ï½¶ï½¼ï¾ï¾‰</button>
        <button onclick="warpMax()" style="grid-column: span 2; font-size:10px;">Warp Max</button>
    </div>
</div>

<div class="panel enemy-box">
    <div id="enemyName" style="font-size:10px; min-width:60px; font-weight:bold; overflow:hidden;">---</div>
    <div class="hp-bar-outer">
        <div id="enemyHpBar" class="hp-bar-inner"></div>
        <div id="enemyHpNum" class="hp-text">0/0</div>
    </div>
</div>

<div class="main-content">
    <div class="panel party-list" id="partyList"></div>
    <div class="log" id="log"></div>
</div>

<div class="footer">
    <button onclick="stepDungeon()">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<div id="charModal" class="modal"><div class="modal-content" id="m-content"></div></div>

<div id="upgradeModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0; text-align:center;">âœ¨è–æ¯å¼·åŒ– (Pt:<span id="holy2">0</span>)</h3>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:4px; margin:10px 0;">
            <button id="amt1" onclick="setAmount(1)">x1</button>
            <button id="amt10" onclick="setAmount(10)">x10</button>
            <button id="amtMAX" onclick="setAmount('MAX')">MAX</button>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:10px;">
            <button onclick="upgrade('atk')">æ”»æ’ƒ +<span id="b-atk">0</span></button>
            <button onclick="upgrade('def')">é˜²å¾¡ +<span id="b-def">0</span></button>
            <button onclick="upgrade('hp')">æœ€å¤§HP +<span id="b-hp">0</span></button>
            <button onclick="upgrade('exp')">çµŒé¨“å€¤ +<span id="b-exp">0</span></button>
        </div>
        <button id="autoUpBtn" style="width:100%; padding:10px;" onclick="toggleAutoUpgrade()">è‡ªå‹•å¼·åŒ–: OFF</button>
        <button onclick="closeModal('upgradeModal')" style="width:100%; margin-top:10px; background:#c0392b;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="casinoModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 style="margin:0; color:var(--accent);">è–æ¯ã‚«ã‚¸ãƒ</h3>
        <div id="slot" style="font-size:32px; margin:15px 0; background:#000; border-radius:8px; padding:10px;">â“ â“ â“</div>
        <div id="casinoResult" style="min-height:1.2em; font-weight:bold; color:var(--accent); margin-bottom:10px;"></div>
        <button onclick="playCasino()" id="spinBtn" style="width:100%; padding:12px; background:#27ae60;">ã‚¹ãƒ”ãƒ³ (1Pt)</button>
        <button onclick="closeModal('casinoModal')" style="width:100%; margin-top:10px; background:#c0392b;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
const SAVE_KEY = "HolyRPG_Final_Fixed_v2.7";
let floor=1, maxReachedFloor=1, kills=0, holy=0, petLv=1;
let bonus={atk:0, def:0, hp:0, exp:0}, buyAmount=1, autoIsOn=false, autoUpgrade=false;
let party=[], enemy=null;

const JOB_DATA = {
    "ã›ã‚“ã—": {h:160, a:15, d:15, skills:["ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒ©ãƒƒã‚·ãƒ¥","ã‚·ãƒ¼ãƒ«ãƒ‰ãƒãƒƒã‚·ãƒ¥","ç ´å²©æ–¬"]},
    "ã¨ã†ãã": {h:110, a:13, d:9, skills:["æ€¥æ‰€çªã","ãƒ™ãƒãƒ ã‚¹ãƒˆãƒ©ã‚¤ã‚¯","å½±ç¸«ã„"]},
    "ã¾ã»ã†ã¤ã‹ã„": {h:90, a:28, d:6, skills:["ãƒ•ãƒ¬ã‚¤ãƒ ","ãƒ–ãƒªã‚¶ãƒ¼ãƒ‰","ãƒ©ã‚¤ãƒˆãƒ‹ãƒ³ã‚°"]},
    "ãã†ã‚Šã‚‡": {h:130, a:11, d:11, skills:["ãƒ’ãƒ¼ãƒ«","ãƒ—ãƒ­ãƒ†ã‚¯ã‚·ãƒ§ãƒ³","ãƒªã‚¶ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³"]},
    "å‹‡è€…": {h:300, a:45, d:30, skills:["ã‚®ã‚¬ã‚¹ãƒ©ãƒƒã‚·ãƒ¥","ã‚¢ãƒ«ãƒ†ãƒãƒ–ãƒ¬ã‚¤ãƒ‰","å¤©ç½°"]}
};

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.alive=true;
        this.weapon={name:"æœ¨ã®æ£’",val:0}; this.armor={name:"å¸ƒã®æœ",val:0};
    }
    updateStats() {
        const j = JOB_DATA[this.job];
        const growth = 1 + (this.level - 1) * 0.15;
        this.maxHp = Math.floor((j.h + bonus.hp + (this.level-1)*45) * growth);
        this.atk = Math.floor((j.a + bonus.atk + (this.level-1)*8 + this.weapon.val) * growth);
        this.def = Math.floor((j.d + bonus.def + (this.level-1)*6 + this.armor.val) * growth);
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function openModal(id) { document.getElementById(id).style.display = "flex"; if(id==='upgradeModal') updateUI(); }
function closeModal(id) { document.getElementById(id).style.display = "none"; }

function showCharDetail(idx) {
    const c = party[idx];
    const j = JOB_DATA[c.job];
    document.getElementById("m-content").innerHTML = `
        <h3 style="margin:0">${c.icon} ${c.name} <span class="job-label">${c.job}</span></h3>
        <hr style="border:0; border-top:1px solid #555; margin:8px 0;">
        <p>Lv:${c.level} | EXP:${Math.floor(c.exp)}/100</p>
        <p>HP: ${Math.floor(c.hp)} / ${c.maxHp}</p>
        <p>ATK: ${c.atk} / DEF: ${c.def}</p>
        <p style="color:var(--accent);">ç¿’å¾—ã‚¹ã‚­ãƒ«: ${j.skills.join(", ")}</p>
        <div style="background:rgba(0,0,0,0.2); padding:5px; border-radius:4px;">
            âš”ï¸ ${c.weapon.name} (+${c.weapon.val})<br>ğŸ›¡ï¸ ${c.armor.name} (+${c.armor.val})
        </div>
        <button onclick="closeModal('charModal')" style="width:100%; margin-top:10px; padding:10px;">é–‰ã˜ã‚‹</button>
    `;
    openModal("charModal");
}

function addLog(t, color="#eee") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    line.style.color = color; line.innerText = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 20) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").innerText = floor;
    document.getElementById("holy").innerText = holy;
    document.getElementById("holy2").innerText = holy;
    document.getElementById("killCount").innerText = `${kills%10}/10`;
    document.getElementById("petLv").innerText = petLv;
    document.getElementById("b-atk").innerText = bonus.atk;
    document.getElementById("b-def").innerText = bonus.def;
    document.getElementById("b-hp").innerText = bonus.hp;
    document.getElementById("b-exp").innerText = bonus.exp;

    const pList = document.getElementById("partyList");
    pList.innerHTML = "";
    party.forEach((c, i) => {
        c.updateStats();
        const div = document.createElement("div");
        div.className = "char-card " + (c.alive ? "" : "dead");
        div.onclick = () => showCharDetail(i);
        div.innerHTML = `
            <div class="char-head"><span>${c.icon}${c.name} <span class="job-label">Lv${c.level}</span></span><span>HP:${Math.floor(c.hp)}</span></div>
            <div style="font-size:9px; color:#aaa;">${c.job} | âš”ï¸+${c.weapon.val} ğŸ›¡ï¸+${c.armor.val}</div>
        `;
        pList.appendChild(div);
    });
}

function stepDungeon() {
    if(enemy) return;
    const mons = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚´ãƒ–ãƒªãƒ³","ã‚ªãƒ¼ã‚¯","ã‚¦ãƒ«ãƒ•","ãƒŸã‚¤ãƒ©","ã‚´ãƒ¼ãƒ¬ãƒ ","ãƒ‡ãƒ¼ãƒ¢ãƒ³","ãƒ‰ãƒ©ã‚´ãƒ³"];
    const name = (floor%10===0?"BOSS ":"") + mons[Math.min(mons.length-1, Math.floor(floor/20))];
    const power = (1 + floor/100);
    enemy = { name: name, maxHp:(300+floor*80)*power, hp:0, atk:(15+floor*10)*power, def:(10+floor*6)*power };
    enemy.hp = enemy.maxHp;
    battleLoop();
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            let dmg = Math.max(1, c.atk - enemy.def);
            if(Math.random() < 0.2) {
                const s = JOB_DATA[c.job].skills[Math.floor(Math.random()*3)];
                if(c.job === "ãã†ã‚Šã‚‡") { c.hp = Math.min(c.maxHp, c.hp + c.atk); addLog(`ğŸ•Šï¸${s}`, "#2ecc71"); }
                else { dmg *= 2.5; addLog(`${c.icon}${s}!`, "#3498db"); }
            }
            enemy.hp -= dmg;
            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); kills++;
                if(kills%10===0) { holy++; if(autoUpgrade) autoDistribute(); }
                if(Math.random()<0.25) dropGear();
                party.forEach(char => {
                    char.exp += 30 * (1+bonus.exp*0.1);
                    if(char.exp >= 100){ char.level++; char.exp=0; char.hp=char.maxHp; addLog(`ğŸ†™${char.name}LvUP`); }
                });
                if(floor===100 && party[0].job!=="å‹‡è€…") { party[0].job="å‹‡è€…"; party[0].icon="ğŸ‘‘"; addLog("ğŸ‘‘å‹‡è€…è¦šé†’"); }
                floor++; if(floor>maxReachedFloor) maxReachedFloor=floor;
                enemy=null; save(); if(autoIsOn) setTimeout(stepDungeon, 50);
                updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t){ clearInterval(it); floor=Math.max(1, floor-5); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0) t.alive=false;
        }
        document.getElementById("enemyName").innerText = enemy ? enemy.name : "---";
        document.getElementById("enemyHpNum").innerText = enemy ? Math.floor(enemy.hp) : "0/0";
        document.getElementById("enemyHpBar").style.width = enemy ? (enemy.hp/enemy.maxHp*100)+"%" : "0%";
        updateUI();
    }, 60);
}

function dropGear() {
    const target = party[Math.floor(Math.random()*party.length)];
    const val = Math.floor(floor * 1.8);
    if(Math.random()>0.5) { target.weapon.val = val; addLog(`ğŸ${target.name}æ­¦å™¨UP`, "#f39c12"); }
    else { target.armor.val = val; addLog(`ğŸ${target.name}é˜²å…·UP`, "#f39c12"); }
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function setAmount(a) { buyAmount = a; ["amt1", "amt10", "amtMAX"].forEach(id => document.getElementById(id).classList.toggle("active", id.includes(a))); }
function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost; bonus[t] += (t==='hp'?cost*50:cost*5); updateUI(); save();
}
function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : ""; }
function autoDistribute() { upgrade(['atk','def','hp','exp'][Math.floor(Math.random()*4)]); }
function warpMax() { if(!enemy){ floor = maxReachedFloor; updateUI(); }}

function playCasino() {
    if(holy < 1) return;
    holy--; updateUI();
    const slot = document.getElementById("slot");
    const spinBtn = document.getElementById("spinBtn");
    spinBtn.disabled = true;
    let timer = 0;
    const interval = setInterval(() => {
        const items = ["ğŸ’","âš”ï¸","ğŸ€","â­","ğŸ"];
        slot.innerText = items[Math.floor(Math.random()*5)] + " " + items[Math.floor(Math.random()*5)] + " " + items[Math.floor(Math.random()*5)];
        if(++timer > 10) {
            clearInterval(interval);
            if(Math.random() < 0.1) { holy += 10; document.getElementById("casinoResult").innerText = "å¤§å½“ã‚Šï¼Pt+10"; }
            else { bonus.atk += 10; document.getElementById("casinoResult").innerText = "æ”»æ’ƒåŠ›+10"; }
            spinBtn.disabled = false; updateUI(); save();
        }
    }, 80);
}

function save() {
    const data = { floor, maxReachedFloor, holy, bonus, petLv, party: party.map(c => ({
        name:c.name, job:c.job, icon:c.icon, level:c.level, hp:c.hp, weapon:c.weapon, armor:c.armor
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}
function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        try {
            const d = JSON.parse(saved);
            floor=d.floor||1; maxReachedFloor=d.maxReachedFloor||1; holy=d.holy||0; bonus=d.bonus||{atk:0,def:0,hp:0,exp:0};
            party = d.party.map(p => { 
                let c=new Character(p.name, p.job, p.icon); c.level=p.level; c.hp=p.hp; 
                c.weapon=p.weapon||{name:"æœ¨ã®æ£’",val:0}; c.armor=p.armor||{name:"å¸ƒã®æœ",val:0}; return c; 
            });
        } catch(e) { initParty(); }
    } else { initParty(); }
}
function initParty() {
    party = [new Character("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Character("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Character("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Character("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
}
load(); updateUI();
</script>
</body>
</html>
