<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v1.8.0</title>
<style>
body{ margin:0; background:#111; color:#eee; font-family:sans-serif; font-size:15px; padding:6px; }
.version { position: absolute; top: 5px; right: 10px; font-size: 11px; color: #555; }
h2{margin:4px 0;font-size:20px; color:#f1c40f;}
.panel{ background:#1a1a1a; border:1px solid #444; border-radius:6px; padding:8px; margin-bottom:6px; }
button{ width:100%; background:#333; color:#eee; border:1px solid #555; border-radius:6px; font-size:16px; padding:6px 0; margin-top:3px; cursor: pointer; }
.toggleOn{background:#2ecc71;color:#000;font-weight:bold;}
.dead{opacity:0.4; filter: grayscale(100%);}
.partyRow{ font-size:13px; margin:5px 0; border-bottom: 1px solid #333; padding-bottom:5px; }
.hp-num { font-size: 11px; color: #ccc; float: right; }
.barWrap{ background:#333; height:8px; border-radius:4px; overflow:hidden; margin-top:3px; clear: both; }
.bar{background:#e74c3c; height:100%; transition: width 0.1s;}
.log{ font-size:13px; height:120px; overflow-y:auto; background: #000; padding: 5px; display: flex; flex-direction: column-reverse; }
.skill-text { color: #3498db; font-weight: bold; }
.lvup-text { color: #f1c40f; font-weight: bold; }
.unlock-text { color: #ff3e3e; font-weight: bold; font-size: 16px; text-align: center; }
.amount-selector { display: flex; gap: 4px; margin-bottom: 8px; }
.amount-btn { font-size: 12px; padding: 5px; background: #222; flex:1; border: 1px solid #444; color: #eee; }
.amount-btn.active { background: #f1c40f; color: #000; border-color: #fff; }
.stat-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; margin-bottom: 5px; }
.warp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-top:5px; }
.warp-btn { font-size: 11px; padding: 4px 0; background: #222; }
</style>
</head>
<body>

<div class="version">v1.8.0 [Persistent & Awakening]</div>
<h2>è–æ¯ã‚ªãƒ¼ãƒˆRPG</h2>

<div class="panel">
    <strong>éšå±¤: <span id="floor">1</span> / 1000</strong> (å‘¨å›: <span id="loopCount">0</span>)<br>
    è–æ¯Pt: <span id="holy" style="color:#f1c40f; font-weight:bold;">0</span> 
    (è¨ä¼æ•°: <span id="killsDisplay">0</span>)
    <div id="warpContainer" class="warp-grid"></div>
</div>

<div class="panel">
    <strong>è–æ¯å¼·åŒ–</strong>
    <div class="amount-selector">
        <button id="amt1" class="amount-btn active" onclick="setAmount(1)">x1</button>
        <button id="amt10" class="amount-btn" onclick="setAmount(10)">x10</button>
        <button id="amt100" class="amount-btn" onclick="setAmount(100)">x100</button>
        <button id="amtMAX" class="amount-btn" onclick="setAmount('MAX')">MAX</button>
    </div>
    <div class="stat-row">
        <div>ATK: +<span id="b-atk">0</span> <button onclick="upgrade('atk')">å¼·åŒ–</button></div>
        <div>DEF: +<span id="b-def">0</span> <button onclick="upgrade('def')">å¼·åŒ–</button></div>
        <div>HP: +<span id="b-hp">0</span> <button onclick="upgrade('hp')">å¼·åŒ–</button></div>
        <div>EXP: +<span id="b-exp">0</span>% <button onclick="upgrade('exp')">å¼·åŒ–</button></div>
    </div>
    <button id="autoUpgradeBtn" onclick="toggleAutoUpgrade()">è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ OFF</button>
</div>

<div class="panel">
    <strong>æ•µ: <span id="enemyName"></span></strong>
    <span class="hp-num" id="enemyHpNum">0 / 0</span>
    <div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div id="party"></div>

<div class="panel log" id="log"></div>

<div class="panel" style="display:flex; gap:5px;">
    <button onclick="stepDungeon()" style="flex:1">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()" style="flex:1">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<script>
const BATTLE_SPEED = 20; 
const MAX_FLOOR = 1000;
const SAVE_KEY = "HolyRPG_Persistent_Data"; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³é–“ã§å…±é€šã®ã‚­ãƒ¼

let floor = 1, maxReachedFloor = 1, loopCount = 0, kills = 0, holy = 0;
let bonus = {atk:0, def:0, hp:0, exp:0};
let buyAmount = 1, autoIsOn = false, autoUpgrade = false, heroUnlocked = false;
let party = [], enemy = null;

const JOBS = {
    "ã›ã‚“ã—": { hp:150, atk:12, def:12, skills: [{name:"å¼·æ’ƒ", rate:0.25, power:2.5}] },
    "ã¨ã†ãã": { hp:100, atk:11, def:6, skills: [{name:"æ€¥æ‰€çªã", rate:0.3, power:3.0}] },
    "ã¾ã»ã†ã¤ã‹ã„": { hp:80, atk:22, def:4, skills: [{name:"çˆ†ç™ºé­”æ³•", rate:0.3, power:4.0}] },
    "ãã†ã‚Šã‚‡": { hp:120, atk:8, def:8, skills: [{name:"ãƒ’ãƒ¼ãƒ«", rate:0.25, power:0}] },
    "å‹‡è€…": { hp:250, atk:35, def:20, skills: [{name:"ã‚®ã‚¬ã‚¹ãƒ©ãƒƒã‚·ãƒ¥", rate:0.35, power:5.0}] }
};

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.eqAtk=0; this.eqDef=0; this.alive=true;
    }
    updateStats() {
        const j = JOBS[this.job];
        // ãƒ¬ãƒ™ãƒ«ä¸Šæ˜‡å€¤ + è–æ¯ãƒœãƒ¼ãƒŠã‚¹ + 10ãƒ¬ãƒ™æ¯ã®ãƒ‘ãƒƒã‚·ãƒ–è¦šé†’(å„+15%)
        const awakeMult = 1 + Math.floor(this.level / 10) * 0.15;
        this.maxHp = Math.floor((j.hp + (bonus.hp||0) + (this.level-1)*45) * awakeMult);
        this.atk = Math.floor((j.atk + (bonus.atk||0) + (this.level-1)*7) * awakeMult);
        this.def = Math.floor((j.def + (bonus.def||0) + (this.level-1)*5) * awakeMult);
    }
    gainExp(v) {
        this.exp += v * (1 + (bonus.exp||0) * 0.1);
        const next = 30 + this.level * 25;
        if(this.exp >= next) {
            this.level++; this.exp = 0;
            addLog(`â˜…${this.name} LvUP! [Lv${this.level}]`, "lvup-text");
            if(this.level % 10 === 0) addLog(`>>> ${this.name}ã®èƒ½åŠ›ãŒè¦šé†’ã—ãŸï¼`, "skill-text");
            this.updateStats(); this.hp = this.maxHp;
        }
    }
}

function addLog(t, cls="") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    if(cls) line.className = cls;
    line.innerHTML = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 25) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("loopCount").textContent = loopCount;
    document.getElementById("holy").textContent = holy;
    document.getElementById("killsDisplay").textContent = kills;
    document.getElementById("b-atk").textContent = bonus.atk;
    document.getElementById("b-def").textContent = bonus.def;
    document.getElementById("b-hp").textContent = bonus.hp;
    document.getElementById("b-exp").textContent = bonus.exp * 10;

    const pEl = document.getElementById("party");
    pEl.innerHTML = "";
    party.forEach(c => {
        c.updateStats();
        if(c.hp > c.maxHp) c.hp = c.maxHp;
        const row = document.createElement("div");
        row.className = "panel partyRow " + (c.alive ? "" : "dead");
        const hpP = (c.hp / c.maxHp) * 100;
        row.innerHTML = `
            <div>${c.icon} ${c.name} [${c.job}] Lv${c.level} <span style="font-size:10px;">(ATK:${c.atk+c.eqAtk} DEF:${c.def+c.eqDef})</span></div>
            <span class="hp-num">${Math.floor(c.hp)} / ${c.maxHp}</span>
            <div class="barWrap"><div class="bar" style="width:${hpP}%"></div></div>`;
        pEl.appendChild(row);
    });
    updateWarpButtons();
}

function updateWarpButtons() {
    const container = document.getElementById("warpContainer");
    if(container.childNodes.length === Math.floor((maxReachedFloor-1)/100)+1) return;
    container.innerHTML = "";
    for(let i=1; i<=maxReachedFloor; i+=100) {
        const b = document.createElement("button");
        b.className = "warp-btn"; b.textContent = i + "F";
        b.onclick = () => { if(!enemy){ floor = i; addLog(i + "Fã¸ãƒ¯ãƒ¼ãƒ—"); updateUI(); save(); }};
        container.appendChild(b);
    }
}

function spawnEnemy() {
    const pre = ["å‡¶æš´ãª", "å¤ã®", "è–ãªã‚‹", "æ·±æ·µã®", "é»„é‡‘ã®", "é—‡ã®"];
    const suf = ["ãƒ‰ãƒ©ã‚´ãƒ³", "ãƒ‡ãƒ¼ãƒ¢ãƒ³", "ã‚­ãƒã‚¤ãƒ©", "å¤§è›‡", "é­”ç¥"];
    const name = pre[Math.floor(Math.random()*pre.length)] + suf[Math.floor(Math.random()*suf.length)];
    const p = (1 + loopCount + floor/80);
    enemy = { 
        name: (floor%10===0 ? "ã€BOSSã€‘"+name : name),
        maxHp: (120 + floor*50) * p, hp: 0, 
        atk: (12 + floor*5) * p, 
        def: (6 + floor*3) * p 
    };
    enemy.hp = enemy.maxHp;
    updateEnemyUI();
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            const j = JOBS[c.job];
            if(Math.random() < j.skills[0].rate) {
                if(c.job === "ãã†ã‚Šã‚‡") {
                    party.forEach(m => { if(m.alive) m.hp = Math.min(m.maxHp, m.hp + (m.maxHp*0.4)); });
                    addLog(`${c.icon} å¥‡è·¡ã®ç¥ˆã‚Š`, "skill-text");
                } else {
                    let d = Math.max(1, (c.atk + c.eqAtk) * j.skills[0].power - enemy.def);
                    enemy.hp -= d;
                    addLog(`${c.icon}${j.skills[0].name}!`, "skill-text");
                }
            } else {
                enemy.hp -= Math.max(1, (c.atk + c.eqAtk) - enemy.def);
            }

            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it);
                addLog(`${enemy.name}ã‚’è¨ä¼ï¼`);
                kills++;
                if(kills % 10 === 0) { holy++; addLog("è–æ¯Pt +1", "lvup-text"); if(autoUpgrade) autoDistribute(); }
                party.forEach(char => char.gainExp(25));
                
                // åˆã‚ã¦100å±¤ã‚’çªç ´ã—ãŸã‚‰å‹‡è€…è§£æ”¾
                if(floor === 100 && !heroUnlocked) {
                    heroUnlocked = true;
                    party[0].job = "å‹‡è€…"; party[0].icon = "ğŸ‘‘";
                    addLog("!! ä¼èª¬ã®å‹‡è€…ãŒè¦šé†’ã—ãŸ !!", "unlock-text");
                }

                if(floor >= MAX_FLOOR) { floor = 1; loopCount++; } else { floor++; }
                if(floor > maxReachedFloor) maxReachedFloor = floor;
                enemy = null; save();
                if(autoIsOn) setTimeout(stepDungeon, 100);
                updateUI();
            }
        });

        if(enemy) {
            const target = party.find(c => c.alive);
            if(!target) {
                clearInterval(it); addLog(`æ•—é€€... 10Få¾Œé€€`, "lvup-text");
                floor = Math.max(1, floor - 10);
                party.forEach(c => { c.hp = c.maxHp; c.alive = true; });
                enemy = null; updateUI(); save();
                if(autoIsOn) setTimeout(stepDungeon, 500);
                return;
            }
            let eDmg = Math.max(1, enemy.atk - (target.def + target.eqDef));
            target.hp -= eDmg; if(target.hp <= 0) { target.hp = 0; target.alive = false; }
        }
        updateUI(); updateEnemyUI();
    }, 1000 / BATTLE_SPEED);
}

function updateEnemyUI() {
    if(!enemy) return;
    document.getElementById("enemyName").textContent = enemy.name;
    document.getElementById("enemyHpNum").textContent = `${Math.floor(enemy.hp)} / ${Math.floor(enemy.maxHp)}`;
    document.getElementById("enemyHpBar").style.width = (enemy.hp/enemy.maxHp*100) + "%";
}

function stepDungeon() { if(!enemy){ spawnEnemy(); battleLoop(); } }
function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; document.getElementById("mainAutoBtn").textContent = autoIsOn?"åœæ­¢":"ã‚ªãƒ¼ãƒˆé–‹å§‹"; if(autoIsOn) stepDungeon(); }
function setAmount(a) { 
    buyAmount = a; 
    ["1", "10", "100", "MAX"].forEach(v => {
        document.getElementById("amt"+v).classList.toggle("active", a === (v === "MAX" ? "MAX" : parseInt(v)));
    });
}
function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost;
    if(t === "hp") bonus.hp += cost * 50;
    else if(t === "exp") bonus.exp += cost;
    else bonus[t] += cost * 10;
    updateUI(); save();
}

function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; document.getElementById("autoUpgradeBtn").className = autoUpgrade ? "toggleOn" : ""; }
function autoDistribute() { const keys = ["atk", "def", "hp", "exp"]; upgrade(keys[Math.floor(Math.random()*4)]); }

function save() {
    const data = { floor, maxReachedFloor, loopCount, kills, holy, bonus, autoUpgrade, heroUnlocked, party: party.map(c => ({
        name: c.name, job: c.job, icon: c.icon, level: c.level, exp: c.exp, hp: c.hp, eqAtk: c.eqAtk, eqDef: c.eqDef
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}

function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        const d = JSON.parse(saved);
        floor = d.floor || 1; maxReachedFloor = d.maxReachedFloor || 1;
        loopCount = d.loopCount || 0; kills = d.kills || 0;
        holy = d.holy || 0; bonus = d.bonus || {atk:0, def:0, hp:0, exp:0};
        autoUpgrade = d.autoUpgrade || false;
        heroUnlocked = d.heroUnlocked || false;
        if(autoUpgrade) document.getElementById("autoUpgradeBtn").className = "toggleOn";
        party = d.party.map(p => {
            let c = new Character(p.name, p.job, p.icon);
            c.level = p.level; c.exp = p.exp; c.hp = p.hp;
            c.eqAtk = p.eqAtk; c.eqDef = p.eqDef;
            return c;
        });
    } else {
        party = [
            new Character("ãƒ¬ã‚ªãƒ³", "ã›ã‚“ã—", "âš”ï¸"),
            new Character("ãƒŸãƒ©", "ã¨ã†ãã", "ğŸ—¡ï¸"),
            new Character("ã‚¢ãƒ¼ã‚¯", "ã¾ã»ã†ã¤ã‹ã„", "ğŸª„"),
            new Character("ã‚»ãƒ©", "ãã†ã‚Šã‚‡", "ğŸ•Šï¸")
        ];
    }
}

load();
updateUI();
</script>
</body>
</html>
