<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v2.5.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
:root { --main-bg: #111; --panel-bg: #1e1e1e; --accent: #f1c40f; --text: #eee; --btn-bg: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { 
    margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:13px; padding:4px;
    height:100vh; overflow:hidden; display:flex; flex-direction:column;
}
.panel { background:var(--panel-bg); border:1px solid #444; border-radius:6px; padding:5px; margin-bottom:4px; }
button { background:var(--btn-bg); color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; font-size:12px; transition: 0.1s; }
button:active { transform: scale(0.95); background: #444; }
.active { background:var(--accent) !important; color:#000 !important; font-weight:bold; }
.toggleOn { background:#2ecc71 !important; color:#000; font-weight:bold; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»çŠ¶æ³ */
.header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
.enemy-panel { display: flex; align-items: center; gap: 8px; height: 26px; }
.hp-bar-outer { flex-grow: 1; background:#333; height:12px; border-radius:6px; overflow:hidden; position:relative; }
.hp-bar-inner { background:#e74c3c; height:100%; width:0%; transition: width 0.1s; }
.hp-text { position:absolute; width:100%; text-align:center; font-size:10px; font-weight:bold; top:0px; line-height:12px; }

/* ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ»ãƒ­ã‚°ï¼ˆä¸­å¤®ï¼‰ */
.main-content { display: grid; grid-template-columns: 1.2fr 1fr; gap: 4px; flex: 1; min-height: 0; }
.party-list { overflow-y: auto; }
.char-card { border-bottom: 1px solid #333; padding: 4px 0; cursor: pointer; }
.char-card:hover { background: rgba(255,255,255,0.05); }
.char-info { display:flex; justify-content:space-between; font-weight:bold; }
.job-tag { font-size: 9px; color: var(--accent); border: 1px solid var(--accent); padding: 0 2px; border-radius: 2px; }
.log { background:#000; padding:4px; overflow-y:auto; display:flex; flex-direction:column-reverse; border:1px solid #333; border-radius:4px; font-size: 10px; line-height: 1.2; }

/* æ“ä½œãƒ‘ãƒãƒ«ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ */
.action-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 6px; }
.menu-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
.modal-content { background: #2c3e50; border: 2px solid #555; border-radius: 10px; width: 90%; max-width: 320px; padding: 15px; position: relative; }
.modal-close { position: absolute; top: 5px; right: 10px; font-size: 20px; color: #aaa; cursor: pointer; }

/* å¼·åŒ–ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.up-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin: 10px 0; }
.up-btn { display: flex; flex-direction: column; align-items: center; padding: 8px; }
</style>
</head>
<body>

<div class="header-grid">
    <div class="panel">
        <strong><span id="floor">1</span>F</strong> <small>(<span id="holy">0</span>Pt)</small>
        <div style="font-size:10px; color:#a29bfe;">ğŸ¾Lv<span id="petLv">1</span> / <span id="killCount">0/10</span></div>
    </div>
    <div class="menu-btns">
        <button onclick="openModal('upgradeModal')" style="background:#5d5d5d;">âœ¨ è–æ¯å¼·åŒ–</button>
        <button onclick="openModal('casinoModal')" style="background:#5d5d5d;">ğŸ° ã‚«ã‚¸ãƒ</button>
        <button onclick="warpMax()" style="grid-column: span 2">Warp Max</button>
    </div>
</div>

<div class="panel enemy-panel">
    <div style="font-size:11px; font-weight:bold; min-width:45px;" id="enemyName">---</div>
    <div class="hp-bar-outer">
        <div id="enemyHpBar" class="hp-bar-inner"></div>
        <div class="hp-text" id="enemyHpNum">0/0</div>
    </div>
</div>

<div class="main-content">
    <div class="panel party-list" id="partyList"></div>
    <div class="log" id="log"></div>
</div>

<div class="panel action-panel">
    <button onclick="stepDungeon()" style="padding: 12px 0; font-weight: bold; font-size: 14px;">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()" style="padding: 12px 0; font-weight: bold; font-size: 14px;">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<div id="charModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('charModal')">&times;</span>
        <h3 id="m-name" style="margin:0"></h3>
        <hr style="border:0; border-top:1px solid #555;">
        <div id="m-status" style="font-size:13px; line-height:1.6;"></div>
        <div id="m-skill" style="margin-top:10px; color:var(--accent); font-size:12px; font-style:italic;"></div>
        <div style="margin-top:10px; padding:5px; background:rgba(0,0,0,0.3); border-radius:4px; font-size:11px;">
            âš”ï¸ <span id="m-weapon"></span><br>
            ğŸ›¡ï¸ <span id="m-armor"></span>
        </div>
    </div>
</div>

<div id="upgradeModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('upgradeModal')">&times;</span>
        <h3 style="margin:0; text-align:center;">âœ¨ è–æ¯å¼·åŒ–</h3>
        <div style="text-align:center; font-size:11px;">æ‰€æŒPt: <span id="holy2">0</span></div>
        <div style="display:flex; justify-content:center; gap:2px; margin:10px 0;">
            <button id="amt1" onclick="setAmount(1)">x1</button>
            <button id="amt10" onclick="setAmount(10)">x10</button>
            <button id="amtMAX" onclick="setAmount('MAX')">MAX</button>
        </div>
        <div class="up-grid">
            <button class="up-btn" onclick="upgrade('atk')">æ”»æ’ƒ<span>+<span id="b-atk">0</span></span></button>
            <button class="up-btn" onclick="upgrade('def')">é˜²å¾¡<span>+<span id="b-def">0</span></span></button>
            <button class="up-btn" onclick="upgrade('hp')">æœ€å¤§HP<span>+<span id="b-hp">0</span></span></button>
            <button class="up-btn" onclick="upgrade('exp')">çµŒé¨“å€¤<span>+<span id="b-exp">0</span></span></button>
        </div>
        <button id="autoUpBtn" style="width:100%; padding:8px;" onclick="toggleAutoUpgrade()">è‡ªå‹•å¼·åŒ–: OFF</button>
    </div>
</div>

<div id="casinoModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <span class="modal-close" onclick="closeModal('casinoModal')">&times;</span>
        <h3 style="margin:0; color:var(--accent);">è–æ¯ã‚«ã‚¸ãƒ</h3>
        <div id="slot" style="font-size:32px; margin:15px 0; background:#000; border-radius:5px;">â“ â“ â“</div>
        <div id="casinoResult" style="min-height:1.2em; font-size:12px; color:var(--accent);"></div>
        <button onclick="playCasino()" id="spinBtn" style="width:100%; padding:10px; background:#27ae60; font-weight:bold; margin-bottom:5px;">ã‚¹ãƒ”ãƒ³ï¼ (1Pt)</button>
    </div>
</div>

<script>
const SAVE_KEY = "HolyRPG_Persistent_Data_v2.5";
let floor=1, maxReachedFloor=1, loopCount=0, kills=0, holy=0, petLv=1;
let bonus={atk:0, def:0, hp:0, exp:0}, buyAmount=1, autoIsOn=false, autoUpgrade=false, heroUnlocked=false;
let party=[], enemy=null;

const JOB_DATA = {
    "ã›ã‚“ã—": {h:150, a:12, d:12, s:"å¼·æ’ƒ (ãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€)"},
    "ã¨ã†ãã": {h:100, a:11, d:6, s:"æ€¥æ‰€çªã (ãƒ€ãƒ¡ãƒ¼ã‚¸2å€)"},
    "ã¾ã»ã†ã¤ã‹ã„": {h:80, a:22, d:4, s:"ãƒ¡ãƒ†ã‚ª (å…¨ä½“ç‰¹å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸)"},
    "ãã†ã‚Šã‚‡": {h:120, a:8, d:8, s:"ãƒ’ãƒ¼ãƒ« (HPã‚’å°å›å¾©)"},
    "å‹‡è€…": {h:250, a:35, d:20, s:"ã‚®ã‚¬ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ (è¶…çµ¶ãƒ€ãƒ¡ãƒ¼ã‚¸)"}
};

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.alive=true;
        this.weapon={name:"æœ¨ã®æ£’",val:0}; this.armor={name:"å¸ƒã®æœ",val:0};
    }
    updateStats() {
        const j = JOB_DATA[this.job]||JOB_DATA["ã›ã‚“ã—"];
        const awake = 1 + Math.floor(this.level/10)*0.15;
        this.maxHp = Math.floor((j.h + (bonus.hp||0) + (this.level-1)*45) * awake);
        this.atk = Math.floor((j.a + (bonus.atk||0) + (this.level-1)*7 + this.weapon.val) * awake);
        this.def = Math.floor((j.d + (bonus.def||0) + (this.level-1)*5 + this.armor.val) * awake);
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }

function showCharDetail(idx) {
    const c = party[idx];
    const j = JOB_DATA[c.job];
    document.getElementById("m-name").innerHTML = `${c.icon} ${c.name} <span class="job-tag">${c.job}</span>`;
    document.getElementById("m-status").innerHTML = `Lv: ${c.level}<br>HP: ${Math.floor(c.hp)} / ${c.maxHp}<br>æ”»æ’ƒåŠ›: ${c.atk}<br>é˜²å¾¡åŠ›: ${c.def}`;
    document.getElementById("m-skill").innerHTML = `ã‚¹ã‚­ãƒ«: ${j.s}`;
    document.getElementById("m-weapon").innerText = `${c.weapon.name} (+${c.weapon.val})`;
    document.getElementById("m-armor").innerText = `${c.armor.name} (+${c.armor.val})`;
    openModal("charModal");
}

function addLog(t, color="#eee") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    line.style.color = color;
    line.innerText = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 25) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("holy").textContent = holy;
    document.getElementById("holy2").textContent = holy;
    document.getElementById("killCount").textContent = `${kills%10}/10`;
    document.getElementById("petLv").textContent = petLv;
    document.getElementById("b-atk").textContent = bonus.atk;
    document.getElementById("b-def").textContent = bonus.def;
    document.getElementById("b-hp").textContent = bonus.hp;
    document.getElementById("b-exp").textContent = bonus.exp;

    const pEl = document.getElementById("partyList");
    pEl.innerHTML = "";
    party.forEach((c, idx) => {
        c.updateStats();
        const card = document.createElement("div");
        card.className = "char-card " + (c.alive ? "" : "dead");
        card.onclick = () => showCharDetail(idx);
        card.innerHTML = `<div class="char-info"><span>${c.icon}${c.name} <small>Lv${c.level}</small></span><span>HP:${Math.floor(c.hp)}</span></div>
        <div style="font-size:9px; color:#888;">${c.job} / âš”ï¸+${c.weapon.val} ğŸ›¡ï¸+${c.armor.val}</div>`;
        pEl.appendChild(card);
    });
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            
            // ã‚¹ã‚­ãƒ«åˆ¤å®š
            let dmg = Math.max(1, c.atk - enemy.def);
            if(Math.random() < 0.15) {
                const s = { "ã›ã‚“ã—":"å¼·æ’ƒ", "ã¨ã†ãã":"æ€¥æ‰€çªã", "ã¾ã»ã†ã¤ã‹ã„":"ãƒ¡ãƒ†ã‚ª", "ãã†ã‚Šã‚‡":"ãƒ’ãƒ¼ãƒ«", "å‹‡è€…":"ã‚®ã‚¬ã‚¹ãƒ©ãƒƒã‚·ãƒ¥" }[c.job];
                if(c.job === "ãã†ã‚Šã‚‡") {
                    c.hp = Math.min(c.maxHp, c.hp + c.atk);
                    addLog(`ğŸ•Šï¸${s}! HPå›å¾©`, "#2ecc71");
                } else {
                    let mult = (c.job === "å‹‡è€…") ? 3 : 2;
                    dmg *= mult;
                    addLog(`${c.icon}${s}!`, "#3498db");
                }
            }
            enemy.hp -= dmg;

            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); kills++;
                if(kills%10===0) { holy++; if(autoUpgrade) autoDistribute(); }
                if(Math.random()<0.2) dropGear();
                party.forEach(char => {
                    char.exp += 20 * (1+bonus.exp*0.1);
                    if(char.exp >= 50){ char.level++; char.exp=0; char.hp=char.maxHp; }
                });
                if(floor===100 && !heroUnlocked){ heroUnlocked=true; party[0].job="å‹‡è€…"; party[0].icon="ğŸ‘‘"; addLog("ğŸ‘‘å‹‡è€…ãŒç›®è¦šã‚ãŸï¼", "var(--accent)"); }
                floor++; if(floor>maxReachedFloor) maxReachedFloor=floor;
                enemy=null; save(); if(autoIsOn) setTimeout(stepDungeon, 50);
                updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t){ clearInterval(it); floor=Math.max(1, floor-5); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0) t.alive=false;
        }
        document.getElementById("enemyName").textContent = enemy?enemy.name:"---";
        document.getElementById("enemyHpNum").textContent = enemy?Math.floor(enemy.hp):"0";
        document.getElementById("enemyHpBar").style.width = enemy?(enemy.hp/enemy.maxHp*100)+"%":"0%";
        updateUI();
    }, 50);
}

// ä»¥ä¸‹ã€ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã‚«ã‚¸ãƒã€å¼·åŒ–ã€æ¢ç´¢ã€ã‚»ãƒ¼ãƒ–ã€ãƒ­ãƒ¼ãƒ‰ï¼‰ã¯å…±é€šã§ã™ãŒã€UIã«åˆã‚ã›ã¦å¾®èª¿æ•´
function stepDungeon() {
    if(enemy) return;
    const p = (1 + floor/100);
    enemy = { name: (floor%10===0?"BOSS":"MON"), maxHp:(200+floor*60)*p, hp:0, atk:(15+floor*7)*p, def:(10+floor*4)*p };
    enemy.hp = enemy.maxHp;
    battleLoop();
}
function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function setAmount(a) { buyAmount = a; ["amt1", "amt10", "amtMAX"].forEach(id => document.getElementById(id).classList.toggle("active", id.includes(a))); }
function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost; bonus[t] += (t==='hp'?cost*50:cost*5); updateUI(); save();
}
function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : ""; }
function autoDistribute() { upgrade(['atk','def','hp','exp'][Math.floor(Math.random()*4)]); }
function warpMax() { if(!enemy){ floor = maxReachedFloor; updateUI(); }}

function dropGear() {
    const target = party[Math.floor(Math.random()*party.length)];
    const isWep = Math.random() > 0.5;
    const val = Math.floor(floor * 1.5);
    if(isWep && val > target.weapon.val) { target.weapon = { name: "é‹¼ã®å‰£", val: val }; addLog(`ğŸ${target.name} æ­¦å™¨æ›´æ–°`, "#f39c12"); }
    else if(!isWep && val > target.armor.val) { target.armor = { name: "é‹¼ã®é§", val: val }; addLog(`ğŸ${target.name} é˜²å…·æ›´æ–°`, "#f39c12"); }
}

function playCasino() {
    if(holy < 1) return;
    holy--; updateUI();
    const slot = document.getElementById("slot");
    const spinBtn = document.getElementById("spinBtn");
    spinBtn.disabled = true;
    let timer = 0;
    const interval = setInterval(() => {
        const items = ["ğŸ’","âš”ï¸","ğŸ€","â­","ğŸ"];
        slot.innerText = items[Math.floor(Math.random()*5)] + " " + items[Math.floor(Math.random()*5)] + " " + items[Math.floor(Math.random()*5)];
        if(++timer > 10) {
            clearInterval(interval);
            if(Math.random() < 0.1) { holy += 10; document.getElementById("casinoResult").innerText = "å¤§å½“ã‚Šï¼Pt+10"; }
            else { bonus.atk += 10; document.getElementById("casinoResult").innerText = "æ”»æ’ƒåŠ›+10"; }
            spinBtn.disabled = false; updateUI(); save();
        }
    }, 100);
}

function save() {
    const data = { floor, maxReachedFloor, holy, bonus, petLv, heroUnlocked, party: party.map(c => ({
        name:c.name, job:c.job, icon:c.icon, level:c.level, hp:c.hp, weapon:c.weapon, armor:c.armor
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}
function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        const d = JSON.parse(saved);
        floor=d.floor; maxReachedFloor=d.maxReachedFloor; holy=d.holy; bonus=d.bonus; petLv=d.petLv||1; heroUnlocked=d.heroUnlocked;
        party = d.party.map(p => { 
            let c=new Character(p.name, p.job, p.icon); c.level=p.level; c.hp=p.hp; 
            c.weapon=p.weapon; c.armor=p.armor; return c; 
        });
    } else {
        party = [new Character("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Character("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Character("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Character("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
    }
}
load(); updateUI();
</script>
</body>
</html>
