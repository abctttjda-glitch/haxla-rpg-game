<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Slayer's Log v3.8.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #222; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:4px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:2px; cursor:pointer; padding:6px; font-size:11px; }
button:disabled { opacity: 0.2; }

/* ä¸Šéƒ¨ï¼šæ•µæƒ…å ±ï¼ˆæœ€å°é™ï¼‰ */
.enemy-box { background:var(--panel); border:1px solid var(--border); padding:4px; height: 40px; display:flex; flex-direction:column; justify-content:center; }
.hp-bar { width: 100%; background:#200; height:6px; margin-top:2px; border:1px solid #400; }
.hp-fill { background:#800; height:100%; width:100%; transition: width 0.1s; }

/* ä¸­å¤®ï¼šãƒ¡ã‚¤ãƒ³ãƒ­ã‚° */
.log-container { flex: 1; background:#000; border:1px solid var(--border); margin:4px 0; overflow-y:auto; padding:4px; font-size:11px; line-height:1.3; display:flex; flex-direction:column-reverse; }
.log-entry { margin-bottom: 2px; border-bottom: 1px solid #111; }
.log-win { color: #f1c40f; font-weight:bold; }
.log-die { color: #e74c3c; }
.log-get { color: #2ecc71; }

/* ä¸‹éƒ¨ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ & æ“ä½œ */
.status-bar { background:var(--panel); padding:6px; border:1px solid var(--border); font-size:12px; display:grid; grid-template-columns: 1.2fr 1fr; gap:4px; }
.btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 4px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:90%; padding:15px; overflow-y:auto; }
.tree-node { border:1px solid #333; padding:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
.item-card { border:1px solid #333; padding:8px; margin-bottom:8px; background:#0a0a0a; }
</style>
</head>
<body>

<div class="enemy-box">
    <div style="display:flex; justify-content:space-between; font-size:11px;">
        <span id="eName">WAITING...</span><span id="eHpNum"></span>
    </div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
</div>

<div class="log-container" id="log"></div>

<div class="status-bar">
    <div>
        <b>Lv.<span id="hLv">1</span> <span id="hHp">0/0</span></b><br>
        ATK:<span id="hAtk">0</span> DEF:<span id="hDef">0</span>
    </div>
    <div style="text-align:right; font-size:10px;">
        è–æ¯:<span id="hPt">0</span> SP:<span id="hSp">0</span><br>
        <span id="dName">---</span> (<span id="dStep">0</span>/10)
    </div>
</div>

<div class="btn-grid">
    <button onclick="openM('questM')">ä¾é ¼æ¿</button>
    <button onclick="openM('skillM')">ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">è£…å‚™å“</button>
    <button onclick="openM('holyM')">è–æ¯</button>
</div>

<div id="questM" class="modal"><div class="modal-content"><h3>âš”ï¸ ä¾é ¼æ¿</h3><div id="qList"></div><br><button onclick="closeM('questM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ (SP:<span id="mSp">0</span>)</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3><div id="iList"></div><br><button onclick="closeM('equipM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<div id="holyM" class="modal"><div class="modal-content"><h3>âœ¨ è–æ¯å¼·åŒ– (Pt:<span id="mPt">0</span>)</h3><div id="hRows"></div><br><button onclick="closeM('holyM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<script>
const SAVE_KEY = "SlayerLog_v3.8";
let holy=0, sp=0, step=0, dungeonIdx=0, inBattle=false;
let hero = { lv:1, exp:0, hp:100, maxHp:100, atk:10, def:10, eq:{w:null, a:null, r:null} };
let bonus = { atk:0, def:0, hp:0 };
let inventory = [], skills = {};

const DUNGEONS = [
    { n: "å¿˜ã‚Œã‚‰ã‚ŒãŸåœ°ä¸‹é“", pow: 1, boss: "å¤§èœ˜è››" },
    { n: "å‡ã¦ã¤ãå»ƒæ‘", pow: 10, boss: "é›ªå¥³" },
    { n: "ç„¦ç†±ã®ç«å±±çªŸ", pow: 50, boss: "å¤ä»£é¾" },
    { n: "æ¬¡å…ƒã®ç‹­é–“", pow: 200, boss: "è™šç„¡ã®ç‹" }
];

const SKILL_DATA = [
    { id:"s1", n:"ç­‹åŠ›å¢—å¼·", d:"ATK+50", sp:1, effect:{atk:50} },
    { id:"s2", n:"é˜²è¡›æœ¬èƒ½", d:"DEF+50", sp:1, effect:{def:50} },
    { id:"s3", n:"ç”Ÿå‘½ã®æº", d:"HP+500", sp:1, effect:{hp:500} },
    { id:"s4", n:"æš—æ®ºè€…ã®ç›®", d:"10%ã§ãƒ€ãƒ¡ãƒ¼ã‚¸3å€", sp:2, effect:{crit:0.1} },
    { id:"s5", n:"é¨å£«ã®çŸœæŒ", d:"DEF+200, HP+1000", sp:3, effect:{def:200, hp:1000} },
    { id:"s6", n:"è³¢è€…ã®çŸ¥æµ", d:"ç²å¾—EXP 1.5å€", sp:2, effect:{exp:1.5} }
];

function updateUI() {
    let sA=0, sD=0, sH=0;
    Object.keys(skills).forEach(id => {
        const s = SKILL_DATA.find(x=>x.id===id);
        if(s.effect.atk) sA += s.effect.atk;
        if(s.effect.def) sD += s.effect.def;
        if(s.effect.hp) sH += s.effect.hp;
    });
    // è£…å‚™è£œæ­£
    let eA=0, eD=0, eH=0;
    ['w','a','r'].forEach(t => { if(hero.eq[t]) { eA += hero.eq[t].atk; eD += hero.eq[t].def; eH += hero.eq[t].hp; } });

    const g = 1 + (hero.lv - 1) * 0.05;
    hero.maxHp = Math.floor((200 + bonus.hp*100 + sH + eH + (hero.lv-1)*50) * g);
    hero.atk = Math.floor((20 + bonus.atk*20 + sA + eA + (hero.lv-1)*8) * g);
    hero.def = Math.floor((15 + bonus.def*15 + sD + eD + (hero.lv-1)*6) * g);

    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hPt").innerText = holy;
    document.getElementById("mPt").innerText = holy;
    document.getElementById("hSp").innerText = sp;
    document.getElementById("mSp").innerText = sp;
    document.getElementById("dStep").innerText = step;
}

function addLog(msg, type="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    d.className = "log-entry " + type;
    d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 50) l.removeChild(l.lastChild);
}

function startDungeon(idx) {
    dungeonIdx = idx; step = 0; closeM('questM');
    document.getElementById("dName").innerText = DUNGEONS[idx].n;
    addLog(`>> ${DUNGEONS[idx].n} ã®èª¿æŸ»ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚`);
    nextBattle();
}

function nextBattle() {
    if(inBattle) return;
    step++;
    if(step > 10) {
        addLog(`>> ä¾é ¼é”æˆã€‚è–æ¯Pt+5ç²å¾—ã€‚`, "log-win");
        holy += 5; step = 1; save();
    }
    const isB = (step === 10);
    const p = DUNGEONS[dungeonIdx].pow * (isB ? 5 : 1);
    const enemy = {
        name: isB ? `ã€BOSSã€‘${DUNGEONS[dungeonIdx].boss}` : `é­”ç‰© (RANK ${step})`,
        hp: (100 + hero.lv * 100) * p,
        atk: (10 + hero.lv * 10) * p,
        maxHp: 0
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    runBattle(enemy, isB);
}

function runBattle(e, isB) {
    inBattle = true;
    const it = setInterval(() => {
        let d = Math.max(1, hero.atk - (e.atk*0.1));
        if(skills.s4 && Math.random()<0.1) d *= 3;
        e.hp -= d;

        if(e.hp <= 0) {
            clearInterval(it);
            addLog(`${e.name} ã‚’æ’ƒç ´ã€‚`);
            let expGain = 40; if(skills.s6) expGain *= 1.5;
            hero.exp += expGain;
            if(hero.exp >= 100) { hero.lv++; hero.exp=0; sp++; addLog(`LvUP! å‹‡è€…ã®ãƒ¬ãƒ™ãƒ«ã¯ ${hero.lv} ã«ãªã£ãŸã€‚`, "log-win"); }
            if(isB) dropItem(DUNGEONS[dungeonIdx].pow);
            inBattle = false; save(); updateUI();
            setTimeout(nextBattle, 500);
        } else {
            hero.hp -= Math.max(1, e.atk - hero.def);
            document.getElementById("eHpFill").style.width = (e.hp/e.maxHp*100) + "%";
            document.getElementById("eHpNum").innerText = Math.floor(e.hp);
            updateUI();
            if(hero.hp <= 0) {
                clearInterval(it);
                addLog(`å‹‡è€…ã¯å€’ã‚ŒãŸ... å³åº§ã«å†æˆ¦ã‚’é–‹å§‹ã€‚`, "log-die");
                hero.hp = hero.maxHp; inBattle = false;
                setTimeout(nextBattle, 500);
            }
        }
    }, 100);
}

function dropItem(pow) {
    const types = [{t:'w',n:'å‰£'}, {t:'a',n:'é§'}, {t:'r',n:'æŒ‡è¼ª'}];
    const type = types[Math.floor(Math.random()*3)];
    const rarity = ["å¤ã³ãŸ", "é‹¼ã®", "é­”åŠ›ã®", "å¹»æƒ³ã®", "ç¥è©±ã®"][Math.min(4, Math.floor(Math.random()*pow))];
    const item = {
        id: Date.now(), type: type.t, 
        name: `${rarity}${type.n}`,
        atk: type.t === 'w' ? pow*50 : 0,
        def: type.t === 'a' ? pow*40 : 0,
        hp: type.t === 'r' ? pow*500 : 0
    };
    inventory.push(item);
    addLog(`>> å®ç®±ã‹ã‚‰ã€Œ${item.name}ã€ã‚’å…¥æ‰‹ï¼`, "log-get");
}

function openM(id) {
    document.getElementById(id).style.display = "flex";
    if(id==='qList') renderQuests();
    if(id==='sList') renderSkills();
    if(id==='iList') renderInventory();
    if(id==='hRows') renderHoly();
}

function renderQuests() {
    const d = document.getElementById("qList"); d.innerHTML = "";
    DUNGEONS.forEach((q, i) => {
        const b = document.createElement("button"); b.style.width="100%"; b.style.marginBottom="5px";
        b.innerText = `${q.n} (æ¨å¥¨Lv.${i*15})`; b.onclick = () => startDungeon(i);
        d.appendChild(b);
    });
}

function renderSkills() {
    const d = document.getElementById("sList"); d.innerHTML = "";
    SKILL_DATA.forEach(s => {
        const has = skills[s.id];
        d.innerHTML += `<div class="tree-node"><div><b>${s.n}</b><br><small>${s.d}</small></div>
            <button onclick="buyS('${s.id}',${s.sp})" ${has||sp<s.sp?'disabled':''}>${has?'ç¿’å¾—æ¸ˆ':'ç¿’å¾—'}</button></div>`;
    });
}

function renderInventory() {
    const d = document.getElementById("iList"); d.innerHTML = "";
    inventory.forEach(item => {
        const isEq = Object.values(hero.eq).some(e => e && e.id === item.id);
        d.innerHTML += `<div class="item-card"><b>${item.name}</b> [${item.type==='w'?'æ­¦':item.type==='a'?'é˜²':'é£¾'}]<br>
            <small>ATK:${item.atk} DEF:${item.def} HP:${item.hp}</small><br>
            <button onclick="equipI(${item.id})" ${isEq?'disabled':''}>${isEq?'è£…å‚™ä¸­':'è£…å‚™ã™ã‚‹'}</button>
            <button onclick="sellI(${item.id})">å£²å´</button></div>`;
    });
}

function renderHoly() {
    const d = document.getElementById("hRows"); d.innerHTML = "";
    [{k:'atk',n:'æ”»æ’ƒ(+20)'},{k:'def',n:'é˜²å¾¡(+15)'},{k:'hp',n:'ä½“åŠ›(+100)'}].forEach(s => {
        d.innerHTML += `<div class="tree-node"><span>${s.n}: ${bonus[s.k]}</span><button onclick="buyH('${s.k}')">å¼·åŒ–</button></div>`;
    });
}

function buyS(id, c) { if(sp >= c) { sp -= c; skills[id] = true; openM('skillM'); updateUI(); save(); } }
function buyH(k) { if(holy >= 1) { holy -= 1; bonus[k]++; updateUI(); save(); openM('hRows'); } }
function equipI(id) { 
    const item = inventory.find(i => i.id === id);
    hero.eq[item.type] = item; updateUI(); openM('iList'); save();
}
function sellI(id) {
    inventory = inventory.filter(i => i.id !== id);
    Object.keys(hero.eq).forEach(k => { if(hero.eq[k] && hero.eq[k].id === id) hero.eq[k] = null; });
    holy += 1; updateUI(); openM('iList'); save();
}
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() {
    const d = { h:hero, b:bonus, s:skills, i:inventory, holy, sp, dIdx:dungeonIdx };
    localStorage.setItem(SAVE_KEY, JSON.stringify(d));
}
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) {
        const d = JSON.parse(s); hero=d.h; bonus=d.b; skills=d.s; inventory=d.i; holy=d.holy; sp=d.sp; dungeonIdx=d.dIdx;
    }
    hero.hp = hero.maxHp;
}
load(); updateUI(); startDungeon(dungeonIdx);
</script>
</body>
</html>
