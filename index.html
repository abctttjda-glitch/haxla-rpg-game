<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v2.0.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
:root { --main-bg: #111; --panel-bg: #1e1e1e; --accent: #f1c40f; --text: #eee; }
body { margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:18px; padding:4px; height:100vh; overflow:hidden; display:flex; flex-direction:column; }
.panel { background:var(--panel-bg); border:1px solid #444; border-radius:8px; padding:6px; margin-bottom:4px; }
button { background:#333; color:#eee; border:1px solid #555; border-radius:6px; font-size:18px; padding:8px 0; cursor:pointer; }
.active { background:var(--accent) !important; color:#000 !important; font-weight:bold; }
.toggleOn { background:#2ecc71; color:#000; font-weight:bold; }

/* éšå±¤ãƒ»ãƒšãƒƒãƒˆãƒ»ã‚«ã‚¸ãƒ */
.top-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 4px; }
.pet-box { font-size: 14px; color: #a29bfe; }

/* ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ»æ•µ */
.unit-box { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; flex-grow: 1; }
.char-row { font-size: 16px; border-bottom: 1px solid #333; padding: 2px 0; }
.hp-bar-container { background:#333; height:12px; border-radius:6px; overflow:hidden; position:relative; margin-top:2px; }
.hp-bar { background:#e74c3c; height:100%; width:100%; transition: width 0.2s; }
.hp-text { position:absolute; width:100%; text-align:center; font-size:11px; font-weight:bold; color:#fff; top:-1px; }

/* ãƒ­ã‚°ï¼ˆå¤§ããã€ã‹ã¤ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ï¼‰ */
.log { flex-grow: 2; font-size: 16px; background:#000; padding:4px; overflow-y:auto; display:flex; flex-direction:column-reverse; border:1px solid #444; border-radius:4px; min-height: 80px; }
.skill-flash { color: #3498db; font-weight: bold; animation: pulse 0.3s; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

/* æ“ä½œç³» */
.control-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: auto; }
.stat-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin: 4px 0; }
.stat-btns button { font-size: 14px; padding: 10px 0; }
</style>
</head>
<body id="body">

<div class="top-grid">
    <div class="panel">
        <strong><span id="floor">1</span>F</strong> <small>(<span id="holy">0</span>Pt)</small>
        <div class="pet-box">ğŸ¾<span id="petName">ãƒãƒ</span> Lv<span id="petLv">1</span></div>
    </div>
    <div class="panel" style="text-align:center">
        <button onclick="playCasino()" style="width:100%; padding:2px; font-size:14px;">ğŸ°ã‚«ã‚¸ãƒ(1Pt)</button>
        <small id="killCount" style="font-size:12px">0/10</small>
    </div>
</div>

<div class="panel">
    <div style="display:flex; justify-content:space-between; font-size:14px;">
        <strong>æ•µ: <span id="enemyName">---</span></strong>
        <span id="enemyHpNum">0/0</span>
    </div>
    <div class="hp-bar-container"><div id="enemyHpBar" class="hp-bar"></div></div>
</div>

<div class="unit-box">
    <div class="panel" id="partyList"></div>
    <div class="log" id="log"></div>
</div>

<div class="panel" style="margin-bottom:0">
    <div style="display:flex; gap:4px; margin-bottom:4px;">
        <button id="amt1" style="flex:1; font-size:12px;" onclick="setAmount(1)">x1</button>
        <button id="amt10" style="flex:1; font-size:12px;" onclick="setAmount(10)">x10</button>
        <button id="amtMAX" style="flex:1; font-size:12px;" onclick="setAmount('MAX')">MAX</button>
        <button id="autoUpBtn" style="flex:1.5; font-size:12px;" onclick="toggleAutoUpgrade()">è‡ªå‹•:OFF</button>
    </div>
    <div class="stat-btns">
        <button onclick="upgrade('atk')">æ”»<br>+<span id="b-atk">0</span></button>
        <button onclick="upgrade('def')">é˜²<br>+<span id="b-def">0</span></button>
        <button onclick="upgrade('hp')">å‘½<br>+<span id="b-hp">0</span></button>
        <button onclick="upgrade('exp')">çµŒ<br>+<span id="b-exp">0</span></button>
    </div>
</div>

<div class="control-grid">
    <button onclick="stepDungeon()" style="grid-column: span 1">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()" style="grid-column: span 2">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
    <button onclick="warpMax()" style="grid-column: span 1">Warp</button>
</div>

<script>
const SAVE_KEY = "HolyRPG_Persistent_Data";
let floor=1, maxReachedFloor=1, loopCount=0, kills=0, holy=0, petLv=1;
let bonus={atk:0, def:0, hp:0, exp:0}, artifacts=[];
let buyAmount=1, autoIsOn=false, autoUpgrade=false, heroUnlocked=false;
let party=[], enemy=null;

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.alive=true;
    }
    updateStats() {
        const j = {"ã›ã‚“ã—":{h:150,a:12,d:12},"ã¨ã†ãã":{h:100,a:11,d:6},"ã¾ã»ã†ã¤ã‹ã„":{h:80,a:22,d:4},"ãã†ã‚Šã‚‡":{h:120,a:8,d:8},"å‹‡è€…":{h:250,a:35,d:20}}[this.job];
        const awake = 1 + Math.floor(this.level/10)*0.15;
        const art = 1 + (artifacts.length * 0.1);
        this.maxHp = Math.floor((j.h + (bonus.hp||0) + (this.level-1)*45) * awake * art);
        this.atk = Math.floor((j.a + (bonus.atk||0) + (this.level-1)*7) * awake * art);
        this.def = Math.floor((j.d + (bonus.def||0) + (this.level-1)*5) * awake * art);
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function addLog(t, cls="") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    if(cls) line.innerHTML = `<span class="${cls}">${t}</span>`;
    else line.innerText = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 15) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("holy").textContent = holy;
    document.getElementById("killCount").textContent = `${kills%10}/10`;
    document.getElementById("petLv").textContent = petLv;
    document.getElementById("b-atk").textContent = bonus.atk;
    document.getElementById("b-def").textContent = bonus.def;
    document.getElementById("b-hp").textContent = bonus.hp;
    document.getElementById("b-exp").textContent = bonus.exp;

    const pEl = document.getElementById("partyList");
    pEl.innerHTML = "";
    party.forEach(c => {
        c.updateStats();
        const row = document.createElement("div");
        row.className = "char-row " + (c.alive ? "" : "dead");
        row.innerHTML = `<div>${c.icon}${c.name.charAt(0)} Lv${c.level}</div>
            <div class="hp-bar-container"><div class="hp-bar" style="width:${(c.hp/c.maxHp)*100}%"></div>
            <div class="hp-text">${Math.floor(c.hp)}</div></div>`;
        pEl.appendChild(row);
    });
}

function playCasino() {
    if(holy < 1) return addLog("Ptä¸è¶³ï¼");
    holy--;
    const r = Math.random();
    if(r < 0.1) { holy += 10; addLog("ğŸ°ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆï¼+10Pt", "active"); }
    else if(r < 0.4) { bonus.atk += 10; bonus.def += 10; addLog("ğŸ°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹UPï¼"); }
    else { addLog("ğŸ°ãƒã‚ºãƒ¬..."); }
    updateUI(); save();
}

function stepDungeon() {
    if(enemy) return;
    const p = (1 + loopCount + floor/100);
    enemy = { name: (floor%10===0?"BOSS":"MON"), maxHp:(200+floor*50)*p, hp:0, atk:(15+floor*5)*p, def:(10+floor*3)*p };
    enemy.hp = enemy.maxHp;
    battleLoop();
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            // ãƒšãƒƒãƒˆã®è¿½æ’ƒ
            if(Math.random() < 0.1) { enemy.hp -= (petLv * 10); addLog("ğŸ¾ãƒšãƒƒãƒˆã®è¿½æ’ƒ!", "skill-flash"); }
            
            let dmg = Math.max(1, c.atk - enemy.def);
            if(Math.random() < 0.2) { dmg *= 2; addLog(`${c.icon}ã‚¹ã‚­ãƒ«!`, "skill-flash"); }
            enemy.hp -= dmg;

            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); kills++;
                if(kills%10===0){ holy++; if(autoUpgrade) autoDistribute(); }
                if(kills%50===0){ petLv++; addLog("ğŸ¾ãƒšãƒƒãƒˆãŒæˆé•·ï¼"); }
                party.forEach(char => {
                    char.exp += 20 * (1 + bonus.exp*0.1);
                    if(char.exp >= 50){ char.level++; char.exp=0; char.hp=char.maxHp; }
                });
                if(floor === 100 && !heroUnlocked) { heroUnlocked=true; party[0].job="å‹‡è€…"; party[0].icon="ğŸ‘‘"; }
                if(floor >= 1000){ floor=1; loopCount++; } else { floor++; }
                if(floor > maxReachedFloor) maxReachedFloor = floor;
                enemy = null; save(); if(autoIsOn) setTimeout(stepDungeon, 50);
                updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t) { clearInterval(it); floor = Math.max(1, floor-10); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); save(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0){ t.hp=0; t.alive=false; }
        }
        document.getElementById("enemyName").textContent = enemy?enemy.name:"---";
        document.getElementById("enemyHpNum").textContent = enemy?Math.floor(enemy.hp):"0";
        document.getElementById("enemyHpBar").style.width = enemy?(enemy.hp/enemy.maxHp*100)+"%":"0%";
        updateUI();
    }, 1000 / 20);
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function setAmount(a) { buyAmount = a; ["amt1", "amt10", "amtMAX"].forEach(id => document.getElementById(id).classList.toggle("active", id.includes(a))); }
function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost;
    bonus[t] += (t==='hp'?cost*50:cost*5);
    updateUI(); save();
}
function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : ""; }
function autoDistribute() { upgrade(['atk','def','hp','exp'][Math.floor(Math.random()*4)]); }
function warpMax() { if(!enemy){ floor = maxReachedFloor; addLog(floor+"Fã¸ç§»å‹•"); updateUI(); }}

function save() {
    const data = { floor, maxReachedFloor, loopCount, kills, holy, bonus, petLv, heroUnlocked, party: party.map(c => ({
        name:c.name, job:c.job, icon:c.icon, level:c.level, hp:c.hp
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}
function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        const d = JSON.parse(saved);
        floor=d.floor; maxReachedFloor=d.maxReachedFloor; loopCount=d.loopCount; kills=d.kills; holy=d.holy; bonus=d.bonus; petLv=d.petLv||1; heroUnlocked=d.heroUnlocked;
        party = d.party.map(p => { let c=new Character(p.name, p.job, p.icon); c.level=p.level; c.hp=p.hp; return c; });
    } else {
        party = [new Character("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Character("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Character("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Character("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
    }
}
load(); updateUI();
</script>
</body>
</html>
