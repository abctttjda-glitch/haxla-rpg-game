<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v1.3.0</title>
<style>
body{ margin:0; background:#111; color:#eee; font-family:sans-serif; font-size:16px; padding:6px; }
.version { position: absolute; top: 5px; right: 10px; font-size: 12px; color: #666; }
h2{margin:4px 0;font-size:22px; color:#f1c40f;}
.panel{ background:#1a1a1a; border:1px solid #444; border-radius:6px; padding:8px; margin-bottom:8px; }
button{ width:100%; background:#333; color:#eee; border:1px solid #555; border-radius:6px; font-size:18px; padding:8px 0; margin-top:4px; cursor: pointer; }
.toggleOn{background:#2ecc71;color:#000;font-weight:bold;}
.dead{opacity:0.4; filter: grayscale(100%);}
.partyRow{ font-size:15px; margin:8px 0; border-bottom: 1px solid #333; padding-bottom: 4px; }
.barWrap{ background:#333; height:8px; border-radius:4px; overflow:hidden; margin-top:4px; }
.bar{background:#e74c3c; height:100%; transition: width 0.2s;}
.log{ font-size:15px; height:150px; overflow-y:auto; background: #000; padding: 5px; display: flex; flex-direction: column-reverse; }
.drop-text { color: #f39c12; font-weight: bold; }
.warp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 5px; }
.warp-btn { font-size: 14px; padding: 5px 0; }
</style>
</head>
<body>

<div class="version">Version 1.3.0</div>
<h2>è–æ¯ã‚ªãƒ¼ãƒˆRPG</h2>

<div class="panel">
    <strong>éšå±¤: <span id="floor">1</span> / 100</strong> (å‘¨å›: <span id="loopCount">0</span>)<br>
    æ’ƒç ´: <span id="kills">0</span>ã€€è–æ¯Pt: <span id="holy">0</span>
    <div class="warp-grid" id="warpContainer"></div>
</div>

<div class="panel">
    <strong>æ•µ: <span id="enemyName"></span></strong>
    <div id="enemyText" style="font-size:12px"></div>
    <div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div class="panel">
    <strong>ãƒ‘ãƒ¼ãƒ†ã‚£ (è£…å‚™)</strong>
    <div id="party"></div>
</div>

<div class="panel">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
        <button onclick="upgrade('atk')">ATK+</button>
        <button onclick="upgrade('def')">DEF+</button>
        <button onclick="upgrade('hp')">HP+</button>
        <button onclick="upgrade('exp')">EXP+</button>
    </div>
    <button id="autoBtn" onclick="toggleAutoUpgrade()">è‡ªå‹•æŒ¯ã‚Š OFF</button>
</div>

<div class="panel log" id="log"></div>

<div class="panel" style="display:flex; gap:10px;">
    <button onclick="stepDungeon()" style="flex:1">é€²ã‚€</button>
    <button id="mainAutoBtn" onclick="toggleAuto()" style="flex:1">ã‚ªãƒ¼ãƒˆ</button>
</div>

<script>
const SPEED = 8;
let floor = 1;
let maxReachedFloor = 1;
let loopCount = 0;
let kills = 0;
let holy = 0;
let bonus = {atk:0, def:0, hp:0, exp:0};
let autoUpgrade = false;
let autoIsOn = false;
let party = [];
let enemy = null;

const CHAR_DATA = [
    {name:"ãƒ¬ã‚ªãƒ³", job:"ã›ã‚“ã—", icon:"âš”ï¸"},
    {name:"ãƒŸãƒ©", job:"ã¨ã†ãã", icon:"ğŸ—¡ï¸"},
    {name:"ã‚¢ãƒ¼ã‚¯", job:"ã¾ã»ã†ã¤ã‹ã„", icon:"ğŸª„"},
    {name:"ã‚»ãƒ©", job:"ãã†ã‚Šã‚‡", icon:"ğŸ•Šï¸"}
];

const JOBS = {
    "ã›ã‚“ã—": { hp:140, atk:12, def:10 },
    "ã¨ã†ãã": { hp:100, atk:10, def:5 },
    "ã¾ã»ã†ã¤ã‹ã„": { hp:80, atk:18, def:3 },
    "ãã†ã‚Šã‚‡": { hp:110, atk:8, def:6 }
};

class Character {
    constructor(d, bonus) {
        const j = JOBS[d.job];
        this.name = d.name; this.job = d.job; this.icon = d.icon;
        this.level = 1; this.exp = 0;
        this.maxHp = j.hp + bonus.hp; this.atk = j.atk + bonus.atk; this.def = j.def + bonus.def;
        this.hp = this.maxHp; this.alive = true;
        this.eqAtk = 0; this.eqDef = 0; // è£…å‚™è£œæ­£
    }
}

function addLog(t, colorClass="") {
    const logBox = document.getElementById("log");
    const line = document.createElement("div");
    line.className = colorClass;
    line.innerHTML = t;
    logBox.appendChild(line);
    if(logBox.childNodes.length > 20) logBox.removeChild(logBox.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("loopCount").textContent = loopCount;
    document.getElementById("kills").textContent = kills;
    document.getElementById("holy").textContent = holy;
    
    const pEl = document.getElementById("party");
    pEl.innerHTML = "";
    party.forEach(c => {
        const row = document.createElement("div");
        row.className = "partyRow " + (c.alive ? "" : "dead");
        const hpPer = (c.hp / c.maxHp) * 100;
        row.innerHTML = `
            <div>${c.icon}${c.name} Lv${c.level} <span style="font-size:11px; color:#aaa;">(âš”ï¸+${c.eqAtk} ğŸ›¡ï¸+${c.eqDef})</span></div>
            <div class="barWrap"><div class="bar" style="width:${hpPer}%"></div></div>`;
        pEl.appendChild(row);
    });
    updateWarpButtons();
}

function updateWarpButtons() {
    const container = document.getElementById("warpContainer");
    container.innerHTML = "";
    for(let i=1; i<=maxReachedFloor; i+=10) {
        const b = document.createElement("button");
        b.className = "warp-btn";
        b.textContent = i + "F";
        b.onclick = () => { if(!enemy){ floor = i; addLog(i + "å±¤ã¸ãƒ¯ãƒ¼ãƒ—ã—ã¾ã—ãŸ"); updateUI(); }};
        container.appendChild(b);
    }
}

function dropEquipment() {
    if(Math.random() > 0.3) return; // 30%ã§ãƒ‰ãƒ­ãƒƒãƒ—
    const target = party[Math.floor(Math.random()*party.length)];
    const isWeapon = Math.random() > 0.5;
    const val = Math.floor(Math.random() * (floor + loopCount * 10)) + 1;

    if(isWeapon) {
        if(val > target.eqAtk) {
            target.eqAtk = val;
            addLog(`${target.name}ãŒæ–°ã—ã„æ­¦å™¨(ATK+${val})ã‚’æ‹¾ã£ãŸï¼`, "drop-text");
        }
    } else {
        if(val > target.eqDef) {
            target.eqDef = val;
            addLog(`${target.name}ãŒæ–°ã—ã„é˜²å…·(DEF+${val})ã‚’æ‹¾ã£ãŸï¼`, "drop-text");
        }
    }
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }

        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            let dmg = Math.max(1, (c.atk + c.eqAtk) - enemy.def);
            enemy.hp -= dmg;
            if(enemy.hp <= 0) {
                enemy.hp = 0;
                addLog(`${enemy.name}ã‚’å€’ã—ãŸï¼`);
                kills++;
                dropEquipment();
                
                // éšå±¤é€²è¡Œã¨ãƒ«ãƒ¼ãƒ—å‡¦ç†
                if(floor >= 100) {
                    floor = 1; loopCount++;
                    addLog("--- 100å±¤çªç ´ï¼1å±¤ã‹ã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆ ---", "drop-text");
                } else {
                    floor++;
                }
                if(floor > maxReachedFloor) maxReachedFloor = floor;

                clearInterval(it);
                enemy = null;
                if(autoIsOn) setTimeout(stepDungeon, 400);
                updateUI();
            }
        });

        if(enemy) {
            const target = party.find(c => c.alive);
            if(!target) {
                clearInterval(it);
                addLog("å…¨æ»…...");
                party.forEach(c => { c.hp = c.maxHp; c.alive = true; });
                enemy = null;
                if(autoIsOn) setTimeout(stepDungeon, 1000);
                updateUI();
                return;
            }
            let eDmg = Math.max(1, enemy.atk - (target.def + target.eqDef));
            target.hp -= eDmg;
            if(target.hp <= 0) { target.hp = 0; target.alive = false; }
        }
        updateUI();
        if(enemy) {
            document.getElementById("enemyName").textContent = enemy.name;
            document.getElementById("enemyText").textContent = `HP: ${Math.floor(enemy.hp)}`;
            document.getElementById("enemyHpBar").style.width = (enemy.hp/enemy.maxHp*100) + "%";
        }
    }, 800 / SPEED);
}

function stepDungeon() {
    if(enemy) return;
    const isBoss = floor % 10 === 0;
    enemy = {
        name: isBoss ? "ğŸ‘¹BOSS" : "ğŸ‘¾MONSTER",
        maxHp: (50 + floor * 20) * (1 + loopCount),
        hp: (50 + floor * 20) * (1 + loopCount),
        atk: (5 + floor * 2) * (1 + loopCount * 0.5),
        def: (2 + floor) * (1 + loopCount * 0.5)
    };
    battleLoop();
}

function toggleAuto() {
    autoIsOn = !autoIsOn;
    document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : "";
    if(autoIsOn) stepDungeon();
}

function upgrade(t) { if(holy<=0)return; holy--; bonus[t]+=(t==="hp"?20:3); updateUI(); }
function toggleAutoUpgrade() { autoUpgrade=!autoUpgrade; document.getElementById("autoBtn").className=autoUpgrade?"toggleOn":""; }

// åˆæœŸåŒ–
party = CHAR_DATA.map(d => new Character(d, bonus));
updateUI();
</script>
</body>
</html>
