<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Slayer's Log v3.9.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #222; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:4px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:2px; cursor:pointer; padding:6px; font-size:11px; }
button:disabled { opacity: 0.1; }

.enemy-box { background:var(--panel); border:1px solid var(--border); padding:4px; height: 42px; display:flex; flex-direction:column; justify-content:center; }
.hp-bar { width: 100%; background:#200; height:6px; margin-top:2px; border:1px solid #400; }
.hp-fill { background:#800; height:100%; width:100%; transition: width 0.1s; }

.log-container { flex: 1; background:#000; border:1px solid var(--border); margin:4px 0; overflow-y:auto; padding:4px; font-size:11px; line-height:1.4; display:flex; flex-direction:column-reverse; }
.log-win { color: #f1c40f; } .log-die { color: #e74c3c; } .log-get { color: #2ecc71; }

.status-bar { background:var(--panel); padding:6px; border:1px solid var(--border); font-size:12px; display:grid; grid-template-columns: 1.2fr 1fr; gap:4px; }
.btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 4px; }

.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:90%; padding:15px; overflow-y:auto; }
.tree-node { border-bottom:1px solid #222; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
.item-card { border:1px solid #333; padding:8px; margin-bottom:8px; background:#0a0a0a; font-size:11px; }
</style>
</head>
<body>

<div class="enemy-box">
    <div style="display:flex; justify-content:space-between; font-size:11px;">
        <span id="eName">WAITING...</span><span id="eHpNum"></span>
    </div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
</div>

<div class="log-container" id="log"></div>

<div class="status-bar">
    <div>
        <b>å‹‡è€… Lv.<span id="hLv">1</span></b> <span id="hHp">0/0</span><br>
        ATK:<span id="hAtk">0</span> DEF:<span id="hDef">0</span>
    </div>
    <div style="text-align:right; font-size:10px;">
        SP:<span id="hSp">0</span> / <span id="dName">---</span><br>
        Progress: <span id="dStep">0</span>/10
    </div>
</div>

<div class="btn-grid">
    <button onclick="openM('questM')">âš”ï¸ ä¾é ¼æ¿</button>
    <button onclick="openM('skillM')">ğŸ“ ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">ğŸ“¦ è£…å‚™å“</button>
</div>

<div id="questM" class="modal"><div class="modal-content"><h3>âš”ï¸ ã‚®ãƒ«ãƒ‰ä¾é ¼</h3><div id="qList"></div><br><button onclick="closeM('questM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>

<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ (SP:<span id="mSp">0</span>)</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>

<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3><div id="iList"></div><br><button onclick="closeM('equipM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>

<script>
const SAVE_KEY = "SlayerLog_v3.9";
let sp=0, step=0, dungeonIdx=0, inBattle=false;
let hero = { lv:1, exp:0, hp:100, maxHp:100, atk:10, def:10, eq:{w:null, a:null, r:null} };
let inventory = [], skills = {};

const DUNGEONS = [
    { n: "è–„æš—ã„åœ°ä¸‹æ°´é“", pow: 1, boss: "ä¸‹æ°´é“ã®ç‹ ãƒ©ãƒƒãƒˆ" },
    { n: "éœ§æ·±ã„äº¡éœŠã®æ£®", pow: 8, boss: "å¤ã®éœŠæ¨¹ ã‚¨ãƒ³ãƒˆ" },
    { n: "ç¼ç†±ã®æº¶å²©æ´çªŸ", pow: 30, boss: "ç„”ã®é­”äºº ã‚¹ãƒ«ãƒˆ" }
];

const SKILL_TREE = [
    { id:"p1", n:"å‰›åŠ› I", d:"ATK +15", sp:1, eff:{atk:15} },
    { id:"p2", n:"å‰›åŠ› II", d:"ATK +40", sp:2, eff:{atk:40} },
    { id:"p3", n:"ä¸€é–ƒ", d:"10%ã§ãƒ€ãƒ¡ãƒ¼ã‚¸3å€", sp:3, eff:{crit:0.1} },
    { id:"m1", n:"çŸ¥æµ I", d:"ç²å¾—EXP +20%", sp:1, eff:{exp:1.2} },
    { id:"m2", n:"çŸ¥æµ II", d:"ç²å¾—EXP +50%", sp:2, eff:{exp:1.5} },
    { id:"m3", n:"é­”åŠ›ç›¾", d:"æœ€å¤§HP +500", sp:3, eff:{hp:500} },
    { id:"t1", n:"å®ˆè­· I", d:"DEF +15", sp:1, eff:{def:15} },
    { id:"t2", n:"å®ˆè­· II", d:"DEF +40", sp:2, eff:{def:40} },
    { id:"t3", n:"é‡‘å‰›", d:"DEF +100", sp:3, eff:{def:100} }
];

function generateEnemyName(isBoss) {
    if(isBoss) return DUNGEONS[dungeonIdx].boss;
    const pre = ["é£¢ãˆãŸ", "å½·å¾¨ã†", "ç©¢ã‚ŒãŸ", "ç‹‚æš´ãª", "æ¼†é»’ã®", "å‘ªã‚ã‚ŒãŸ"];
    const mid = ["ã‚´ãƒ–ãƒªãƒ³", "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", "ã‚¦ãƒ«ãƒ•", "ã‚¹ãƒ©ã‚¤ãƒ ", "ãƒãƒƒãƒˆ", "ã‚ªãƒ¼ã‚¯"];
    return pre[Math.floor(Math.random()*pre.length)] + mid[Math.floor(Math.random()*mid.length)];
}

function updateUI() {
    let sA=0, sD=0, sH=0;
    Object.keys(skills).forEach(id => {
        const s = SKILL_TREE.find(x=>x.id===id);
        if(s.eff.atk) sA += s.eff.atk;
        if(s.eff.def) sD += s.eff.def;
        if(s.eff.hp) sH += s.eff.hp;
    });
    let eA=0, eD=0, eH=0;
    ['w','a','r'].forEach(t => { if(hero.eq[t]) { eA += hero.eq[t].atk; eD += hero.eq[t].def; eH += hero.eq[t].hp; } });

    const g = 1 + (hero.lv - 1) * 0.08;
    hero.maxHp = Math.floor((150 + sH + eH + (hero.lv-1)*40) * g);
    hero.atk = Math.floor((12 + sA + eA + (hero.lv-1)*6) * g);
    hero.def = Math.floor((8 + sD + eD + (hero.lv-1)*5) * g);

    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hSp").innerText = sp;
    document.getElementById("mSp").innerText = sp;
    document.getElementById("dStep").innerText = step;
}

function addLog(msg, type="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    d.className = type; d.innerText = `> ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 40) l.removeChild(l.lastChild);
}

function startDungeon(idx) {
    dungeonIdx = idx; step = 0; closeM('questM');
    document.getElementById("dName").innerText = DUNGEONS[idx].n;
    addLog(`${DUNGEONS[idx].n} ã¸å‡ºç™ºã€‚`);
    nextBattle();
}

function nextBattle() {
    if(inBattle) return;
    step++;
    if(step > 10) { addLog(`ä¾é ¼å®Œäº†ã€‚è¡—ã¸å¸°é‚„ã€‚`, "log-win"); step = 1; save(); }
    const isB = (step === 10);
    const p = DUNGEONS[dungeonIdx].pow * (isB ? 4 : 1);
    const enemy = {
        name: generateEnemyName(isB),
        hp: (100 + hero.lv * 80) * p,
        atk: (10 + hero.lv * 8) * p,
        maxHp: 0
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    runBattle(enemy, isB);
}

function runBattle(e, isB) {
    inBattle = true;
    const it = setInterval(() => {
        let d = Math.max(1, hero.atk - (e.atk*0.1));
        if(skills.p3 && Math.random()<0.1) d *= 3;
        e.hp -= d;

        if(e.hp <= 0) {
            clearInterval(it);
            addLog(`${e.name} ã‚’æ’ƒç ´ã€‚`);
            let expG = 40; if(skills.m1) expG *= 1.2; if(skills.m2) expG *= 1.5;
            hero.exp += expG;
            if(hero.exp >= 100) { hero.lv++; hero.exp=0; sp++; addLog(`å‹‡è€…ã®LvãŒ ${hero.lv} ã«ä¸Šæ˜‡ï¼`, "log-win"); }
            if(isB || Math.random() < 0.2) dropItem(DUNGEONS[dungeonIdx].pow);
            inBattle = false; save(); updateUI();
            setTimeout(nextBattle, 400);
        } else {
            hero.hp -= Math.max(1, e.atk - hero.def);
            document.getElementById("eHpFill").style.width = (e.hp/e.maxHp*100) + "%";
            document.getElementById("eHpNum").innerText = Math.floor(e.hp);
            updateUI();
            if(hero.hp <= 0) {
                clearInterval(it);
                addLog(`å‹‡è€…ã¯æ•—åŒ—ã—ãŸ...`, "log-die");
                hero.hp = hero.maxHp; inBattle = false;
                setTimeout(nextBattle, 400);
            }
        }
    }, 100);
}

function dropItem(pow) {
    const types = [{t:'w',n:'å‰£'}, {t:'a',n:'é§'}, {t:'r',n:'æŒ‡è¼ª'}];
    const tt = types[Math.floor(Math.random()*3)];
    const rarity = ["å¤ã³ãŸ", "é‰„ã®", "é­”çŸ³ã®", "æ·±æ·µã®", "ç‹å®¶ã®"][Math.min(4, Math.floor(Math.random()*pow))];
    const item = {
        id: Date.now(), type: tt.t, name: `${rarity}${tt.n}`,
        atk: tt.t === 'w' ? Math.floor(pow*25 + Math.random()*20) : 0,
        def: tt.t === 'a' ? Math.floor(pow*20 + Math.random()*15) : 0,
        hp: tt.t === 'r' ? Math.floor(pow*200 + Math.random()*100) : 0
    };
    inventory.push(item);
    addLog(`ã€Œ${item.name}ã€ã‚’æ‹¾ã£ãŸï¼`, "log-get");
}

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='questM'?'qList':id==='skillM'?'sList':'iList');
    d.innerHTML = "";
    if(id==='questM') DUNGEONS.forEach((q, i) => {
        d.innerHTML += `<button style="width:100%; margin-bottom:5px;" onclick="startDungeon(${i})">${q.n}</button>`;
    });
    if(id==='skillM') SKILL_TREE.forEach(s => {
        const has = skills[s.id];
        d.innerHTML += `<div class="tree-node"><div><b>${s.n}</b><br><small>${s.d}</small></div>
            <button onclick="buyS('${s.id}',${s.sp})" ${has||sp<s.sp?'disabled':''}>${has?'ç¿’å¾—æ¸ˆ':'ç¿’å¾—'}</button></div>`;
    });
    if(id==='equipM') inventory.forEach(item => {
        const isEq = Object.values(hero.eq).some(e => e && e.id === item.id);
        d.innerHTML += `<div class="item-card"><b>${item.name}</b> ${isEq?'[è£…å‚™ä¸­]':''}<br>
            ATK:${item.atk} DEF:${item.def} HP:${item.hp}<br>
            <button onclick="equipI(${item.id})" ${isEq?'disabled':''}>è£…å‚™</button>
            <button onclick="sellI(${item.id})">å»ƒæ£„</button></div>`;
    });
}

function buyS(id, c) { if(sp >= c) { sp -= c; skills[id] = true; updateUI(); save(); openM('skillM'); } }
function equipI(id) { 
    const item = inventory.find(i => i.id === id);
    hero.eq[item.type] = item; updateUI(); save(); openM('equipM');
}
function sellI(id) {
    inventory = inventory.filter(i => i.id !== id);
    Object.keys(hero.eq).forEach(k => { if(hero.eq[k] && hero.eq[k].id === id) hero.eq[k] = null; });
    updateUI(); save(); openM('equipM');
}
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() {
    const d = { h:hero, s:skills, i:inventory, sp, dIdx:dungeonIdx };
    localStorage.setItem(SAVE_KEY, JSON.stringify(d));
}
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) {
        const d = JSON.parse(s); hero=d.h; skills=d.s; inventory=d.i; sp=d.sp; dungeonIdx=d.dIdx;
    }
    hero.hp = hero.maxHp;
}
load(); updateUI(); startDungeon(dungeonIdx);
</script>
</body>
</html>

