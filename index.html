<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>聖杯オートRPG</title>

<style>
body{
  margin:0;
  background:#111;
  color:#eee;
  font-family:sans-serif;
  font-size:14px;
  padding:6px;
}
h2{font-size:18px;margin:4px 0;}
.panel{
  background:#1a1a1a;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
  margin-bottom:6px;
}
.buttons{
  display:flex;
  gap:4px;
}
button{
  flex:1;
  background:#333;
  color:#eee;
  border:1px solid #555;
  border-radius:6px;
  font-size:18px;
  padding:12px 0;
}
button:active{background:#666;transform:scale(0.97);}
.dead{opacity:0.4;}
.barWrap{background:#333;height:10px;border-radius:5px;overflow:hidden;}
.bar{background:#e74c3c;height:100%;}
.log{font-size:12px;max-height:80px;overflow:hidden;}
select{width:100%;font-size:16px;margin:2px 0;}
</style>
</head>

<body>

<h2>聖杯オートRPG</h2>

<div class="panel" id="jobSelect"></div>

<div class="panel">
距離：<span id="distance">0</span>m /
転生：<span id="rebirth">0</span> /
聖杯Pt：<span id="holy">0</span>
</div>

<div class="panel">
<strong id="enemyName"></strong>
<div id="enemyText"></div>
<div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div class="panel"><strong>パーティ</strong><div id="party"></div></div>
<div class="panel log" id="log"></div>

<div class="panel buttons">
<button onclick="stepDungeon()">進む</button>
<button onclick="toggleAuto()">オート</button>
<button onclick="changeSpeed()" id="speedBtn">×1</button>
<button onclick="rebirth()">転生</button>
</div>

<script>
/* ===== 職業 ===== */
const JOBS={
 騎士:{hp:120,atk:8,def:8,row:"front"},
 魔法:{hp:80,atk:14,def:3,row:"back"},
 僧侶:{hp:90,atk:6,def:5,row:"back"}
};

/* ===== 敵名 ===== */
const ENEMY_NAMES=["スライム","ゴブリン","スケルトン","オーク","魔獣"];
const BOSS_NAMES=["迷宮の番人","深淵の魔物","古代竜"];

/* ===== キャラ ===== */
class Character{
 constructor(job){
  const j=JOBS[job];
  this.job=job;
  this.level=1;this.exp=0;
  this.baseHp=j.hp;this.baseAtk=j.atk;this.baseDef=j.def;
  this.row=j.row;
  this.updateStats();
  this.hp=this.maxHp;
  this.alive=true;
 }
 updateStats(){
  this.maxHp=this.baseHp;
  this.atk=this.baseAtk;
  this.def=this.baseDef;
 }
}

/* ===== 敵 ===== */
class Enemy{
 constructor(dist){
  const boss=dist%100===0;
  this.name=boss?BOSS_NAMES[Math.floor(dist/100)%3]:
    ENEMY_NAMES[Math.floor(Math.random()*ENEMY_NAMES.length)];
  let m=boss?5:1;
  this.maxHp=Math.floor((40+dist*0.4)*m);
  this.hp=this.maxHp;
  this.atk=Math.floor((6+dist*0.05)*m);
  this.def=Math.floor(dist*0.02*m);
 }
}

/* ===== 状態 ===== */
let distance=0,rebirthCount=0,holyPoint=0;
let speed=1,autoTimer=null,currentEnemy=null;
let party=[];

/* ===== ログ ===== */
function addLog(t){
 log.innerHTML=t+"<br>"+log.innerHTML;
}

/* ===== 職業UI ===== */
function setupJobSelect(){
 jobSelect.innerHTML="<strong>職業変更</strong>";
 for(let i=0;i<5;i++){
  const s=document.createElement("select");
  for(const j in JOBS){
   const o=document.createElement("option");
   o.value=j;o.textContent=j;
   s.appendChild(o);
  }
  jobSelect.appendChild(s);
 }
 const b=document.createElement("button");
 b.textContent="変更確定";
 b.onclick=applyJobs;
 jobSelect.appendChild(b);
}

/* ===== 初期パーティ生成 ===== */
function initParty(){
 party=Array.from({length:5},()=>new Character("騎士"));
 updateUI();
}

/* ===== 職業反映 ===== */
function applyJobs(){
 party=[...jobSelect.querySelectorAll("select")]
  .map(s=>new Character(s.value));
 updateUI();
}

/* ===== 成長 ===== */
function expNeed(lv){return Math.floor(20*Math.pow(lv,1.5));}
function levelUp(c){
 c.level++;c.baseHp+=10;c.baseAtk+=3;c.baseDef+=2;
 c.updateStats();c.hp=c.maxHp;
 addLog(`${c.job} Lv${c.level}に成長`);
}

/* ===== バトル ===== */
function calcDamage(c,e){
 return Math.max(1,Math.floor(c.atk*(c.row==="back"?1.2:1)-e.def));
}
function randomAlive(){
 const a=party.filter(c=>c.alive);
 return a[Math.floor(Math.random()*a.length)];
}
function reviveParty(){
 party.forEach(c=>{c.alive=true;c.hp=c.maxHp;});
}
function battle(enemy,end){
 const it=setInterval(()=>{
  for(const c of party){
   if(!c.alive)continue;
   enemy.hp-=calcDamage(c,enemy);
   if(enemy.hp<=0)break;
  }
  updateEnemyUI();
  if(enemy.hp<=0){
   clearInterval(it);
   party.forEach(c=>{
    c.exp+=10;
    while(c.exp>=expNeed(c.level)){
     c.exp-=expNeed(c.level);
     levelUp(c);
    }
   });
   reviveParty();end();return;
  }
  const t=randomAlive();
  t.hp-=Math.max(1,enemy.atk-t.def);
  if(t.hp<=0)t.alive=false;
  if(!party.some(c=>c.alive)){
   clearInterval(it);reviveParty();end();
  }
  updateUI();
 },700/speed);
}

/* ===== 進行 ===== */
function stepDungeon(){
 if(party.length===0)return;
 distance+=10;
 currentEnemy=new Enemy(distance);
 updateEnemyUI();
 battle(currentEnemy,updateUI);
}

/* ===== UI ===== */
function updateUI(){
 distanceEl.textContent=distance;
 rebirthEl.textContent=rebirthCount;
 holyEl.textContent=holyPoint;
 partyEl.innerHTML="";
 party.forEach((c,i)=>{
  const d=document.createElement("div");
  d.className=c.alive?"":"dead";
  d.textContent=
   `#${i+1} ${c.job} Lv${c.level} HP${c.hp}/${c.maxHp} ATK${c.atk} DEF${c.def}`;
  partyEl.appendChild(d);
 });
}
function updateEnemyUI(){
 if(!currentEnemy)return;
 enemyName.textContent=currentEnemy.name;
 enemyText.textContent=`HP ${currentEnemy.hp}/${currentEnemy.maxHp}`;
 enemyHpBar.style.width=(currentEnemy.hp/currentEnemy.maxHp*100)+"%";
}

/* ===== 操作 ===== */
function toggleAuto(){
 autoTimer?
 (clearInterval(autoTimer),autoTimer=null):
 (autoTimer=setInterval(stepDungeon,2000/speed));
}
function changeSpeed(){
 speed=speed===1?2:speed===2?4:1;
 speedBtn.textContent="×"+speed;
}

/* ===== 転生 ===== */
function rebirth(){
 if(distance<100){addLog("100m未満では転生不可");return;}
 rebirthCount++;
 holyPoint+=Math.floor(distance/100);
 distance=0;
 initParty();
 addLog("転生した");
}

/* ===== DOM ===== */
const jobSelect=document.getElementById("jobSelect");
const distanceEl=document.getElementById("distance");
const rebirthEl=document.getElementById("rebirth");
const holyEl=document.getElementById("holy");
const partyEl=document.getElementById("party");
const enemyName=document.getElementById("enemyName");
const enemyText=document.getElementById("enemyText");
const enemyHpBar=document.getElementById("enemyHpBar");
const log=document.getElementById("log");
const speedBtn=document.getElementById("speedBtn");

/* ===== 起動 ===== */
setupJobSelect();
initParty();
</script>

</body>
</html>