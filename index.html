<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v3.2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --main-bg: #000; --panel-bg: #1a1a1a; --accent: #f1c40f; --text: #ddd; --border: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { 
    margin:0; background:var(--main-bg); color:var(--text); font-family:monospace; font-size:12px; 
    height: 100dvh; display:flex; flex-direction:column; padding: 2px;
}
button { background:#333; color:#eee; border:1px solid #555; border-radius:3px; cursor:pointer; font-size:11px; }
button:active { background: #555; }
.toggleOn { background:#27ae60 !important; color:#fff !important; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼å‘¨ã‚Š */
.top-nav { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px; }
.status-panel { background:var(--panel-bg); border:1px solid var(--border); padding:4px; border-radius:4px; }
.btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }

/* æ•µHPãƒãƒ¼ */
.enemy-panel { background:var(--panel-bg); border:1px solid var(--border); padding:2px 6px; margin-bottom:4px; display:flex; align-items:center; gap:8px; height:24px; }
.hp-bar { flex-grow:1; background:#222; height:10px; border-radius:5px; border:1px solid #444; position:relative; overflow:hidden; }
.hp-fill { background:#c0392b; height:100%; width:0%; transition:width 0.1s; }

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆã“ã“ãŒã‚¹ã‚¯ã‚·ãƒ§é¢¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è‚ï¼‰ */
.game-main { display: flex; flex: 1; min-height: 0; gap: 4px; margin-bottom: 4px; }

/* å·¦å´ï¼šãƒ‘ãƒ¼ãƒ†ã‚£ãƒªã‚¹ãƒˆ */
.party-side { flex: 1; display: flex; flex-direction: column; gap: 2px; overflow-y: auto; }
.char-row { background:var(--panel-bg); border:1px solid var(--border); padding:4px; border-radius:4px; position:relative; }
.char-name { font-weight:bold; color:#fff; display:flex; justify-content:space-between; font-size:12px; }
.char-sub { font-size:10px; color:#888; margin-top:1px; }

/* å³å´ï¼šç¸¦é•·ãƒ­ã‚° */
.log-side { flex: 0.8; background:#000; border:1px solid var(--border); border-radius:4px; padding:4px; overflow-y:auto; display:flex; flex-direction:column-reverse; font-size:10px; line-height:1.4; color:#aaa; }

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.footer { display: grid; grid-template-columns: 1fr 1.5fr; gap: 4px; height: 44px; }
.footer button { font-size: 14px; font-weight: bold; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#222; border:1px solid #444; border-radius:8px; width:90%; max-width:300px; padding:15px; }
.area-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-top: 10px; }

/* ã‚¹ã‚­ãƒ«ç™ºå‹•ç­‰ã®ãƒ­ã‚°ã‚«ãƒ©ãƒ¼ */
.log-skill { color: #3498db; }
.log-get { color: var(--accent); }
</style>
</head>
<body>

<div class="top-nav">
    <div class="status-panel" onclick="openModal('petModal')">
        <div style="font-weight:bold;"><span id="floor">1</span>F <small>(<span id="holy">0</span>Pt)</small></div>
        <div style="font-size:10px; color:#a29bfe;">ğŸ¾Lv<span id="petLv">1</span> ğŸš©<span id="killCount">0/10</span></div>
    </div>
    <div class="btn-group">
        <button onclick="openModal('upgradeModal')">âœ¨å¼·åŒ–</button>
        <button onclick="openModal('gachaModal')">ğŸã‚¬ãƒãƒ£</button>
        <button onclick="openModal('areaModal')" style="grid-column: span 2; background:#2980b9;">ğŸš©éšå±¤ç§»å‹•</button>
    </div>
</div>

<div class="enemy-panel">
    <div id="enemyName" style="font-size:10px; font-weight:bold; min-width:60px;">---</div>
    <div class="hp-bar"><div id="enemyHpBar" class="hp-fill"></div></div>
    <div id="enemyHpNum" style="font-size:10px; min-width:30px; text-align:right;">0</div>
</div>

<div class="game-main">
    <div class="party-side" id="partyList"></div>
    <div class="log-side" id="log"></div>
</div>

<div class="footer">
    <button onclick="stepDungeon()">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<div id="areaModal" class="modal"><div class="modal-content"><h3 style="margin:0;text-align:center;">ğŸš© ã‚¨ãƒªã‚¢é¸æŠ</h3><div class="area-grid" id="areaGrid"></div><button onclick="closeModal('areaModal')" style="width:100%; margin-top:15px; padding:8px;">é–‰ã˜ã‚‹</button></div></div>
<div id="charModal" class="modal"><div class="modal-content" id="m-content"></div></div>
<div id="petModal" class="modal"><div class="modal-content" id="pet-content"></div></div>
<div id="upgradeModal" class="modal"><div class="modal-content"><h3 style="margin:0; text-align:center;">âœ¨ è–æ¯å¼·åŒ– (Pt:<span id="holy2">0</span>)</h3><div id="upgradeRows" style="margin:10px 0;"></div><button id="autoUpBtn" style="width:100%; padding:10px;" onclick="toggleAutoUpgrade()">è‡ªå‹•å¼·åŒ–: OFF</button><button onclick="closeModal('upgradeModal')" style="width:100%; margin-top:10px;">é–‰ã˜ã‚‹</button></div></div>
<div id="gachaModal" class="modal"><div class="modal-content" style="text-align:center;"><h3>ğŸ è–æ¯ã‚¬ãƒãƒ£</h3><div id="gachaItem" style="background:#111; padding:20px; border-radius:5px; margin-bottom:10px; border:1px solid gold;">ï¼Ÿ</div><div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"><button onclick="playGacha(1)" style="padding:10px 0;">1é€£</button><button onclick="playGacha(10)" style="padding:10px 0; background:#8e44ad;">10é€£</button></div><button onclick="closeModal('gachaModal')" style="width:100%; margin-top:10px;">é–‰ã˜ã‚‹</button></div></div>

<script>
const SAVE_KEY = "HolyRPG_Layout_v3.2";
let floor=1, maxReachedFloor=1, kills=0, totalKills=0, holy=0, petLv=1, autoIsOn=false, autoUpgrade=false;
let bonus={atk:0, def:0, hp:0, exp:0}, party=[], enemy=null;

const JOB_DATA = {
    "ã›ã‚“ã—": {h:200, a:18, d:18, s:[{lv:1,n:"å¼·æ’ƒ"},{lv:10,n:"å…œå‰²ã‚Š"},{lv:25,n:"ä¸å±ˆ"}]},
    "ã¨ã†ãã": {h:130, a:16, d:12, s:[{lv:1,n:"æ€¥æ‰€"},{lv:10,n:"æ¯’åˆƒ"},{lv:25,n:"ç¥é€Ÿ"}]},
    "ã¾ã»ã†ã¤ã‹ã„": {h:110, a:32, d:8, s:[{lv:1,n:"ç«çƒ"},{lv:10,n:"é›·æ’ƒ"},{lv:25,n:"æ¥µå…‰"}]},
    "ãã†ã‚Šã‚‡": {h:150, a:14, d:14, s:[{lv:1,n:"ç™’ã—"},{lv:10,n:"å®ˆè­·"},{lv:25,n:"å¥‡è·¡"}]},
    "å‹‡è€…": {h:400, a:60, d:40, s:[{lv:1,n:"è¦‡ç‹"},{lv:20,n:"å¤©ç½°"},{lv:50,n:"çµ‚ç„‰"}]}
};

class Char {
    constructor(n, j, i) { this.name=n; this.job=j; this.icon=i; this.level=1; this.exp=0; this.hp=100; this.maxHp=100; this.atk=10; this.def=5; this.alive=true; this.w=0; this.a=0; }
    update() {
        const jd = JOB_DATA[this.job]; const g = 1 + (this.level-1)*0.07;
        this.maxHp = Math.floor((jd.h + bonus.hp + (this.level-1)*30)*g);
        this.atk = Math.floor((jd.a + bonus.atk + (this.level-1)*5 + this.w)*g);
        this.def = Math.floor((jd.d + bonus.def + (this.level-1)*4 + this.a)*g);
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function updateUI() {
    document.getElementById("floor").innerText = floor;
    document.getElementById("holy").innerText = holy;
    document.getElementById("holy2").innerText = holy;
    document.getElementById("killCount").innerText = `${kills%10}/10`;
    document.getElementById("petLv").innerText = petLv;
    const pl = document.getElementById("partyList"); pl.innerHTML = "";
    party.forEach((c, i) => {
        c.update();
        const d = document.createElement("div"); d.className = "char-row"; d.onclick = () => showCharDetail(i);
        d.innerHTML = `<div class="char-name"><span>${c.icon}${c.name}</span><span>Lv${c.level}</span></div>
            <div style="font-size:10px; color:#e74c3c;">HP: ${Math.floor(c.hp)}/${c.maxHp}</div>
            <div class="char-sub">${c.job} / âš”ï¸${c.w} ğŸ›¡ï¸${c.a}</div>`;
        pl.appendChild(d);
    });
    const ur = document.getElementById("upgradeRows"); ur.innerHTML = "";
    [{k:'atk',n:'æ”»æ’ƒ'},{k:'def',n:'é˜²å¾¡'},{k:'hp',n:'ä½“åŠ›'},{k:'exp',n:'çµŒé¨“'}].forEach(s => {
        const r = document.createElement("div"); r.style = "display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; background:#111; padding:4px; border-radius:4px;";
        r.innerHTML = `<span>${s.n}:${bonus[s.k]}</span><div><button onclick="changeBonus('${s.k}',-1)">-</button><button onclick="changeBonus('${s.k}',1)">+</button><button onclick="changeBonus('${s.k}',10)">+10</button></div>`;
        ur.appendChild(r);
    });
    const ag = document.getElementById("areaGrid"); ag.innerHTML = "";
    for(let i=1; i<=maxReachedFloor; i+=50) {
        const ab = document.createElement("button"); ab.style.padding="10px"; ab.innerText=i+"F"; ab.onclick=()=>jump(i); ag.appendChild(ab);
    }
    if(maxReachedFloor%50 !== 1) { const mb=document.createElement("button"); mb.style.padding="10px"; mb.innerText=maxReachedFloor+"F"; mb.onclick=()=>jump(maxReachedFloor); ag.appendChild(mb); }
    document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : "";
}

function addLog(msg, cl="") {
    const l = document.getElementById("log"); const d = document.createElement("div");
    if(cl) d.className = cl; d.innerText = msg; l.appendChild(d);
    if(l.childNodes.length > 50) l.removeChild(l.firstChild);
}

function jump(f) { floor=f; closeModal('areaModal'); addLog(`ğŸš©${f}Fã¸ç§»å‹•`); updateUI(); }
function changeBonus(k,v) { 
    if(v>0){ const c=Math.min(v,holy); bonus[k]+=c; holy-=c; }
    else{ const b=Math.min(Math.abs(v),bonus[k]); bonus[k]-=b; holy+=b; }
    updateUI(); save();
}

function playGacha(t) {
    if(holy < t) return; holy -= t;
    for(let i=0; i<t; i++) {
        const c = party[Math.floor(Math.random()*4)];
        if(Math.random()<0.5) c.w+=5; else c.a+=5;
    }
    document.getElementById("gachaItem").innerText = t + "é€£ï¼šè£…å‚™å¼·åŒ–å®Œäº†ï¼";
    updateUI(); save();
}

function stepDungeon() {
    if(enemy) return;
    const pow = Math.pow(1.07, Math.floor(floor/5));
    enemy = { name:"Monster", maxHp:(200+floor*60)*pow, hp:0, atk:(10+floor*6)*pow, def:(5+floor*4)*pow };
    enemy.hp = enemy.maxHp; battleLoop();
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            let d = Math.max(1, c.atk - enemy.def);
            if(Math.random() < 0.2) {
                const s = JOB_DATA[c.job].s.filter(sk => c.level >= sk.lv).pop();
                if(s) { if(c.job==="ãã†ã‚Šã‚‡"){ c.hp=Math.min(c.maxHp, c.hp+c.atk); addLog(`ğŸ•Šï¸${s.n}`, "log-skill"); } else { d*=2; addLog(`${c.icon}${s.n}!`, "log-skill"); } }
            }
            enemy.hp -= d;
            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); kills++; totalKills++;
                if(kills % 10 === 0) { holy++; if(autoUpgrade) changeBonus('atk', 1); addLog("âœ¨è–æ¯Ptç²å¾—", "log-get"); }
                party.forEach(ch => { ch.exp += 35; if(ch.exp>=100){ ch.level++; ch.exp=0; ch.hp=ch.maxHp; addLog(`${ch.name}LvUP`); } });
                floor++; if(floor>maxReachedFloor) maxReachedFloor=floor;
                enemy=null; save(); if(autoIsOn) setTimeout(stepDungeon, 50); updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t){ clearInterval(it); floor=Math.max(1, floor-3); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0) t.alive=false;
        }
        document.getElementById("enemyHpBar").style.width = enemy ? (enemy.hp/enemy.maxHp*100)+"%" : "0%";
        document.getElementById("enemyHpNum").innerText = enemy ? Math.floor(enemy.hp) : "0";
        document.getElementById("enemyName").innerText = enemy ? enemy.name : "---";
    }, 80);
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; updateUI(); }
function openModal(id) { document.getElementById(id).style.display = "flex"; updateUI(); }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function showCharDetail(i) {
    const c = party[i]; const sk = JOB_DATA[c.job].s.filter(s => c.level >= s.lv);
    document.getElementById("m-content").innerHTML = `<h3>${c.icon}${c.name}</h3><p>${c.job} Lv${c.level}</p><p>ã‚¹ã‚­ãƒ«: ${sk.map(s=>s.n).join(", ")}</p><button onclick="closeModal('charModal')" style="width:100%; padding:10px;">é–‰ã˜ã‚‹</button>`;
    openModal("charModal");
}
function openPetInfo() {
    document.getElementById("pet-content").innerHTML = `<h3>ğŸ¾ãƒšãƒƒãƒˆ</h3><p>Lv:${petLv}</p><p>50ä½“è¨ä¼ã”ã¨ã«Lvã‚¢ãƒƒãƒ—ï¼</p><button onclick="closeModal('petModal')" style="width:100%; padding:10px;">é–‰ã˜ã‚‹</button>`;
    openModal("petModal");
}

function save() {
    const d = { floor, maxReachedFloor, holy, bonus, petLv, totalKills, autoUpgrade, party: party.map(c => ({n:c.name, j:c.job, i:c.icon, l:c.level, w:c.w, a:c.a}))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(d));
}
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) {
        const d = JSON.parse(s); floor=d.floor; maxReachedFloor=d.maxReachedFloor; holy=d.holy; bonus=d.bonus; petLv=d.petLv; totalKills=d.totalKills; autoUpgrade=d.autoUpgrade;
        party = d.party.map(p => { let c=new Char(p.n, p.j, p.i); c.level=p.l; c.w=p.w; c.a=p.a; return c; });
    } else {
        party = [new Char("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Char("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Char("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Char("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
    }
}
load(); updateUI();
</script>
</body>
</html>
