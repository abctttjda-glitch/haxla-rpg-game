<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v2.4.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
:root { --main-bg: #111; --panel-bg: #1e1e1e; --accent: #f1c40f; --text: #eee; }
* { touch-action: manipulation; box-sizing: border-box; }
body { 
    margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:13px; padding:2px;
    height:100vh; overflow:hidden; display:flex; flex-direction:column;
}
.panel { background:var(--panel-bg); border:1px solid #444; border-radius:4px; padding:3px; margin-bottom:2px; }
button { background:#333; color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; font-size:12px; }
.active { background:var(--accent) !important; color:#000 !important; font-weight:bold; }
.toggleOn { background:#2ecc71; color:#000; font-weight:bold; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»æ•µãƒ‘ãƒãƒ« */
.header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }
.enemy-panel { display: flex; align-items: center; gap: 5px; padding: 2px 5px; height: 22px; }
.hp-bar-outer { flex-grow: 1; background:#333; height:10px; border-radius:5px; overflow:hidden; position:relative; }
.hp-bar-inner { background:#e74c3c; height:100%; width:0%; transition: width 0.1s; }
.hp-text { position:absolute; width:100%; text-align:center; font-size:9px; font-weight:bold; top:-1px; }

/* ãƒ¡ã‚¤ãƒ³ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ï¼†ãƒ­ã‚°ï¼‰ */
.main-content { display: grid; grid-template-columns: 1.4fr 1fr; gap: 2px; flex: 1; min-height: 0; }
.party-list { overflow-y: hidden; display: flex; flex-direction: column; justify-content: space-around; }
.char-card { border-bottom: 1px solid #333; padding: 1px 0; }
.char-info { display:flex; justify-content:space-between; font-weight:bold; font-size:11px; }
.job-label { color: #aaa; font-size: 9px; margin-left: 2px; }
.eq-row { font-size: 9px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.log { background:#000; padding:2px; overflow-y:auto; display:flex; flex-direction:column-reverse; border:1px solid #333; border-radius:4px; font-size: 10px; line-height: 1.1; }

/* å¼·åŒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.upgrade-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; margin-top: 1px; }
.stat-btn { display: flex; flex-direction: column; align-items: center; padding: 4px 0; font-size: 10px; }

/* ä¸‹éƒ¨æ“ä½œ */
.footer-btns { display: grid; grid-template-columns: 1fr 2fr; gap: 2px; margin-top: 2px; }
.footer-btns button { padding: 10px 0; font-weight: bold; font-size: 15px; }

/* ã‚«ã‚¸ãƒãƒ¢ãƒ¼ãƒ€ãƒ« */
#casinoModal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center;
}
.modal-content {
    background: #2c3e50; border: 2px solid var(--accent); border-radius: 12px;
    width: 85%; max-width: 300px; padding: 20px; text-align: center;
}
.slot-machine { font-size: 40px; margin: 15px 0; letter-spacing: 5px; background: #000; padding: 10px; border-radius: 8px; }
#casinoResult { margin: 10px 0; font-weight: bold; color: var(--accent); min-height: 1.2em; }
</style>
</head>
<body>

<div class="header-grid">
    <div class="panel">
        <strong><span id="floor">1</span>F</strong> <small>(<span id="holy">0</span>Pt)</small>
        <div style="font-size:9px; color:#a29bfe;">ğŸ¾Lv<span id="petLv">1</span> / <span id="killCount">0/10</span></div>
    </div>
    <div class="panel" style="display:grid; grid-template-columns:1fr 1fr; gap:1px;">
        <button onclick="openCasino()" style="font-size:11px; background:#4b4b4b;">ğŸ° ã‚«ã‚¸ãƒ</button>
        <button onclick="warpMax()" style="font-size:11px;">Warp</button>
        <button id="autoUpBtn" style="font-size:9px; grid-column:span 2" onclick="toggleAutoUpgrade()">è‡ªå‹•å¼·åŒ–:OFF</button>
    </div>
</div>

<div class="panel enemy-panel">
    <div style="font-size:10px; font-weight:bold; min-width:40px;" id="enemyName">---</div>
    <div class="hp-bar-outer">
        <div id="enemyHpBar" class="hp-bar-inner"></div>
        <div class="hp-text" id="enemyHpNum">0/0</div>
    </div>
</div>

<div class="main-content">
    <div class="panel party-list" id="partyList"></div>
    <div class="log" id="log"></div>
</div>

<div class="panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
        <button id="amt1" style="width:32%; padding:3px;" onclick="setAmount(1)">x1</button>
        <button id="amt10" style="width:32%; padding:3px;" onclick="setAmount(10)">x10</button>
        <button id="amtMAX" style="width:32%; padding:3px;" onclick="setAmount('MAX')">MAX</button>
    </div>
    <div class="upgrade-box">
        <button class="stat-btn" onclick="upgrade('atk')">æ”»+<span id="b-atk">0</span></button>
        <button class="stat-btn" onclick="upgrade('def')">é˜²+<span id="b-def">0</span></button>
        <button class="stat-btn" onclick="upgrade('hp')">å‘½+<span id="b-hp">0</span></button>
        <button class="stat-btn" onclick="upgrade('exp')">çµŒ+<span id="b-exp">0</span></button>
    </div>
</div>

<div class="footer-btns">
    <button onclick="stepDungeon()">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<div id="casinoModal">
    <div class="modal-content">
        <h3 style="margin:0; color:var(--accent);">è–æ¯ã‚«ã‚¸ãƒ</h3>
        <p style="font-size:11px; margin:5px 0;">1å› 1è–æ¯Pt ã§æŒ‘æˆ¦ï¼</p>
        <div class="slot-machine" id="slot">â“ â“ â“</div>
        <div id="casinoResult">å¹¸é‹ã‚’ç¥ˆã‚‹...ï¼</div>
        <button onclick="playCasino()" id="spinBtn" style="width:100%; padding:10px; background:#27ae60; font-weight:bold; margin-bottom:10px;">ã‚¹ãƒ”ãƒ³ï¼</button>
        <button onclick="closeCasino()" style="width:100%; background:#c0392b;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
const SAVE_KEY = "HolyRPG_Persistent_Data_v2.2"; 
let floor=1, maxReachedFloor=1, loopCount=0, kills=0, holy=0, petLv=1;
let bonus={atk:0, def:0, hp:0, exp:0}, buyAmount=1, autoIsOn=false, autoUpgrade=false, heroUnlocked=false;
let party=[], enemy=null;

const JOB_DATA = {"ã›ã‚“ã—":{h:150,a:12,d:12},"ã¨ã†ãã":{h:100,a:11,d:6},"ã¾ã»ã†ã¤ã‹ã„":{h:80,a:22,d:4},"ãã†ã‚Šã‚‡":{h:120,a:8,d:8},"å‹‡è€…":{h:250,a:35,d:20}};

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.alive=true;
        this.weapon={name:"æœ¨ã®æ£’",val:0}; this.armor={name:"å¸ƒã®æœ",val:0};
    }
    updateStats() {
        const j = JOB_DATA[this.job]||JOB_DATA["ã›ã‚“ã—"];
        const awake = 1 + Math.floor(this.level/10)*0.15;
        this.maxHp = Math.floor((j.h + (bonus.hp||0) + (this.level-1)*45) * awake);
        this.atk = Math.floor((j.a + (bonus.atk||0) + (this.level-1)*7 + this.weapon.val) * awake);
        this.def = Math.floor((j.d + (bonus.def||0) + (this.level-1)*5 + this.armor.val) * awake);
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function addLog(t, cls="") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    if(cls) line.style.color = (cls==="drop-msg") ? "#f39c12" : "#3498db";
    line.innerText = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 20) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("holy").textContent = holy;
    document.getElementById("killCount").textContent = `${kills%10}/10`;
    document.getElementById("petLv").textContent = petLv;
    document.getElementById("b-atk").textContent = bonus.atk;
    document.getElementById("b-def").textContent = bonus.def;
    document.getElementById("b-hp").textContent = bonus.hp;
    document.getElementById("b-exp").textContent = bonus.exp;

    const pEl = document.getElementById("partyList");
    pEl.innerHTML = "";
    party.forEach(c => {
        c.updateStats();
        const card = document.createElement("div");
        card.className = "char-card " + (c.alive ? "" : "dead");
        card.innerHTML = `<div class="char-info"><span>${c.icon}${c.name}<span class="job-label">${c.job}</span></span><span>HP:${Math.floor(c.hp)}</span></div>
        <div class="eq-row">âš”ï¸${c.weapon.name}+${c.weapon.val} / ğŸ›¡ï¸${c.armor.name}+${c.armor.val}</div>`;
        pEl.appendChild(card);
    });
}

function openCasino() { document.getElementById("casinoModal").style.display = "flex"; }
function closeCasino() { document.getElementById("casinoModal").style.display = "none"; }

function playCasino() {
    if(holy < 1) { document.getElementById("casinoResult").innerText = "è–æ¯PtãŒè¶³ã‚Šã¾ã›ã‚“ï¼"; return; }
    holy--;
    updateUI();
    const spinBtn = document.getElementById("spinBtn");
    spinBtn.disabled = true;
    const slot = document.getElementById("slot");
    const resultText = document.getElementById("casinoResult");
    
    let timer = 0;
    const interval = setInterval(() => {
        const items = ["ğŸ’","ğŸ””","ğŸ","ğŸ’","â­","ğŸ’€"];
        slot.innerText = items[Math.floor(Math.random()*6)] + " " + items[Math.floor(Math.random()*6)] + " " + items[Math.floor(Math.random()*6)];
        timer++;
        if(timer > 10) {
            clearInterval(interval);
            const r = Math.random();
            if(r < 0.05) { // ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ
                slot.innerText = "â­ â­ â­"; resultText.innerText = "è¶…çµ¶å¤§å½“ã‚Šï¼è–æ¯Pt +20"; holy += 20; addLog("ğŸ°ã‚«ã‚¸ãƒ:è¶…å¤§å½“ã‚Š!");
            } else if(r < 0.2) { // æ”»æ’ƒUP
                slot.innerText = "ğŸ’ âš”ï¸ ğŸ’"; resultText.innerText = "æ­¦å™¨å¼·åŒ–ï¼å…¨æ”»æ’ƒåŠ› +50"; bonus.atk += 50; addLog("ğŸ°ã‚«ã‚¸ãƒ:æ”»æ’ƒUP");
            } else if(r < 0.4) { // çµŒé¨“å€¤UP
                slot.innerText = "ğŸ ğŸ“– ğŸ"; resultText.innerText = "çŸ¥æµã®å®Ÿï¼çµŒé¨“å€ç‡ +5"; bonus.exp += 5; addLog("ğŸ°ã‚«ã‚¸ãƒ:çµŒé¨“UP");
            } else if(r < 0.6) { // Pté‚„å…ƒ
                slot.innerText = "ğŸ’ ğŸ’ ğŸ’"; resultText.innerText = "å°å½“ã‚Šï¼è–æ¯Pt +2"; holy += 2; addLog("ğŸ°ã‚«ã‚¸ãƒ:å°å½“ã‚Š");
            } else {
                slot.innerText = "ğŸ’€ ğŸƒ ğŸ’€"; resultText.innerText = "ãƒã‚ºãƒ¬...";
            }
            spinBtn.disabled = false;
            updateUI(); save();
        }
    }, 100);
}

function stepDungeon() {
    if(enemy) return;
    const p = (1 + loopCount + floor/100);
    enemy = { name: (floor%10===0?"BOSS":"MON"), maxHp:(200+floor*60)*p, hp:0, atk:(15+floor*7)*p, def:(10+floor*4)*p };
    enemy.hp = enemy.maxHp;
    battleLoop();
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            if(Math.random()<0.05) { enemy.hp -= (petLv*15); addLog("ğŸ¾è¿½æ’ƒ", "skill-msg"); }
            let dmg = Math.max(1, c.atk - enemy.def);
            if(Math.random()<0.1) { dmg*=2; addLog(`${c.icon}æŠ€`, "skill-msg"); }
            enemy.hp -= dmg;
            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); kills++;
                if(kills%10===0) { holy++; if(autoUpgrade) autoDistribute(); }
                if(kills%50===0) petLv++;
                if(Math.random()<0.2) dropGear();
                party.forEach(char => {
                    char.exp += 20 * (1+bonus.exp*0.1);
                    if(char.exp >= 50){ char.level++; char.exp=0; char.hp=char.maxHp; }
                });
                if(floor===100 && !heroUnlocked){ heroUnlocked=true; party[0].job="å‹‡è€…"; party[0].icon="ğŸ‘‘"; addLog("ğŸ‘‘å‹‡è€…è¦šé†’ï¼"); }
                if(floor>=1000){ floor=1; loopCount++; } else { floor++; }
                if(floor>maxReachedFloor) maxReachedFloor=floor;
                enemy=null; save(); if(autoIsOn) setTimeout(stepDungeon, 50);
                updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t){ clearInterval(it); floor=Math.max(1, floor-10); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); save(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0) t.alive=false;
        }
        document.getElementById("enemyName").textContent = enemy?enemy.name:"---";
        document.getElementById("enemyHpNum").textContent = enemy?Math.floor(enemy.hp):"0";
        document.getElementById("enemyHpBar").style.width = enemy?(enemy.hp/enemy.maxHp*100)+"%":"0%";
        updateUI();
    }, 50);
}

function dropGear() {
    const target = party[Math.floor(Math.random()*party.length)];
    const isWep = Math.random() > 0.5;
    const mats = ["é‰„","é‹¼","éŠ€","é‡‘","é­”","ç¥"];
    const mat = mats[Math.min(5, Math.floor(floor/150))];
    const val = Math.floor(floor * 1.5 + Math.random()*floor);
    if(isWep && val > target.weapon.val) { target.weapon = { name: mat+"ã®å‰£", val: val }; addLog(`ğŸ${target.name}:æ­¦å™¨UP`, "drop-msg"); }
    else if(!isWep && val > target.armor.val) { target.armor = { name: mat+"ã®é§", val: val }; addLog(`ğŸ${target.name}:é˜²å…·UP`, "drop-msg"); }
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function setAmount(a) { buyAmount = a; ["amt1", "amt10", "amtMAX"].forEach(id => document.getElementById(id).classList.toggle("active", id.includes(a))); }
function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost; bonus[t] += (t==='hp'?cost*50:cost*5); updateUI(); save();
}
function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : ""; }
function autoDistribute() { upgrade(['atk','def','hp','exp'][Math.floor(Math.random()*4)]); }
function warpMax() { if(!enemy){ floor = maxReachedFloor; updateUI(); }}

function save() {
    const data = { floor, maxReachedFloor, loopCount, kills, holy, bonus, petLv, heroUnlocked, party: party.map(c => ({
        name:c.name, job:c.job, icon:c.icon, level:c.level, hp:c.hp, weapon:c.weapon, armor:c.armor
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}
function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        const d = JSON.parse(saved);
        floor=d.floor||1; maxReachedFloor=d.maxReachedFloor||1; loopCount=d.loopCount||0; kills=d.kills||0; holy=d.holy||0; bonus=d.bonus||{atk:0,def:0,hp:0,exp:0}; petLv=d.petLv||1; heroUnlocked=d.heroUnlocked||false;
        party = d.party.map(p => { 
            let c=new Character(p.name, p.job, p.icon); c.level=p.level; c.hp=p.hp; 
            c.weapon=p.weapon; c.armor=p.armor; return c; 
        });
        if(autoUpgrade) document.getElementById("autoUpBtn").className = "toggleOn";
    } else {
        party = [new Character("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Character("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Character("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Character("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
    }
}
load(); updateUI();
</script>
</body>
</html>
