<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>聖杯オートRPG</title>

<style>
body{
  margin:0;
  background:#111;
  color:#eee;
  font-family:sans-serif;
  font-size:15px;
  padding:6px;
}
h2{margin:4px 0;font-size:20px}
.panel{
  background:#1a1a1a;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
  margin-bottom:6px;
}
.buttons{
  display:flex;
  gap:4px;
}
button{
  flex:1;
  background:#333;
  color:#eee;
  border:1px solid #555;
  border-radius:6px;
  font-size:18px;
  padding:12px 0;
}
button:active{background:#666;}
.dead{opacity:0.4;}
.partyRow{
  display:flex;
  gap:6px;
  margin:4px 0;
  font-size:18px;
}
.icon{
  width:18px;height:18px;border-radius:4px;
}
.barWrap{
  background:#333;
  height:10px;
  border-radius:5px;
  overflow:hidden;
}
.bar{background:#e74c3c;height:100%;}
.log{
  font-size:13px;
  max-height:90px;
  overflow:hidden;
}
.toggleOn{background:#2ecc71;}
</style>
</head>

<body>

<h2>聖杯オートRPG</h2>

<div class="panel">
撃破数 <span id="kills">0</span>　
聖杯Pt <span id="holy">0</span>
</div>

<div class="panel">
<strong>敵</strong>
<div id="enemyName"></div>
<div id="enemyText"></div>
<div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div class="panel">
<strong>パーティ</strong>
<div id="party"></div>
</div>

<div class="panel">
<strong>聖杯強化（恒久）</strong>
<div class="buttons">
<button onclick="upgrade('atk')">ATK+</button>
<button onclick="upgrade('def')">DEF+</button>
<button onclick="upgrade('hp')">HP+</button>
<button onclick="upgrade('exp')">EXP+</button>
</div>
<button id="autoBtn" onclick="toggleAutoUpgrade()">自動振りOFF</button>
</div>

<div class="panel log" id="log"></div>

<div class="panel buttons">
<button onclick="stepDungeon()">進む</button>
<button onclick="toggleAuto()">オート</button>
</div>

<script>
/* ===== データ ===== */
const CHAR_DATA=[
 {name:"レオン",job:"せんし",color:"#3498db"},
 {name:"ミラ",job:"とうぞく",color:"#f1c40f"},
 {name:"アーク",job:"まほうつかい",color:"#9b59b6"},
 {name:"セラ",job:"そうりょ",color:"#2ecc71"}
];
const JOBS={
 せんし:{hp:140,atk:10,def:8},
 とうぞく:{hp:100,atk:9,def:5},
 まほうつかい:{hp:80,atk:14,def:3},
 そうりょ:{hp:90,atk:6,def:4}
};
const ENEMY_NAMES=["スライム","ゴブリン","オーク","スケルトン"];

/* ===== クラス ===== */
class Enemy{
 constructor(){
  this.name=ENEMY_NAMES[Math.floor(Math.random()*ENEMY_NAMES.length)];
  this.maxHp=60;
  this.hp=this.maxHp;
  this.atk=8;
  this.def=3;
 }
}
class Character{
 constructor(d,bonus){
  const j=JOBS[d.job];
  this.name=d.name;
  this.job=d.job;
  this.color=d.color;
  this.level=1;
  this.exp=0;
  this.maxHp=j.hp+bonus.hp;
  this.atk=j.atk+bonus.atk;
  this.def=j.def+bonus.def;
  this.hp=this.maxHp;
  this.alive=true;
 }
}

/* ===== 状態 ===== */
let party=[];
let enemy=null;
let autoTimer=null;
let killCount=0;
let holyPoint=0;
let bonus={atk:0,def:0,hp:0,exp:0};
let autoUpgrade=false;

/* ===== ログ ===== */
function addLog(t){
 log.innerHTML=t+"<br>"+log.innerHTML;
}

/* ===== セーブ ===== */
function save(){
 localStorage.setItem("holyRPG",JSON.stringify({
  killCount,holyPoint,bonus,autoUpgrade
 }));
}
function load(){
 const r=localStorage.getItem("holyRPG");
 if(!r) return;
 const d=JSON.parse(r);
 killCount=d.killCount;
 holyPoint=d.holyPoint;
 bonus=d.bonus;
 autoUpgrade=d.autoUpgrade;
}

/* ===== 初期化 ===== */
function initParty(){
 party=CHAR_DATA.map(d=>new Character(d,bonus));
}

/* ===== バトル ===== */
function battle(end){
 const it=setInterval(()=>{
  party.forEach(c=>{
   if(!c.alive) return;
   enemy.hp-=Math.max(1,c.atk-enemy.def);
  });
  updateEnemyUI();
  if(enemy.hp<=0){
   clearInterval(it);
   killCount++;
   if(killCount%10===0){
    holyPoint++;
    addLog("聖杯Pt +1");
    if(autoUpgrade) autoSpend();
   }
   party.forEach(c=>{c.alive=true;c.hp=c.maxHp;});
   end();
   return;
  }
  const t=party.find(c=>c.alive);
  if(!t){
   party.forEach(c=>{c.alive=true;c.hp=c.maxHp;});
   addLog("全滅→自動復活");
   return;
  }
  t.hp-=Math.max(1,enemy.atk-t.def);
  if(t.hp<=0)t.alive=false;
  updateUI();
 },800/8);
}

/* ===== 操作 ===== */
function stepDungeon(){
 enemy=new Enemy();
 updateEnemyUI();
 battle(()=>{
  save();
  updateUI();
 });
}
function toggleAuto(){
 autoTimer?
 (clearInterval(autoTimer),autoTimer=null):
 (autoTimer=setInterval(stepDungeon,2000/8));
}
function upgrade(type){
 if(holyPoint<=0) return;
 holyPoint--;
 bonus[type]+= type==="hp"?10:1;
 initParty();
 addLog(type.toUpperCase()+" 永久強化");
 save();updateUI();
}
function autoSpend(){
 const keys=["atk","def","hp","exp"];
 upgrade(keys[Math.floor(Math.random()*keys.length)]);
}
function toggleAutoUpgrade(){
 autoUpgrade=!autoUpgrade;
 autoBtn.textContent=autoUpgrade?"自動振りON":"自動振りOFF";
 autoBtn.className=autoUpgrade?"toggleOn":"";
 save();
}

/* ===== UI ===== */
function updateUI(){
 kills.textContent=killCount;
 holy.textContent=holyPoint;
 partyEl.innerHTML="";
 party.forEach(c=>{
  const r=document.createElement("div");
  r.className="partyRow "+(c.alive?"":"dead");
  const i=document.createElement("div");
  i.className="icon";i.style.background=c.color;
  r.appendChild(i);
  r.appendChild(document.createTextNode(
   `${c.name}(${c.job}) HP${c.hp}/${c.maxHp} ATK${c.atk} DEF${c.def}`
  ));
  partyEl.appendChild(r);
 });
}
function updateEnemyUI(){
 if(!enemy) return;
 enemyName.textContent=enemy.name;
 enemyText.textContent=`HP ${enemy.hp}/${enemy.maxHp}`;
 enemyHpBar.style.width=(enemy.hp/enemy.maxHp*100)+"%";
}

/* ===== DOM ===== */
const partyEl=document.getElementById("party");
const enemyName=document.getElementById("enemyName");
const enemyText=document.getElementById("enemyText");
const enemyHpBar=document.getElementById("enemyHpBar");
const kills=document.getElementById("kills");
const holy=document.getElementById("holy");
const log=document.getElementById("log");
const autoBtn=document.getElementById("autoBtn");

/* ===== 起動 ===== */
load();
initParty();
toggleAutoUpgrade();
updateUI();
</script>

</body>
</html>