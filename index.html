<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>聖杯オートRPG</title>

<style>
body{
  margin:0;
  background:#111;
  color:#eee;
  font-family:sans-serif;
  font-size:14px;
  padding:6px;
}

h2{
  font-size:18px;
  margin:4px 0;
}

.panel{
  background:#1a1a1a;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
  margin-bottom:6px;
}

button{
  width:100%;
  background:#333;
  color:#eee;
  border:1px solid #555;
  border-radius:6px;
  font-size:18px;       /* ← ボタン文字大 */
  padding:10px 0;
  margin:4px 0;
}

button:active{
  background:#666;
  transform:scale(0.97);
}

button.active{
  background:#2ecc71;
  color:#000;
}

.dead{ opacity:0.4; }

.barWrap{
  background:#333;
  width:100%;
  height:10px;
  border-radius:5px;
  overflow:hidden;
}

.bar{
  background:#e74c3c;
  height:100%;
}
</style>
</head>

<body>

<h2>聖杯オートRPG</h2>

<div class="panel">
  距離：<span id="distance">0</span> m<br>
  転生：<span id="rebirth">0</span><br>
  聖杯Pt：<span id="holy">0</span>
</div>

<div class="panel">
  <strong>敵</strong>
  <div id="enemyText"></div>
  <div class="barWrap">
    <div id="enemyHpBar" class="bar"></div>
  </div>
</div>

<div class="panel">
  <strong>パーティ</strong>
  <div id="party"></div>
</div>

<div class="panel">
  <button onclick="stepDungeon()">進む</button>
  <button id="autoBtn" onclick="toggleAuto()">オート</button>
  <button id="speedBtn" onclick="changeSpeed()">倍速 ×1</button>
  <button onclick="rebirth()">転生</button>
</div>

<script>
/* ===== 職業定義 ===== */
const JOBS = {
  騎士:{ hp:120, atk:8, def:8, row:"front" },
  魔法:{ hp:80, atk:14, def:3, row:"back" },
  僧侶:{ hp:90, atk:6, def:5, row:"back" }
};

/* ===== キャラ ===== */
class Character{
  constructor(){
    this.job = Object.keys(JOBS)[Math.floor(Math.random()*3)];
    const j = JOBS[this.job];
    this.level=1;
    this.exp=0;
    this.baseHp=j.hp + holyPower.hp;
    this.baseAtk=j.atk + holyPower.atk;
    this.baseDef=j.def + holyPower.def;
    this.maxHp=this.baseHp;
    this.hp=this.maxHp;
    this.atk=this.baseAtk;
    this.def=this.baseDef;
    this.row=j.row;
    this.alive=true;
  }
}

/* ===== 敵 ===== */
class Enemy{
  constructor(dist){
    let mult=1;
    if(dist%100===0) mult=5;
    this.maxHp=Math.floor((40+dist*0.4)*mult);
    this.hp=this.maxHp;
    this.atk=Math.floor((6+dist*0.05)*mult);
    this.def=Math.floor(dist*0.02*mult);
  }
}

/* ===== 状態 ===== */
let distance=0;
let rebirthCount=0;
let holyPoint=0;
let holyPower={hp:0, atk:0, def:0};

let speed=1;
let autoTimer=null;
let currentEnemy=null;
let party=Array.from({length:5},()=>new Character());

/* ===== バトル ===== */
function calcDamage(c,e){
  let atk=c.atk;
  if(c.row==="back") atk*=1.2;
  return Math.max(1,Math.floor(atk-e.def));
}

function randomAlive(){
  const a=party.filter(c=>c.alive);
  return a[Math.floor(Math.random()*a.length)];
}

function reviveParty(){
  party.forEach(c=>{c.alive=true;c.hp=c.maxHp;});
}

function battle(enemy,end){
  const it=setInterval(()=>{
    for(const c of party){
      if(!c.alive) continue;
      enemy.hp-=calcDamage(c,enemy);
      if(enemy.hp<=0) break;
    }

    updateEnemyUI();

    if(enemy.hp<=0){
      clearInterval(it);
      reviveParty();
      end();
      return;
    }

    const t=randomAlive();
    let dmg=enemy.atk-t.def;
    if(t.row==="front") dmg*=0.7;
    t.hp-=Math.max(1,Math.floor(dmg));
    if(t.hp<=0) t.alive=false;

    if(!party.some(c=>c.alive)){
      clearInterval(it);
      reviveParty();
      end();
    }
    updateUI();
  },700/speed);
}

/* ===== 進行 ===== */
function stepDungeon(){
  distance+=10;
  currentEnemy=new Enemy(distance);
  updateEnemyUI();
  battle(currentEnemy,updateUI);
}

/* ===== UI ===== */
function updateUI(){
  distanceEl.textContent=distance;
  rebirthEl.textContent=rebirthCount;
  holyEl.textContent=holyPoint;
  partyEl.innerHTML="";
  party.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className=c.alive?"":"dead";
    d.textContent=
      `#${i+1} ${c.job} Lv${c.level} HP${c.hp}/${c.maxHp} ATK${c.atk} DEF${c.def}`;
    partyEl.appendChild(d);
  });
}

function updateEnemyUI(){
  if(!currentEnemy) return;
  enemyText.textContent=`HP ${currentEnemy.hp}/${currentEnemy.maxHp}`;
  enemyHpBar.style.width=(currentEnemy.hp/currentEnemy.maxHp*100)+"%";
}

/* ===== 操作 ===== */
function toggleAuto(){
  autoBtn.classList.toggle("active");
  if(autoTimer){
    clearInterval(autoTimer);
    autoTimer=null;
  }else{
    autoTimer=setInterval(stepDungeon,2000/speed);
  }
}

function changeSpeed(){
  speed = speed===1 ? 2 : speed===2 ? 4 : speed===4 ? 8 : 1;
  speedBtn.textContent=`倍速 ×${speed}`;
  speedBtn.classList.add("active");
  setTimeout(()=>speedBtn.classList.remove("active"),200);
}

/* ===== 転生 ===== */
function rebirth(){
  rebirthCount++;
  holyPoint+=5;
  holyPower.hp+=5;
  holyPower.atk+=2;
  holyPower.def+=2;
  distance=0;
  party=Array.from({length:5},()=>new Character());
  updateUI();
}

/* ===== DOM ===== */
const distanceEl=document.getElementById("distance");
const rebirthEl=document.getElementById("rebirth");
const holyEl=document.getElementById("holy");
const partyEl=document.getElementById("party");
const enemyText=document.getElementById("enemyText");
const enemyHpBar=document.getElementById("enemyHpBar");
const autoBtn=document.getElementById("autoBtn");
const speedBtn=document.getElementById("speedBtn");

updateUI();
</script>

</body>
</html>