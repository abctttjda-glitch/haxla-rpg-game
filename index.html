<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v1.4.0</title>
<style>
body{ margin:0; background:#111; color:#eee; font-family:sans-serif; font-size:16px; padding:6px; }
.version { position: absolute; top: 5px; right: 10px; font-size: 12px; color: #666; }
h2{margin:4px 0;font-size:22px; color:#f1c40f;}
.panel{ background:#1a1a1a; border:1px solid #444; border-radius:6px; padding:8px; margin-bottom:8px; }
button{ width:100%; background:#333; color:#eee; border:1px solid #555; border-radius:6px; font-size:16px; padding:8px 0; margin-top:4px; cursor: pointer; }
button:disabled{ opacity: 0.3; cursor: not-allowed; }
.toggleOn{background:#2ecc71;color:#000;font-weight:bold;}
.dead{opacity:0.4; filter: grayscale(100%);}
.partyRow{ font-size:14px; margin:8px 0; border-bottom: 1px solid #333; padding-bottom: 4px; }
.barWrap{ background:#333; height:8px; border-radius:4px; overflow:hidden; margin-top:4px; }
.bar{background:#e74c3c; height:100%; transition: width 0.2s;}
.log{ font-size:14px; height:120px; overflow-y:auto; background: #000; padding: 5px; display: flex; flex-direction: column-reverse; }
.warp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 5px; }
.warp-btn { font-size: 12px; padding: 4px 0; }
.stat-info { font-size: 12px; color: #aaa; margin-bottom: 4px; }
.amount-selector { display: flex; gap: 4px; margin-bottom: 8px; }
.amount-btn { font-size: 12px; padding: 4px; background: #222; }
.amount-btn.active { background: #f1c40f; color: #000; }
</style>
</head>
<body>

<div class="version">Version 1.4.0</div>
<h2>è–æ¯ã‚ªãƒ¼ãƒˆRPG</h2>

<div class="panel">
    <strong>éšå±¤: <span id="floor">1</span> / 100</strong> (å‘¨å›: <span id="loopCount">0</span>)<br>
    è–æ¯Pt: <span id="holy" style="color:#f1c40f; font-weight:bold;">0</span>ã€€æ’ƒç ´: <span id="kills">0</span>
    <div class="warp-grid" id="warpContainer"></div>
</div>

<div class="panel">
    <strong>è–æ¯å¼·åŒ–</strong>
    <div class="amount-selector">
        <button class="amount-btn active" onclick="setAmount(1)">x1</button>
        <button class="amount-btn" onclick="setAmount(10)">x10</button>
        <button class="amount-btn" onclick="setAmount(100)">x100</button>
        <button class="amount-btn" onclick="setAmount('MAX')">MAX</button>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
        <div>
            <div class="stat-info">ATKåŠ›: +<span id="b-atk">0</span></div>
            <button id="up-atk" onclick="upgrade('atk')">ATKå¼·åŒ–</button>
        </div>
        <div>
            <div class="stat-info">DEFåŠ›: +<span id="b-def">0</span></div>
            <button id="up-def" onclick="upgrade('def')">DEFå¼·åŒ–</button>
        </div>
        <div>
            <div class="stat-info">æœ€å¤§HP: +<span id="b-hp">0</span></div>
            <button id="up-hp" onclick="upgrade('hp')">HPå¼·åŒ–</button>
        </div>
        <div>
            <div class="stat-info">çµŒé¨“å€¤: +<span id="b-exp">0</span>%</div>
            <button id="up-exp" onclick="upgrade('exp')">EXPå¼·åŒ–</button>
        </div>
    </div>
    <button id="autoBtn" onclick="toggleAutoUpgrade()" style="margin-top:10px;">è‡ªå‹•æŒ¯ã‚Š OFF</button>
</div>

<div class="panel">
    <strong>æ•µ: <span id="enemyName"></span></strong>
    <div id="enemyText" style="font-size:12px"></div>
    <div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div class="panel">
    <strong>ãƒ‘ãƒ¼ãƒ†ã‚£ (Lv / è£…å‚™)</strong>
    <div id="party"></div>
</div>

<div class="panel log" id="log"></div>

<div class="panel" style="display:flex; gap:10px;">
    <button onclick="stepDungeon()" style="flex:1">é€²ã‚€</button>
    <button id="mainAutoBtn" onclick="toggleAuto()" style="flex:1">ã‚ªãƒ¼ãƒˆ</button>
</div>

<script>
const SPEED = 8;
let floor = 1, maxReachedFloor = 1, loopCount = 0, kills = 0, holy = 0;
let bonus = {atk:0, def:0, hp:0, exp:0};
let buyAmount = 1;
let autoUpgrade = false, autoIsOn = false;
let party = [], enemy = null;

const CHAR_DATA = [
    {name:"ãƒ¬ã‚ªãƒ³", job:"ã›ã‚“ã—", icon:"âš”ï¸"},
    {name:"ãƒŸãƒ©", job:"ã¨ã†ãã", icon:"ğŸ—¡ï¸"},
    {name:"ã‚¢ãƒ¼ã‚¯", job:"ã¾ã»ã†ã¤ã‹ã„", icon:"ğŸª„"},
    {name:"ã‚»ãƒ©", job:"ãã†ã‚Šã‚‡", icon:"ğŸ•Šï¸"}
];

const JOBS = { "ã›ã‚“ã—":{hp:140,atk:12,def:10}, "ã¨ã†ãã":{hp:100,atk:10,def:5}, "ã¾ã»ã†ã¤ã‹ã„":{hp:80,atk:18,def:3}, "ãã†ã‚Šã‚‡":{hp:110,atk:8,def:6} };

class Character {
    constructor(d) {
        this.name = d.name; this.job = d.job; this.icon = d.icon;
        this.level = 1; this.exp = 0; this.hp = 100; this.maxHp = 100;
        this.atk = 10; this.def = 5; this.eqAtk = 0; this.eqDef = 0; this.alive = true;
    }
    updateStats() {
        const j = JOBS[this.job];
        this.maxHp = j.hp + bonus.hp + (this.level - 1) * 15;
        this.atk = j.atk + bonus.atk + (this.level - 1) * 2;
        this.def = j.def + bonus.def + (this.level - 1) * 1;
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function setAmount(a) {
    buyAmount = a;
    document.querySelectorAll('.amount-btn').forEach(b => {
        b.classList.toggle('active', b.textContent.includes(a));
    });
}

function addLog(t, color="#eee") {
    const logBox = document.getElementById("log");
    const line = document.createElement("div");
    line.style.color = color;
    line.innerHTML = t;
    logBox.appendChild(line);
    if(logBox.childNodes.length > 20) logBox.removeChild(logBox.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("loopCount").textContent = loopCount;
    document.getElementById("kills").textContent = kills;
    document.getElementById("holy").textContent = holy;
    document.getElementById("b-atk").textContent = bonus.atk;
    document.getElementById("b-def").textContent = bonus.def;
    document.getElementById("b-hp").textContent = bonus.hp;
    document.getElementById("b-exp").textContent = bonus.exp * 10;

    const pEl = document.getElementById("party");
    pEl.innerHTML = "";
    party.forEach(c => {
        c.updateStats();
        const row = document.createElement("div");
        row.className = "partyRow " + (c.alive ? "" : "dead");
        const hpPer = (c.hp / c.maxHp) * 100;
        row.innerHTML = `<div>${c.icon}${c.name} Lv${c.level} <span style="font-size:11px; color:#aaa;">(æ”»+${c.eqAtk} é˜²+${c.eqDef})</span></div>
                         <div class="barWrap"><div class="bar" style="width:${hpPer}%"></div></div>`;
        pEl.appendChild(row);
    });
    updateWarpButtons();
}

function updateWarpButtons() {
    const container = document.getElementById("warpContainer");
    container.innerHTML = "";
    for(let i=1; i<=maxReachedFloor; i+=10) {
        const b = document.createElement("button");
        b.className = "warp-btn"; b.textContent = i + "F";
        b.onclick = () => { if(!enemy){ floor = i; addLog(i + "å±¤ã¸ç§»å‹•ã—ã¾ã—ãŸ"); updateUI(); save(); }};
        container.appendChild(b);
    }
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            let dmg = Math.max(1, (c.atk + c.eqAtk) - enemy.def);
            enemy.hp -= dmg;
            if(enemy.hp <= 0) {
                enemy.hp = 0; addLog(`${enemy.name}ã‚’æ’ƒç ´ï¼`);
                kills++;
                if(Math.random() < 0.3) {
                    const target = party[Math.floor(Math.random()*4)];
                    const val = Math.floor(Math.random()*(floor + loopCount*10))+1;
                    if(Math.random()>0.5) { if(val > target.eqAtk){target.eqAtk=val; addLog(`${target.name}ã®æ­¦å™¨æ›´æ–°+${val}`,"#f39c12");}}
                    else { if(val > target.eqDef){target.eqDef=val; addLog(`${target.name}ã®é˜²å…·æ›´æ–°+${val}`,"#f39c12");}}
                }
                if(floor >= 100) { floor = 1; loopCount++; addLog("å‘¨å›é”æˆï¼"); } else { floor++; }
                if(floor > maxReachedFloor) maxReachedFloor = floor;
                clearInterval(it); enemy = null;
                save();
                if(autoIsOn) setTimeout(stepDungeon, 400);
                updateUI();
            }
        });
        if(enemy) {
            const target = party.find(c => c.alive);
            if(!target) {
                clearInterval(it); addLog("å…¨æ»…...å¾©æ´»ã—ã¾ã™");
                party.forEach(c => { c.hp = c.maxHp; c.alive = true; });
                enemy = null; save();
                if(autoIsOn) setTimeout(stepDungeon, 1000);
                updateUI(); return;
            }
            let eDmg = Math.max(1, enemy.atk - (target.def + target.eqDef));
            target.hp -= eDmg; if(target.hp <= 0) { target.hp = 0; target.alive = false; }
        }
        updateUI();
        if(enemy) {
            document.getElementById("enemyName").textContent = enemy.name;
            document.getElementById("enemyText").textContent = `HP: ${Math.floor(enemy.hp)}`;
            document.getElementById("enemyHpBar").style.width = (enemy.hp/enemy.maxHp*100) + "%";
        }
    }, 800 / SPEED);
}

function stepDungeon() {
    if(enemy) return;
    const power = (1 + loopCount);
    enemy = { name: (floor%10===0?"ğŸ‘¹BOSS":"ğŸ‘¾MON"), maxHp:(50+floor*20)*power, hp:(50+floor*20)*power, atk:(5+floor*2)*power, def:(2+floor)*power };
    if(floor%10===0) holy++; 
    battleLoop();
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }

function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost;
    bonus[t] += (t === "hp" ? cost * 20 : cost * 3);
    updateUI();
    save();
}

function toggleAutoUpgrade() { autoUpgrade=!autoUpgrade; document.getElementById("autoBtn").className=autoUpgrade?"toggleOn":""; }

function save() {
    const data = { floor, maxReachedFloor, loopCount, kills, holy, bonus, autoUpgrade, party: party.map(c => ({
        level: c.level, exp: c.exp, hp: c.hp, eqAtk: c.eqAtk, eqDef: c.eqDef
    }))};
    localStorage.setItem("holyRPG_v140", JSON.stringify(data));
}

function load() {
    party = CHAR_DATA.map(d => new Character(d));
    const saved = localStorage.getItem("holyRPG_v140");
    if(saved) {
        const d = JSON.parse(saved);
        floor = d.floor; maxReachedFloor = d.maxReachedFloor; loopCount = d.loopCount;
        kills = d.kills; holy = d.holy; bonus = d.bonus; autoUpgrade = d.autoUpgrade;
        d.party.forEach((p, i) => {
            party[i].level = p.level; party[i].exp = p.exp; party[i].hp = p.hp;
            party[i].eqAtk = p.eqAtk; party[i].eqDef = p.eqDef;
        });
    }
    if(autoUpgrade) document.getElementById("autoBtn").className="toggleOn";
}

load();
updateUI();
</script>
</body>
</html>
