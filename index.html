<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v2.8.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --main-bg: #111; --panel-bg: #1e1e1e; --accent: #f1c40f; --text: #eee; --btn-bg: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { 
    margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:12px; padding:4px;
    height: 100dvh; overflow:hidden; display:flex; flex-direction:column;
}
.panel { background:var(--panel-bg); border:1px solid #444; border-radius:6px; padding:4px; margin-bottom:4px; }
button { background:var(--btn-bg); color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; font-weight:bold; }
.active { background:var(--accent) !important; color:#000 !important; }
.toggleOn { background:#2ecc71 !important; color:#000 !important; }

.header { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; height: 45px; }
.top-right { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }

.enemy-box { display: flex; align-items: center; gap: 5px; height: 22px; margin-bottom: 4px; }
.hp-bar-outer { flex-grow: 1; background:#333; height:12px; border-radius:6px; overflow:hidden; position:relative; border:1px solid #555; }
.hp-bar-inner { background:#e74c3c; height:100%; width:0%; transition: width 0.1s; }
.hp-text { position:absolute; width:100%; text-align:center; font-size:9px; top:0; line-height:10px; font-weight:bold; }

.main-content { display: flex; flex: 1; min-height: 0; gap: 4px; margin-bottom: 4px; }
.party-list { flex: 1.4; overflow-y: auto; }
.log { flex: 1; background:#000; padding:2px; overflow-y:auto; display:flex; flex-direction:column-reverse; font-size: 9px; border-radius: 4px; border: 1px solid #333; line-height: 1.2; }

.char-card { border-bottom: 1px solid #333; padding: 4px 0; cursor: pointer; }
.char-head { display: flex; justify-content: space-between; font-weight: bold; font-size: 11px; }
.job-label { color: var(--accent); font-size: 9px; background: rgba(241,196,15,0.1); padding: 0 2px; border-radius: 2px; }

.footer { height: 50px; display: grid; grid-template-columns: 1fr 2fr; gap: 4px; }
.footer button { font-size: 16px; }

.modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#2c3e50; border:2px solid #555; border-radius:10px; width:90%; max-width:320px; padding:15px; }
.skill-item { background: rgba(0,0,0,0.2); margin: 4px 0; padding: 4px; border-radius:4px; cursor: help; }
</style>
</head>
<body>

<div class="header">
    <div class="panel" onclick="openPetInfo()" style="cursor:help;">
        <strong><span id="floor">1</span>F</strong> <small>(<span id="holy">0</span>Pt)</small>
        <div style="font-size:9px; color:#a29bfe;">ğŸ¾Lv<span id="petLv">1</span> <span id="killCount">0/10</span> (è©³ç´°)</div>
    </div>
    <div class="top-right">
        <button onclick="openModal('upgradeModal')">âœ¨å¼·åŒ–</button>
        <button onclick="openModal('casinoModal')">ğŸ°ï½¶ï½¼ï¾ï¾‰</button>
        <button onclick="warpMax()" style="grid-column: span 2; font-size:10px;">Warp Max</button>
    </div>
</div>

<div class="panel enemy-box">
    <div id="enemyName" style="font-size:10px; min-width:65px; font-weight:bold; overflow:hidden;">---</div>
    <div class="hp-bar-outer">
        <div id="enemyHpBar" class="hp-bar-inner"></div>
        <div id="enemyHpNum" class="hp-text">0/0</div>
    </div>
</div>

<div class="main-content">
    <div class="panel party-list" id="partyList"></div>
    <div class="log" id="log"></div>
</div>

<div class="footer">
    <button onclick="stepDungeon()">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<div id="charModal" class="modal"><div class="modal-content" id="m-content"></div></div>
<div id="petModal" class="modal"><div class="modal-content" id="pet-content"></div></div>

<div id="upgradeModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0; text-align:center;">âœ¨è–æ¯å¼·åŒ– (Pt:<span id="holy2">0</span>)</h3>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:4px; margin:10px 0;">
            <button id="amt1" onclick="setAmount(1)">x1</button>
            <button id="amt10" onclick="setAmount(10)">x10</button>
            <button id="amtMAX" onclick="setAmount('MAX')">MAX</button>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:10px;">
            <button onclick="upgrade('atk')">æ”»æ’ƒ +<span id="b-atk">0</span></button>
            <button onclick="upgrade('def')">é˜²å¾¡ +<span id="b-def">0</span></button>
            <button onclick="upgrade('hp')">æœ€å¤§HP +<span id="b-hp">0</span></button>
            <button onclick="upgrade('exp')">çµŒé¨“å€¤ +<span id="b-exp">0</span></button>
        </div>
        <button id="autoUpBtn" style="width:100%; padding:10px;" onclick="toggleAutoUpgrade()">è‡ªå‹•å¼·åŒ–: OFF</button>
        <button onclick="closeModal('upgradeModal')" style="width:100%; margin-top:10px; background:#c0392b;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="casinoModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 style="margin:0; color:var(--accent);">è–æ¯ã‚«ã‚¸ãƒ</h3>
        <div id="slot" style="font-size:32px; margin:15px 0; background:#000; border-radius:8px; padding:10px;">â“ â“ â“</div>
        <div id="casinoResult" style="min-height:1.2em; font-weight:bold; color:var(--accent); margin-bottom:10px;"></div>
        <button onclick="playCasino()" id="spinBtn" style="width:100%; padding:12px; background:#27ae60;">ã‚¹ãƒ”ãƒ³ (1Pt)</button>
        <button onclick="closeModal('casinoModal')" style="width:100%; margin-top:10px; background:#c0392b;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
const SAVE_KEY = "HolyRPG_Balance_v2.8";
let floor=1, maxReachedFloor=1, kills=0, totalKills=0, holy=0, petLv=1;
let bonus={atk:0, def:0, hp:0, exp:0}, buyAmount=1, autoIsOn=false, autoUpgrade=false;
let party=[], enemy=null;

const JOB_DATA = {
    "ã›ã‚“ã—": {h:180, a:16, d:16, active:"å¼·æ’ƒ", pass:"ä¸å±ˆã®å¿ƒ", descA:"1.5å€ãƒ€ãƒ¡ãƒ¼ã‚¸", descP:"HPãŒ30%å¢—åŠ "},
    "ã¨ã†ãã": {h:120, a:14, d:10, active:"æ€¥æ‰€çªã", pass:"ç²¾å¯†å‹•ä½œ", descA:"2.5å€ãƒ€ãƒ¡ãƒ¼ã‚¸", descP:"æ”»æ’ƒåŠ›ãŒ20%å¢—åŠ "},
    "ã¾ã»ã†ã¤ã‹ã„": {h:100, a:30, d:7, active:"ãƒ¡ãƒ†ã‚ª", pass:"é­”åŠ›å¾ªç’°", descA:"å…¨ä½“å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸", descP:"æ”»æ’ƒåŠ›ãŒ40%å¢—åŠ "},
    "ãã†ã‚Šã‚‡": {h:140, a:12, d:12, active:"ãƒ’ãƒ¼ãƒ«", pass:"ç¥ˆã‚Š", descA:"å‘³æ–¹ã®HPã‚’å›å¾©", descP:"é˜²å¾¡åŠ›ãŒ30%å¢—åŠ "},
    "å‹‡è€…": {h:350, a:50, d:35, active:"è¦‡ç‹æ–¬", pass:"è–æ¯ã®åŠ è­·", descA:"3.5å€ãƒ€ãƒ¡ãƒ¼ã‚¸", descP:"å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤§å¹…å¢—"}
};

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.alive=true;
        this.weapon={name:"æœ¨ã®æ£’",val:0}; this.armor={name:"å¸ƒã®æœ",val:0};
    }
    updateStats() {
        const j = JOB_DATA[this.job];
        // ã‚¤ãƒ³ãƒ•ãƒ¬æŠ‘åˆ¶: æŒ‡æ•°é–¢æ•°çš„å¢—åŠ ã‚’é¿ã‘ã€ãƒ¬ãƒ™ãƒ«ä¿‚æ•°ã‚’ãƒã‚¤ãƒ«ãƒ‰ã«
        const lvBonus = 1 + (this.level - 1) * 0.08; 
        const passMult = (this.job === "ã›ã‚“ã—" ? 1.3 : 1.0); // ãƒ‘ãƒƒã‚·ãƒ–åŠ¹æœã‚’åæ˜ 
        this.maxHp = Math.floor((j.h + bonus.hp + (this.level-1)*35) * lvBonus * (this.job==="ã›ã‚“ã—"?1.3:1));
        this.atk = Math.floor((j.a + bonus.atk + (this.level-1)*5 + this.weapon.val) * lvBonus * (this.job==="ã¨ã†ãã"?1.2:this.job==="ã¾ã»ã†ã¤ã‹ã„"?1.4:1));
        this.def = Math.floor((j.d + bonus.def + (this.level-1)*4 + this.armor.val) * lvBonus * (this.job==="ãã†ã‚Šã‚‡"?1.3:1));
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function openModal(id) { document.getElementById(id).style.display = "flex"; updateUI(); }
function closeModal(id) { document.getElementById(id).style.display = "none"; }

function showCharDetail(idx) {
    const c = party[idx];
    const j = JOB_DATA[c.job];
    document.getElementById("m-content").innerHTML = `
        <h3 style="margin:0">${c.icon} ${c.name} <span class="job-label">${c.job}</span></h3>
        <hr style="border:0; border-top:1px solid #555; margin:8px 0;">
        <p>Lv:${c.level} | ATK:${c.atk} | DEF:${c.def}</p>
        <div class="skill-item" onclick="alert('ã€${j.active}ã€‘\\nåŠ¹æœ: ${j.descA}')">
            <strong>ğŸ”¥ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${j.active}</strong><br><small>(ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º)</small>
        </div>
        <div class="skill-item" onclick="alert('ã€${j.pass}ã€‘\\nåŠ¹æœ: ${j.descP}')">
            <strong>ğŸ›¡ï¸ãƒ‘ãƒƒã‚·ãƒ–: ${j.pass}</strong><br><small>(ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º)</small>
        </div>
        <div style="background:rgba(0,0,0,0.2); padding:5px; border-radius:4px; font-size:10px;">
            âš”ï¸ ${c.weapon.name}(+${c.weapon.val}) / ğŸ›¡ï¸ ${c.armor.name}(+${c.armor.val})
        </div>
        <button onclick="closeModal('charModal')" style="width:100%; margin-top:10px; padding:10px;">é–‰ã˜ã‚‹</button>
    `;
    openModal("charModal");
}

function openPetInfo() {
    document.getElementById("pet-content").innerHTML = `
        <h3 style="margin:0">ğŸ¾ æ—…ã®ç›¸æ£’ï¼ˆãƒšãƒƒãƒˆï¼‰</h3>
        <hr style="border:0; border-top:1px solid #555; margin:8px 0;">
        <p>ç¾åœ¨ã®Lv: ${petLv}</p>
        <p><strong>å½¹å‰²1: è¿½æ’ƒ</strong><br>æˆ¦é—˜ä¸­ã«ä¸€å®šç¢ºç‡ã§æ•µã«å›ºå®šãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã¾ã™ã€‚LvãŒé«˜ã„ã»ã©ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ï¼</p>
        <p><strong>å½¹å‰²2: è–æ¯ã®åŠ è­·</strong><br>æ•µã‚’50ä½“å€’ã™ã”ã¨ã«ãƒšãƒƒãƒˆã®LvãŒä¸ŠãŒã‚Šã€æ¢ç´¢ãŒæœ‰åˆ©ã«ãªã‚Šã¾ã™ã€‚</p>
        <button onclick="closeModal('petModal')" style="width:100%; margin-top:10px; padding:10px;">ãªã‚‹ã»ã©</button>
    `;
    openModal("petModal");
}

function addLog(t, color="#eee") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    line.style.color = color; line.innerText = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 20) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").innerText = floor;
    document.getElementById("holy").innerText = holy;
    document.getElementById("holy2").innerText = holy;
    document.getElementById("killCount").innerText = `${kills%10}/10`;
    document.getElementById("petLv").innerText = petLv;
    document.getElementById("b-atk").innerText = bonus.atk;
    document.getElementById("b-def").innerText = bonus.def;
    document.getElementById("b-hp").innerText = bonus.hp;
    document.getElementById("b-exp").innerText = bonus.exp;
    document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : "";
    document.getElementById("autoUpBtn").innerText = `è‡ªå‹•å¼·åŒ–: ${autoUpgrade ? "ON" : "OFF"}`;

    const pList = document.getElementById("partyList");
    pList.innerHTML = "";
    party.forEach((c, i) => {
        c.updateStats();
        const div = document.createElement("div");
        div.className = "char-card " + (c.alive ? "" : "dead");
        div.onclick = () => showCharDetail(i);
        div.innerHTML = `
            <div class="char-head"><span>${c.icon}${c.name} <small>Lv${c.level}</small></span><span>HP:${Math.floor(c.hp)}</span></div>
            <div style="font-size:9px; color:#aaa;">${c.job} | âš”ï¸+${c.weapon.val} ğŸ›¡ï¸+${c.armor.val}</div>
        `;
        pList.appendChild(div);
    });
}

function stepDungeon() {
    if(enemy) return;
    const mons = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚´ãƒ–ãƒªãƒ³","ã‚ªãƒ¼ã‚¯","ã‚³ãƒœãƒ«ãƒˆ","ãƒŸã‚¤ãƒ©","ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«","ãƒ‡ãƒ¼ãƒ¢ãƒ³"];
    const name = (floor%10===0?"BOSS ":"") + mons[Math.min(mons.length-1, Math.floor(floor/25))];
    // æ•µã®ã‚¤ãƒ³ãƒ•ãƒ¬èª¿æ•´: ä¿‚æ•°ã‚’1.08ã«ä¸‹ã’ã€ä½“åŠ›ã®ä¼¸ã³ã‚’ãƒã‚¤ãƒ«ãƒ‰ã«
    const power = Math.pow(1.08, Math.floor(floor/5));
    enemy = { name: name, maxHp:(200+floor*50)*power, hp:0, atk:(10+floor*5)*power, def:(5+floor*3)*power };
    enemy.hp = enemy.maxHp;
    battleLoop();
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            let dmg = Math.max(1, c.atk - enemy.def);
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚­ãƒ«
            if(Math.random() < 0.15) {
                const s = JOB_DATA[c.job].active;
                if(c.job === "ãã†ã‚Šã‚‡") { c.hp = Math.min(c.maxHp, c.hp + c.atk * 2); addLog(`ğŸ•Šï¸${s}`, "#2ecc71"); }
                else { 
                    const mult = (c.job==="å‹‡è€…"?3.5 : c.job==="ã¨ã†ãã"?2.5 : 1.5);
                    dmg *= mult; addLog(`${c.icon}${s}!`, "#3498db"); 
                }
            }
            // ãƒšãƒƒãƒˆè¿½æ’ƒ
            if(Math.random() < 0.05) { enemy.hp -= (petLv * 20); addLog("ğŸ¾è¿½æ’ƒ!", "#a29bfe"); }
            
            enemy.hp -= dmg;
            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); 
                kills++; totalKills++;
                // è–æ¯Ptç²å¾—
                if(kills % 10 === 0) { 
                    holy++; 
                    addLog("âœ¨è–æ¯Ptç²å¾—ï¼", "#f1c40f");
                    if(autoUpgrade) autoDistribute(); 
                }
                if(totalKills % 50 === 0) { petLv++; addLog("ğŸ¾ãƒšãƒƒãƒˆLvUP!"); }
                if(Math.random()<0.2) dropGear();
                
                party.forEach(char => {
                    char.exp += 25 * (1+bonus.exp*0.1);
                    if(char.exp >= 100){ char.level++; char.exp=0; char.hp=char.maxHp; }
                });
                floor++; if(floor>maxReachedFloor) maxReachedFloor=floor;
                enemy=null; save(); if(autoIsOn) setTimeout(stepDungeon, 50);
                updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t){ clearInterval(it); floor=Math.max(1, floor-3); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0) t.alive=false;
        }
        document.getElementById("enemyName").innerText = enemy ? enemy.name : "---";
        document.getElementById("enemyHpNum").innerText = enemy ? `${Math.floor(enemy.hp)}` : "0";
        document.getElementById("enemyHpBar").style.width = enemy ? (enemy.hp/enemy.maxHp*100)+"%" : "0%";
        updateUI();
    }, 60);
}

function dropGear() {
    const target = party[Math.floor(Math.random()*party.length)];
    const val = Math.floor(floor * 1.5);
    if(Math.random()>0.5) { target.weapon.val = val; addLog(`ğŸ${target.name}æ­¦å™¨UP`); }
    else { target.armor.val = val; addLog(`ğŸ${target.name}é˜²å…·UP`); }
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function setAmount(a) { buyAmount = a; ["amt1", "amt10", "amtMAX"].forEach(id => document.getElementById(id).classList.toggle("active", id.includes(a))); }

function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost; 
    const gain = (t==='hp'?cost*40:cost*4);
    bonus[t] += gain; 
    addLog(`âœ¨${t.toUpperCase()}å¼·åŒ– +${gain}`, "#f1c40f");
    updateUI(); save();
}

function toggleAutoUpgrade() { 
    autoUpgrade = !autoUpgrade; 
    updateUI();
}

function autoDistribute() { 
    const stats = ['atk','def','hp','exp'];
    const selected = stats[Math.floor(Math.random()*4)];
    const cost = 1; 
    if(holy >= cost) {
        holy -= cost; 
        const gain = (selected==='hp'?50:5);
        bonus[selected] += gain;
        addLog(`ğŸ¤–è‡ªå‹•å¼·åŒ–: ${selected} +${gain}`, "#2ecc71");
        updateUI();
    }
}

function warpMax() { if(!enemy){ floor = maxReachedFloor; updateUI(); }}

function playCasino() {
    if(holy < 1) return;
    holy--; updateUI();
    const slot = document.getElementById("slot");
    const spinBtn = document.getElementById("spinBtn");
    spinBtn.disabled = true;
    let timer = 0;
    const interval = setInterval(() => {
        const items = ["ğŸ’","âš”ï¸","ğŸ€","â­","ğŸ"];
        slot.innerText = items[Math.floor(Math.random()*5)] + " " + items[Math.floor(Math.random()*5)] + " " + items[Math.floor(Math.random()*5)];
        if(++timer > 10) {
            clearInterval(interval);
            if(Math.random() < 0.1) { holy += 10; document.getElementById("casinoResult").innerText = "å¤§å½“ã‚Šï¼Pt+10"; }
            else { bonus.atk += 10; document.getElementById("casinoResult").innerText = "æ”»æ’ƒåŠ›+10"; }
            spinBtn.disabled = false; updateUI(); save();
        }
    }, 80);
}

function save() {
    const data = { floor, maxReachedFloor, holy, bonus, petLv, totalKills, autoUpgrade, party: party.map(c => ({
        name:c.name, job:c.job, icon:c.icon, level:c.level, hp:c.hp, weapon:c.weapon, armor:c.armor
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}
function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        try {
            const d = JSON.parse(saved);
            floor=d.floor||1; maxReachedFloor=d.maxReachedFloor||1; holy=d.holy||0; 
            bonus=d.bonus||{atk:0,def:0,hp:0,exp:0}; petLv=d.petLv||1; totalKills=d.totalKills||0;
            autoUpgrade=d.autoUpgrade||false;
            party = d.party.map(p => { 
                let c=new Character(p.name, p.job, p.icon); c.level=p.level; c.hp=p.hp; 
                c.weapon=p.weapon; c.armor=p.armor; return c; 
            });
        } catch(e) { initParty(); }
    } else { initParty(); }
}
function initParty() {
    party = [new Character("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Character("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Character("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Character("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
}
load(); updateUI();
</script>
</body>
</html>
