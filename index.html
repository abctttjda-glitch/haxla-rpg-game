<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v2.2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
:root { --main-bg: #111; --panel-bg: #1e1e1e; --accent: #f1c40f; --text: #eee; }
body { margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:14px; padding:4px; height:100vh; overflow:hidden; display:flex; flex-direction:column; }
.panel { background:var(--panel-bg); border:1px solid #444; border-radius:6px; padding:4px; margin-bottom:4px; }
button { background:#333; color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; font-size:14px; }
.active { background:var(--accent) !important; color:#000 !important; font-weight:bold; }
.toggleOn { background:#2ecc71; color:#000; font-weight:bold; }

/* ä¸Šéƒ¨æƒ…å ± */
.header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 2px; }

/* æ•µãƒ‘ãƒãƒ« */
.enemy-panel { display: flex; align-items: center; gap: 8px; padding: 4px 8px; }
.hp-bar-outer { flex-grow: 1; background:#333; height:12px; border-radius:6px; overflow:hidden; position:relative; }
.hp-bar-inner { background:#e74c3c; height:100%; width:0%; transition: width 0.1s; }
.hp-text { position:absolute; width:100%; text-align:center; font-size:10px; font-weight:bold; top:0; }

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ï¼†ãƒ­ã‚°ï¼‰ */
.main-content { display: grid; grid-template-columns: 1.3fr 1fr; gap: 4px; flex-grow: 1; min-height: 0; }
.party-list { overflow-y: hidden; }
.char-card { border-bottom: 1px solid #333; padding: 2px 0; font-size: 12px; }
.eq-row { font-size: 10px; color: #aaa; white-space: nowrap; overflow: hidden; }

/* ãƒ­ã‚°ï¼ˆã‚¹ãƒªãƒ åŒ–ï¼‰ */
.log { background:#000; padding:4px; overflow-y:auto; display:flex; flex-direction:column-reverse; border:1px solid #444; border-radius:4px; font-size: 11px; line-height: 1.2; }
.drop-msg { color: #f39c12; font-weight: bold; }
.skill-msg { color: #3498db; }

/* å¼·åŒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.upgrade-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
.stat-btn { display: flex; flex-direction: column; align-items: center; padding: 4px 0; font-size: 11px; }

/* ãƒ•ãƒƒã‚¿ãƒ¼æ“ä½œ */
.footer-btns { display: grid; grid-template-columns: 1fr 2fr; gap: 4px; margin-top: 4px; }
.footer-btns button { padding: 10px 0; font-weight: bold; }
</style>
</head>
<body>

<div class="header-grid">
    <div class="panel" style="font-size:12px;">
        <strong><span id="floor">1</span>F</strong> <small>(<span id="holy">0</span>Pt)</small><br>
        ğŸ¾Lv<span id="petLv">1</span> <span id="killCount">0/10</span>
    </div>
    <div class="panel" style="display:grid; grid-template-columns:1fr 1fr; gap:2px;">
        <button onclick="playCasino()" style="font-size:10px;">ğŸ°ã‚«ã‚¸ãƒ</button>
        <button onclick="warpMax()" style="font-size:10px;">Warp</button>
        <button id="autoUpBtn" style="font-size:10px; grid-column:span 2" onclick="toggleAutoUpgrade()">è‡ªå‹•å¼·åŒ–:OFF</button>
    </div>
</div>

<div class="panel enemy-panel">
    <div style="font-size:12px; font-weight:bold; min-width:50px;" id="enemyName">---</div>
    <div class="hp-bar-outer">
        <div id="enemyHpBar" class="hp-bar-inner"></div>
        <div class="hp-text" id="enemyHpNum">0/0</div>
    </div>
</div>

<div class="main-content">
    <div class="panel party-list" id="partyList"></div>
    <div class="log" id="log"></div>
</div>

<div class="panel">
    <div style="display:flex; justify-content:space-around; margin-bottom:4px;">
        <button id="amt1" style="width:28%" onclick="setAmount(1)">x1</button>
        <button id="amt10" style="width:28%" onclick="setAmount(10)">x10</button>
        <button id="amtMAX" style="width:28%" onclick="setAmount('MAX')">MAX</button>
    </div>
    <div class="upgrade-section">
        <button class="stat-btn" onclick="upgrade('atk')"><span>æ”»</span><strong>+<span id="b-atk">0</span></strong></button>
        <button class="stat-btn" onclick="upgrade('def')"><span>é˜²</span><strong>+<span id="b-def">0</span></strong></button>
        <button class="stat-btn" onclick="upgrade('hp')"><span>å‘½</span><strong>+<span id="b-hp">0</span></strong></button>
        <button class="stat-btn" onclick="upgrade('exp')"><span>çµŒ</span><strong>+<span id="b-exp">0</span></strong></button>
    </div>
</div>

<div class="footer-btns">
    <button onclick="stepDungeon()">æ¢ç´¢</button>
    <button id="mainAutoBtn" onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<script>
const SAVE_KEY = "HolyRPG_Persistent_Data_v2.2";
let floor=1, maxReachedFloor=1, loopCount=0, kills=0, holy=0, petLv=1;
let bonus={atk:0, def:0, hp:0, exp:0}, buyAmount=1, autoIsOn=false, autoUpgrade=false, heroUnlocked=false;
let party=[], enemy=null;

class Character {
    constructor(name, job, icon) {
        this.name=name; this.job=job; this.icon=icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.alive=true;
        this.weapon = { name: "æœ¨ã®æ£’", val: 0 };
        this.armor = { name: "å¸ƒã®æœ", val: 0 };
    }
    updateStats() {
        const j = {"ã›ã‚“ã—":{h:150,a:12,d:12},"ã¨ã†ãã":{h:100,a:11,d:6},"ã¾ã»ã†ã¤ã‹ã„":{h:80,a:22,d:4},"ãã†ã‚Šã‚‡":{h:120,a:8,d:8},"å‹‡è€…":{h:250,a:35,d:20}}[this.job];
        const awake = 1 + Math.floor(this.level/10)*0.15;
        this.maxHp = Math.floor((j.h + (bonus.hp||0) + (this.level-1)*45) * awake);
        this.atk = Math.floor((j.a + (bonus.atk||0) + (this.level-1)*7 + this.weapon.val) * awake);
        this.def = Math.floor((j.d + (bonus.def||0) + (this.level-1)*5 + this.armor.val) * awake);
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function addLog(t, cls="") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    if(cls) line.className = cls;
    line.innerText = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 20) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("holy").textContent = holy;
    document.getElementById("killCount").textContent = `${kills%10}/10`;
    document.getElementById("petLv").textContent = petLv;
    document.getElementById("b-atk").textContent = bonus.atk;
    document.getElementById("b-def").textContent = bonus.def;
    document.getElementById("b-hp").textContent = bonus.hp;
    document.getElementById("b-exp").textContent = bonus.exp;

    const pEl = document.getElementById("partyList");
    pEl.innerHTML = "";
    party.forEach(c => {
        c.updateStats();
        const card = document.createElement("div");
        card.className = "char-card " + (c.alive ? "" : "dead");
        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span>${c.icon}${c.name} <small>Lv${c.level}</small></span>
                <span>HP:${Math.floor(c.hp)}</span>
            </div>
            <div class="eq-row">âš”ï¸${c.weapon.name}(+${c.weapon.val})</div>
            <div class="eq-row">ğŸ›¡ï¸${c.armor.name}(+${c.armor.val})</div>`;
        pEl.appendChild(card);
    });
}

function dropGear() {
    const target = party[Math.floor(Math.random()*party.length)];
    const isWep = Math.random() > 0.5;
    const mats = ["é‰„","é‹¼","éŠ€","é‡‘","é­”","ç¥"];
    const mat = mats[Math.min(5, Math.floor(floor/150))];
    const val = Math.floor(floor * 1.5 + Math.random()*floor);
    if(isWep && val > target.weapon.val) {
        target.weapon = { name: mat+"ã®å‰£", val: val };
        addLog(`ğŸ${target.name}:æ­¦å™¨UP`, "drop-msg");
    } else if(!isWep && val > target.armor.val) {
        target.armor = { name: mat+"ã®é§", val: val };
        addLog(`ğŸ${target.name}:é˜²å…·UP`, "drop-msg");
    }
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            if(Math.random()<0.1) { enemy.hp -= (petLv*15); addLog("ğŸ¾ãƒšãƒƒãƒˆè¿½æ’ƒ", "skill-msg"); }
            let dmg = Math.max(1, c.atk - enemy.def);
            if(Math.random()<0.2) { dmg*=2; addLog(`${c.icon}ã‚¹ã‚­ãƒ«`, "skill-msg"); }
            enemy.hp -= dmg;

            if(enemy.hp <= 0) {
                enemy.hp = 0; clearInterval(it); kills++;
                if(kills%10===0) { holy++; if(autoUpgrade) autoDistribute(); }
                if(kills%50===0) petLv++;
                if(Math.random()<0.3) dropGear();
                party.forEach(char => {
                    char.exp += 20 * (1+bonus.exp*0.1);
                    if(char.exp >= 50){ char.level++; char.exp=0; char.hp=char.maxHp; addLog(`â˜…${char.name} Lv${char.level}`); }
                });
                if(floor===100 && !heroUnlocked){ heroUnlocked=true; party[0].job="å‹‡è€…"; party[0].icon="ğŸ‘‘"; addLog("ğŸ‘‘å‹‡è€…è¦šé†’ï¼"); }
                if(floor>=1000){ floor=1; loopCount++; } else { floor++; }
                if(floor>maxReachedFloor) maxReachedFloor=floor;
                enemy=null; save(); if(autoIsOn) setTimeout(stepDungeon, 50);
                updateUI();
            }
        });
        if(enemy) {
            const t = party.find(c => c.alive);
            if(!t){ clearInterval(it); floor=Math.max(1, floor-10); party.forEach(c=>{c.hp=c.maxHp;c.alive=true;}); enemy=null; updateUI(); save(); if(autoIsOn) setTimeout(stepDungeon, 500); return; }
            t.hp -= Math.max(1, enemy.atk - t.def); if(t.hp<=0) t.alive=false;
        }
        document.getElementById("enemyName").textContent = enemy?enemy.name:"---";
        document.getElementById("enemyHpNum").textContent = enemy?Math.floor(enemy.hp):"0";
        document.getElementById("enemyHpBar").style.width = enemy?(enemy.hp/enemy.maxHp*100)+"%":"0%";
        updateUI();
    }, 50);
}

function stepDungeon() {
    if(enemy) return;
    const p = (1 + loopCount + floor/100);
    enemy = { name: (floor%10===0?"BOSS":"MON"), maxHp:(200+floor*60)*p, hp:0, atk:(15+floor*7)*p, def:(10+floor*4)*p };
    enemy.hp = enemy.maxHp;
    battleLoop();
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }
function setAmount(a) { buyAmount = a; ["amt1", "amt10", "amtMAX"].forEach(id => document.getElementById(id).classList.toggle("active", id.includes(a))); }
function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost; bonus[t] += (t==='hp'?cost*50:cost*5); updateUI(); save();
}
function toggleAutoUpgrade() { autoUpgrade = !autoUpgrade; document.getElementById("autoUpBtn").className = autoUpgrade ? "toggleOn" : ""; }
function autoDistribute() { upgrade(['atk','def','hp','exp'][Math.floor(Math.random()*4)]); }
function warpMax() { if(!enemy){ floor = maxReachedFloor; updateUI(); }}
function playCasino() { if(holy<1)return; holy--; if(Math.random()<0.1){ holy+=10; addLog("ğŸ°å¤§å½“ã‚Š!+10Pt");} else if(Math.random()<0.3){ bonus.atk+=5; updateUI(); addLog("ğŸ°æ”»UP");} else addLog("ğŸ°ãƒã‚ºãƒ¬"); save(); }

function save() {
    const data = { floor, maxReachedFloor, loopCount, kills, holy, bonus, petLv, heroUnlocked, party: party.map(c => ({
        name:c.name, job:c.job, icon:c.icon, level:c.level, hp:c.hp, weapon:c.weapon, armor:c.armor
    }))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
}
function load() {
    const saved = localStorage.getItem(SAVE_KEY);
    if(saved) {
        const d = JSON.parse(saved);
        floor=d.floor; maxReachedFloor=d.maxReachedFloor; loopCount=d.loopCount; kills=d.kills; holy=d.holy; bonus=d.bonus; petLv=d.petLv||1; heroUnlocked=d.heroUnlocked;
        party = d.party.map(p => { 
            let c=new Character(p.name, p.job, p.icon); c.level=p.level; c.hp=p.hp; 
            c.weapon=p.weapon; c.armor=p.armor; return c; 
        });
        if(autoUpgrade) document.getElementById("autoUpBtn").className = "toggleOn";
    } else {
        party = [new Character("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Character("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Character("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Character("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
    }
}
load(); updateUI();
</script>
</body>
</html>
