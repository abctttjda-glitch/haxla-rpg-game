<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Slayer's Log v4.0.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #222; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:4px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:2px; cursor:pointer; padding:6px; font-size:11px; }
button:disabled { opacity: 0.1; }

.enemy-box { background:var(--panel); border:1px solid var(--border); padding:4px; height: 42px; display:flex; flex-direction:column; justify-content:center; }
.hp-bar { width: 100%; background:#200; height:6px; margin-top:2px; border:1px solid #400; }
.hp-fill { background:#800; height:100%; width:100%; transition: width 0.1s; }

.log-container { flex: 1; background:#000; border:1px solid var(--border); margin:4px 0; overflow-y:auto; padding:4px; font-size:11px; line-height:1.4; display:flex; flex-direction:column-reverse; }
.log-win { color: #f1c40f; } .log-die { color: #e74c3c; } .log-get { color: #2ecc71; }

.status-bar { background:var(--panel); padding:6px; border:1px solid var(--border); font-size:12px; display:grid; grid-template-columns: 1.2fr 1fr; gap:4px; }
.btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 4px; }

.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:90%; padding:15px; overflow-y:auto; }
.tree-node { border-bottom:1px solid #222; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
.item-card { border:1px solid #333; padding:8px; margin-bottom:8px; background:#0a0a0a; font-size:11px; }
</style>
</head>
<body>

<div class="enemy-box">
    <div style="display:flex; justify-content:space-between; font-size:11px;">
        <span id="eName">WAITING...</span><span id="eHpNum"></span>
    </div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
</div>

<div class="log-container" id="log"></div>

<div class="status-bar">
    <div>
        <b>å‹‡è€… Lv.<span id="hLv">1</span></b> <span id="hHp">0/0</span><br>
        ATK:<span id="hAtk">0</span> DEF:<span id="hDef">0</span>
    </div>
    <div style="text-align:right; font-size:10px;">
        SP:<span id="hSp">0</span> / <span id="dName">---</span><br>
        Progress: <span id="dStep">0</span>/10
    </div>
</div>

<div class="btn-grid">
    <button onclick="openM('questM')">âš”ï¸ ä¾é ¼æ¿</button>
    <button onclick="openM('skillM')">ğŸ“ ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">ğŸ“¦ è£…å‚™å“</button>
</div>

<div id="questM" class="modal"><div class="modal-content"><h3>âš”ï¸ ã‚®ãƒ«ãƒ‰ä¾é ¼</h3><div id="qList"></div><br><button onclick="closeM('questM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>
<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ ã‚¹ã‚­ãƒ«å¼·åŒ– (SP:<span id="mSp">0</span>)</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>
<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3><div id="iList"></div><br><button onclick="closeM('equipM')" style="width:100%">é–‰ã˜ã‚‹</button></div></div>

<script>
const SAVE_KEY = "SlayerLog_v4.0";
let sp=0, step=0, dIdx=0, inBattle=false;
let hero = { lv:1, exp:0, hp:120, maxHp:120, atk:15, def:12, eq:{w:null, a:null, r:null} };
let inventory = [], skills = {}; // skills[id] = level

const DUNGEONS = [
    { n: "é™ã‹ãªåœ°ä¸‹æ°´é“", pow: 0.3, boss: "å·¨å¤§ãƒã‚ºãƒŸ", exp: 25 },
    { n: "äº¡éœŠã®æ£®", pow: 1.5, boss: "å‘ªã‚ã‚ŒãŸãƒˆãƒ¬ãƒ³ãƒˆ", exp: 50 },
    { n: "æº¶å²©æ´çªŸ", pow: 5.0, boss: "ç«ç«œã®é››", exp: 120 }
];

const SKILL_TREE = [
    { id:"s_atk", n:"è…•åŠ›", d:"ATK+5", max:5, eff:{atk:5} },
    { id:"s_def", n:"é ‘å¼·", d:"DEF+5", max:5, eff:{def:5} },
    { id:"s_hp", n:"ç”Ÿå‘½", d:"HP+100", max:5, eff:{hp:100} },
    { id:"s_exp", n:"å­¦ç¿’", d:"EXP+10%", max:3, eff:{exp:0.1} },
    { id:"s_crit", n:"ä¼šå¿ƒ", d:"ä¼šå¿ƒç‡+3%", max:5, eff:{crit:0.03} }
];

function generateEnemyName(isBoss) {
    if(isBoss) return DUNGEONS[dIdx].boss;
    const pre = ["è‡†ç—…ãª", "ã®ã‚ã¾ãª", "è¿·ã„è¾¼ã‚“ã ", "è…¹ãƒšã“ãª", "å°ã•ãª"];
    const mid = ["ã‚¹ãƒ©ã‚¤ãƒ ", "ãƒãƒƒãƒˆ", "ã‚³ãƒœãƒ«ãƒˆ", "å¹¼è™«", "å½±"];
    return pre[Math.floor(Math.random()*pre.length)] + mid[Math.floor(Math.random()*mid.length)];
}

function updateUI() {
    let sA=0, sD=0, sH=0, sCr=0;
    SKILL_TREE.forEach(s => {
        const lv = skills[s.id] || 0;
        if(s.eff.atk) sA += s.eff.atk * lv;
        if(s.eff.def) sD += s.eff.def * lv;
        if(s.eff.hp) sH += s.eff.hp * lv;
        if(s.eff.crit) sCr += s.eff.crit * lv;
    });
    let eA=0, eD=0, eH=0;
    ['w','a','r'].forEach(t => { if(hero.eq[t]) { eA += hero.eq[t].atk; eD += hero.eq[t].def; eH += hero.eq[t].hp; } });

    const g = 1 + (hero.lv - 1) * 0.05;
    hero.maxHp = Math.floor((120 + sH + eH + (hero.lv-1)*20) * g);
    hero.atk = Math.floor((15 + sA + eA + (hero.lv-1)*4) * g);
    hero.def = Math.floor((12 + sD + eD + (hero.lv-1)*3) * g);
    hero.critRate = sCr;

    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hSp").innerText = sp;
    document.getElementById("mSp").innerText = sp;
    document.getElementById("dStep").innerText = step;
}

function addLog(msg, type="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    d.className = type; d.innerText = `> ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 40) l.removeChild(l.lastChild);
}

function startDungeon(idx) {
    dIdx = idx; step = 0; closeM('questM');
    document.getElementById("dName").innerText = DUNGEONS[idx].n;
    addLog(`${DUNGEONS[idx].n} ã¸è¶³ã‚’è¸ã¿å…¥ã‚ŒãŸã€‚`);
    nextBattle();
}

function nextBattle() {
    if(inBattle) return;
    step++;
    if(step > 10) { addLog(`ã‚¨ãƒªã‚¢è¸ç ´ã€‚`, "log-win"); step = 1; save(); }
    const isB = (step === 10);
    const p = DUNGEONS[dIdx].pow * (isB ? 3 : 1);
    const enemy = {
        name: generateEnemyName(isB),
        hp: (50 + hero.lv * 30) * p,
        atk: (5 + hero.lv * 3) * p,
        maxHp: 0
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    runBattle(enemy, isB);
}

function runBattle(e, isB) {
    inBattle = true;
    const it = setInterval(() => {
        let d = Math.max(1, hero.atk - (e.atk*0.05));
        if(Math.random() < hero.critRate) { d *= 2; addLog(`ä¼šå¿ƒã®ä¸€æ’ƒï¼`, "log-win"); }
        e.hp -= d;

        if(e.hp <= 0) {
            clearInterval(it);
            addLog(`${e.name} ã‚’å€’ã—ãŸã€‚`);
            let bonusExp = 1 + (skills['s_exp'] || 0) * 0.1;
            hero.exp += DUNGEONS[dIdx].exp * bonusExp;
            if(hero.exp >= 100) { hero.lv++; hero.exp=0; sp++; addLog(`LvUP! SPã‚’1ç²å¾—ã€‚`, "log-win"); }
            if(isB || Math.random() < 0.15) dropItem(DUNGEONS[dIdx].pow);
            inBattle = false; save(); updateUI();
            setTimeout(nextBattle, 500);
        } else {
            let dmg = Math.max(1, e.atk - hero.def);
            hero.hp -= dmg;
            document.getElementById("eHpFill").style.width = (e.hp/e.maxHp*100) + "%";
            document.getElementById("eHpNum").innerText = Math.floor(e.hp);
            updateUI();
            if(hero.hp <= 0) {
                clearInterval(it);
                addLog(`æ’¤é€€ã‚’ä½™å„€ãªãã•ã‚ŒãŸ...`, "log-die");
                hero.hp = hero.maxHp; inBattle = false;
                setTimeout(nextBattle, 1000);
            }
        }
    }, 150);
}

function dropItem(pow) {
    const types = [{t:'w',n:'å‰£'}, {t:'a',n:'é§'}, {t:'r',n:'æŒ‡è¼ª'}];
    const tt = types[Math.floor(Math.random()*3)];
    const rarity = ["ç²—æœ«ãª", "ä¸¦ã®", "è‰¯è³ªãª", "ååŒ ã®", "ç‹å®¶ã®"][Math.min(4, Math.floor(pow))];
    const item = {
        id: Date.now(), type: tt.t, name: `${rarity}${tt.n}`,
        atk: tt.t === 'w' ? Math.floor(5 + pow*10) : 0,
        def: tt.t === 'a' ? Math.floor(4 + pow*8) : 0,
        hp: tt.t === 'r' ? Math.floor(50 + pow*100) : 0
    };
    inventory.push(item);
    addLog(`ã€Œ${item.name}ã€ã‚’å…¥æ‰‹ï¼`, "log-get");
}

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='questM'?'qList':id==='skillM'?'sList':'iList');
    d.innerHTML = "";
    if(id==='questM') DUNGEONS.forEach((q, i) => {
        d.innerHTML += `<button style="width:100%; margin-bottom:5px;" onclick="startDungeon(${i})">${q.n}</button>`;
    });
    if(id==='skillM') SKILL_TREE.forEach(s => {
        const lv = skills[s.id] || 0;
        d.innerHTML += `<div class="tree-node"><div><b>${s.n} Lv.${lv}/${s.max}</b><br><small>${s.d}</small></div>
            <button onclick="buyS('${s.id}')" ${lv>=s.max||sp<1?'disabled':''}>å¼·åŒ–</button></div>`;
    });
    if(id==='equipM') inventory.forEach(item => {
        const isEq = Object.values(hero.eq).some(e => e && e.id === item.id);
        d.innerHTML += `<div class="item-card"><b>${item.name}</b> ${isEq?'[è£…å‚™ä¸­]':''}<br>
            A:${item.atk} D:${item.def} H:${item.hp}<br>
            <button onclick="equipI(${item.id})" ${isEq?'disabled':''}>è£…å‚™</button>
            <button onclick="sellI(${item.id})">å»ƒæ£„</button></div>`;
    });
}

function buyS(id) { if(sp >= 1) { sp--; skills[id] = (skills[id]||0) + 1; updateUI(); save(); openM('skillM'); } }
function equipI(id) { 
    const item = inventory.find(i => i.id === id);
    hero.eq[item.type] = item; updateUI(); save(); openM('equipM');
}
function sellI(id) {
    inventory = inventory.filter(i => i.id !== id);
    Object.keys(hero.eq).forEach(k => { if(hero.eq[k] && hero.eq[k].id === id) hero.eq[k] = null; });
    updateUI(); save(); openM('equipM');
}
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() {
    const d = { h:hero, s:skills, i:inventory, sp, dIdx };
    localStorage.setItem(SAVE_KEY, JSON.stringify(d));
}
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) {
        const d = JSON.parse(s); hero=d.h; skills=d.s; inventory=d.i; sp=d.sp; dIdx=d.dIdx;
    }
    hero.hp = hero.maxHp;
}
load(); updateUI(); startDungeon(dIdx);
</script>
</body>
</html>
