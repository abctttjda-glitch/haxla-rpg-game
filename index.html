<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Ultimate Job Master v4.5.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:8px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:4px; cursor:pointer; padding:10px; font-size:12px; }
button:active { background: #444; }
button.active-toggle { background: #006400; border-color: #0f0; }

.tower-header { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; border: 1px solid var(--border); padding: 6px; margin-bottom: 4px; }
.enemy-box { text-align: center; padding: 10px; border: 1px solid var(--border); background: #000; margin-bottom: 6px; }
.hp-bar { width: 100%; background:#200; height:12px; border:1px solid #400; margin-top:4px; position:relative; }
.hp-fill { background:linear-gradient(90deg, #900, #f00); height:100%; width:100%; transition: width 0.1s; }

/* Ê∂àÂ§±Âé≥Á¶ÅÔºö„É°„Ç§„É≥„Çπ„ÉÜ„Éº„Çø„ÇπÊ¨Ñ */
.hero-status-panel { background:var(--panel); border:1px solid var(--accent); padding:10px; border-radius:4px; margin-bottom:6px; display:grid; grid-template-columns: 1fr 1.2fr; gap:10px; }
.hero-status-panel b { color: #fff; }
.exp-bar-mini { width: 100%; background: #222; height: 4px; margin-top: 4px; }
.exp-fill-mini { background: #3498db; height: 100%; width: 0%; }

.log-area { flex: 1; background:#000; border:1px solid var(--border); overflow-y:auto; padding:8px; font-size:11px; line-height:1.4; display:flex; flex-direction:column-reverse; margin-bottom:6px; }

.battle-actions { display: flex; gap: 4px; margin-bottom: 8px; }
#btnAttack { flex: 2; height: 50px; background: #400; font-weight: bold; border: 1px solid #822; }
#btnAuto { flex: 1; height: 50px; }

.btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }

.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.98); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:92%; padding:15px; overflow-y:auto; }
.list-row { border-bottom:1px solid #222; padding:12px 0; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>

<div class="tower-header">
    <button onclick="changeFloor(-1)">‚óÄÊàª„Çã</button>
    <b style="color:var(--accent)"><span id="floor">1</span>F</b>
    <button onclick="changeFloor(1)">ÈÄ≤„ÇÄ‚ñ∂</button>
</div>

<div class="hero-status-panel">
    <div>
        <small id="jobLabel" style="color:var(--accent); font-size:10px;">---</small><br>
        <b style="font-size:18px;">Lv.<span id="hLv">1</span></b><br>
        <div style="font-size:10px; margin-top:4px;">
            Next: <span id="nextExp">0</span> EXP
            <div class="exp-bar-mini"><div id="expFill" class="exp-fill-mini"></div></div>
        </div>
    </div>
    <div style="font-size:11px; line-height:1.6;">
        HP : <b id="hHp">0/0</b><br>
        ATK: <b id="hAtk">0</b> / DEF: <b id="hDef">0</b><br>
        PP : <b id="hPp" style="color:#3498db">0</b> / SP : <b id="hSp" style="color:var(--accent)">0</b>
    </div>
</div>

<div class="enemy-box">
    <div id="eName" style="font-weight:bold; font-size:14px;">---</div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
    <div id="eHpNum" style="font-size:10px; margin-top:2px;">0 / 0</div>
</div>

<div class="log-area" id="log"></div>

<div class="battle-actions">
    <button id="btnAttack">Êñ¨ÊíÉ</button>
    <button id="btnAuto" onclick="toggleAuto()">AUTO: OFF</button>
</div>

<div class="btn-grid">
    <button onclick="openM('statM')">„Çπ„ÉÜ„Éº„Çø„Çπ</button>
    <button onclick="openM('jobM')">„Ç∏„Éß„Éñ</button>
    <button onclick="openM('skillM')">„Çπ„Ç≠„É´</button>
    <button onclick="openM('equipM')">„Ç¢„Ç§„ÉÜ„É†</button>
</div>

<div id="statM" class="modal"><div class="modal-content">
    <h3>üìä „Çπ„ÉÜ„Éº„Çø„ÇπÂº∑Âåñ (PP:<span id="mPp">0</span>)</h3>
    <div class="list-row"><span>‰ΩìÂäõ (HP+10)</span><div style="display:flex; align-items:center; gap:10px;"><button onclick="modST('hp',-1)">-</button><b id="stHp">0</b><button onclick="modST('hp',1)">+</button></div></div>
    <div class="list-row"><span>ËÖïÂäõ (ATK+1)</span><div style="display:flex; align-items:center; gap:10px;"><button onclick="modST('atk',-1)">-</button><b id="stAtk">0</b><button onclick="modST('atk',1)">+</button></div></div>
    <div class="list-row"><span>È†ëÂº∑ (DEF+1)</span><div style="display:flex; align-items:center; gap:10px;"><button onclick="modST('def',-1)">-</button><b id="stDef">0</b><button onclick="modST('def',1)">+</button></div></div>
    <br><button onclick="closeM('statM')" style="width:100%">Èñâ„Åò„Çã</button>
</div></div>

<div id="jobM" class="modal"><div class="modal-content"><h3>üõ°Ô∏è „Ç∏„Éß„Éñ„ÉÅ„Çß„É≥„Ç∏ (20Á®Æ)</h3><div id="jobList"></div><br><button onclick="closeM('jobM')" style="width:100%">Êàª„Çã</button></div></div>
<div id="skillM" class="modal"><div class="modal-content"><h3>üéì <span id="curJobTitle"></span> „Çπ„Ç≠„É´</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">Êàª„Çã</button></div></div>
<div id="equipM" class="modal"><div class="modal-content"><h3>üì¶ „Ç¢„Ç§„ÉÜ„É†</h3><div id="iList"></div><br><button onclick="closeM('equipM')" style="width:100%">Êàª„Çã</button></div></div>

<script>
const SAVE_KEY = "Slayer_v4.5.0";
let floor=1, maxFloor=1, sp=0, pp=0, auto=false, inBattle=false;
let st = { hp:20, atk:10, def:10 }; 
let hero = { lv:1, exp:0, job:'warrior', eq:{w:null, a:null} };
let inventory = [], skills = {};

const JOBS = {
    warrior:"Êà¶Â£´", guardian:"Ë°õÂÖµ", rogue:"„Å™„Çâ„ÅöËÄÖ", archer:"Â∞ÑÊâã", 
    mage:"Ë°ìÂ∏´", priest:"ÂÉß‰æ∂", monk:"Êã≥Â£´", samurai:"‰æç", 
    ninja:"Âøç", dragoon:"Á´úÈ®éÂ£´", paladin:"ËÅñÈ®éÂ£´", darknight:"ÊöóÈªíÈ®éÂ£´",
    assassin:"ÊöóÊÆ∫ËÄÖ", bard:"ÂêüÈÅäË©©‰∫∫", alchemist:"Èå¨ÈáëË°ìÂ∏´", necromancer:"Ê≠ªÈúäË°ìÂ∏´",
    berserker:"ÁãÇÊà¶Â£´", sage:"Ë≥¢ËÄÖ", fencer:"Ââ£Â£´", mechanic:"È≠îÂ∞éÂ∑•Â≠¶Â∏´"
};

function updateUI() {
    let sA=0, sD=0, sH=0, sE=0;
    Object.keys(skills).forEach(j => {
        Object.keys(skills[j]).forEach(sid => {
            const lv = skills[j][sid];
            if(sid.includes("_p")) { sA += lv*5; sD += lv*3; sH += lv*50; }
        });
    });
    
    let eA = hero.eq.w ? hero.eq.w.atk : 0;
    let eD = hero.eq.a ? hero.eq.a.def : 0;

    hero.maxHp = st.hp * 10 + sH;
    hero.atk = st.atk + sA + eA;
    hero.def = st.def + sD + eD;
    
    const nextExpVal = hero.lv * 50;
    document.getElementById("hLv").innerText = hero.lv;
    document.getElementById("hHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("hAtk").innerText = hero.atk;
    document.getElementById("hDef").innerText = hero.def;
    document.getElementById("hPp").innerText = pp;
    document.getElementById("hSp").innerText = sp;
    document.getElementById("nextExp").innerText = nextExpVal - hero.exp;
    document.getElementById("expFill").style.width = (hero.exp / nextExpVal * 100) + "%";
    document.getElementById("jobLabel").innerText = JOBS[hero.job];
    document.getElementById("floor").innerText = floor;
    
    document.getElementById("stHp").innerText = st.hp;
    document.getElementById("stAtk").innerText = st.atk;
    document.getElementById("stDef").innerText = st.def;
    document.getElementById("mPp").innerText = pp;
}

function modST(k, v) {
    if(v > 0 && pp > 0) { st[k]++; pp--; }
    else if(v < 0 && st[k] > (k==='hp'?10:5)) { st[k]--; pp++; }
    updateUI(); save();
}

function toggleAuto() {
    auto = !auto;
    const btn = document.getElementById("btnAuto");
    btn.innerText = auto ? "AUTO: ON" : "AUTO: OFF";
    btn.className = auto ? "active-toggle" : "";
}

function addLog(msg, col="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    if(col) d.style.color = col;
    d.innerText = `> ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 25) l.removeChild(l.lastChild);
}

function changeFloor(v) {
    let n = floor + v;
    if(n >= 1 && n <= maxFloor) { floor = n; inBattle = false; nextBattle(); }
}

function generateEName(f) {
    const p = ["È£¢„Åà„Åü", "È™®„ÅÆ", "ÂΩ±„ÅÆ", "Áåõ„Çã", "ÊúΩ„Å°„Åü", "Ê∑±Ê∑µ„ÅÆ"];
    const m = ["„Ç¶„É´„Éï", "„Çπ„Ç±„É´„Éà„É≥", "„Çπ„É©„Ç§„É†", "„Ç¥„Éñ„É™„É≥", "„É™„Ç∂„Éº„Éâ", "„Éá„Éº„É¢„É≥"];
    return p[f % 6] + m[(f*3) % 6] + (f % 50 === 0 ? "„ÉªÁéã" : "");
}

let enemy = null;
function nextBattle() {
    if(inBattle) return;
    const isB = (floor % 50 === 0);
    const m = Math.pow(1.07, floor-1) * (isB ? 5 : 1);
    enemy = {
        name: generateEName(floor),
        hp: Math.floor((80 + floor*20) * m),
        atk: Math.floor((5 + floor*2) * m),
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("eName").innerText = enemy.name;
    document.getElementById("eName").style.color = isB ? "#f22" : "#ccc";
    inBattle = true; updateE();
}

function updateE() {
    if(!enemy) return;
    document.getElementById("eHpFill").style.width = (enemy.hp/enemy.maxHp*100) + "%";
    document.getElementById("eHpNum").innerText = `${Math.floor(enemy.hp)} / ${enemy.maxHp}`;
}

function pAtk() {
    if(!inBattle || !enemy) return;
    enemy.hp -= Math.max(1, hero.atk - enemy.atk*0.05);
    updateE();
    if(enemy.hp <= 0) {
        const getExp = 15 + floor;
        addLog(`${enemy.name}„ÇíÂÄí„Åó„Åü„ÄÇ ${getExp} EXP„ÇíÁç≤ÂæóÔºÅ`, "#2ecc71");
        hero.exp += getExp;
        if(hero.exp >= hero.lv * 50) {
            hero.exp = 0; hero.lv++; pp += 3; sp += 1;
            addLog(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ PP+3 SP+1Áç≤Âæó`, "#3498db");
        }
        if(Math.random() < 0.15 || floor % 50 === 0) drop();
        if(floor === maxFloor) maxFloor++;
        floor++; inBattle = false; save(); updateUI();
        setTimeout(nextBattle, 300);
    }
}

function eTurn() {
    if(!inBattle || !enemy) return;
    hero.hp -= Math.max(1, enemy.atk - hero.def);
    updateUI();
    if(hero.hp <= 0) {
        addLog(`ÊïóÂåó... ${floor}F„ÅßÂÄí„Çå„Åæ„Åó„Åü„ÄÇ`, "#e74c3c");
        hero.hp = hero.maxHp; inBattle = false;
        setTimeout(nextBattle, 1000);
    }
}

function drop() {
    const isW = Math.random() > 0.5;
    const l = Math.floor(floor/10) + 1;
    const i = { id:Date.now(), n:`(Lv.${l}) `+(isW?"Êà¶Êñß":"ÈáçÈéß"), type:isW?'w':'a', atk:isW?l*10:0, def:isW?0:l*8 };
    inventory.push(i);
    addLog(`„Ç¢„Ç§„ÉÜ„É†ÂÖ•ÊâãÔºö${i.n}`, "#d4af37");
}

// Ë∂ÖÈ´òÈÄü„Ç™„Éº„Éà & „Åü„Åü„Åã„ÅÜÈï∑Êäº„Åó
const atkBtn = document.getElementById("btnAttack");
let atkTimer;
const sA = (e) => { e.preventDefault(); pAtk(); atkTimer = setInterval(pAtk, 100); };
const eA = () => clearInterval(atkTimer);
atkBtn.addEventListener("mousedown", sA); atkBtn.addEventListener("mouseup", eA);
atkBtn.addEventListener("touchstart", sA); atkBtn.addEventListener("touchend", eA);

setInterval(() => { if(auto && inBattle) pAtk(); }, 150); // „Ç™„Éº„Éà150ms
setInterval(() => { if(inBattle) eTurn(); }, 1000);

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='jobM'?'jobList':id==='skillM'?'sList':'iList');
    if(!d) return; d.innerHTML = "";
    if(id==='jobM') Object.keys(JOBS).forEach(k => {
        d.innerHTML += `<div class="list-row"><b>${JOBS[k]}</b><button onclick="changeJob('${k}')">„ÉÅ„Çß„É≥„Ç∏</button></div>`;
    });
    if(id==='skillM') {
        const jn = JOBS[hero.job];
        document.getElementById("curJobTitle").innerText = jn;
        for(let i=1; i<=5; i++){
            const pid = hero.job+"_p"+i; const lv = (skills[hero.job]||{})[pid]||0;
            d.innerHTML += `<div class="list-row"><div><b>Á∑¥Ê≠¶ ${i} (Lv.${lv})</b><br><small>Ê∞∏Á∂ö„Çπ„ÉÜ„Éº„Çø„ÇπÂº∑Âåñ</small></div>
                <button onclick="buyS('${pid}')" ${sp<1?'disabled':''}>Âº∑Âåñ</button></div>`;
        }
    }
    if(id==='equipM') inventory.forEach(i => {
        const isEq = hero.eq.w?.id === i.id || hero.eq.a?.id === i.id;
        d.innerHTML += `<div class="list-row"><div><b>${i.n}</b><br><small>A:${i.atk} D:${i.def}</small></div>
            <div><button onclick="eqI(${i.id})" ${isEq?'disabled':''}>Ë£ÖÂÇô</button><button onclick="sellI(${i.id})">ÂªÉÊ£Ñ</button></div></div>`;
    });
}

function changeJob(k) { hero.job = k; updateUI(); save(); openM('jobM'); addLog(`${JOBS[k]}„Å´Ëª¢ËÅ∑„Åó„Åü„ÄÇ`); }
function buyS(id) { if(sp>=1){ sp--; if(!skills[hero.job]) skills[hero.job]={}; skills[hero.job][id] = (skills[hero.job][id]||0)+1; updateUI(); save(); openM('skillM'); } }
function eqI(id) { const i = inventory.find(x=>x.id===id); hero.eq[i.type]=i; updateUI(); save(); openM('equipM'); }
function sellI(id) { inventory = inventory.filter(x=>x.id!==id); if(hero.eq.w?.id===id)hero.eq.w=null; if(hero.eq.a?.id===id)hero.eq.a=null; updateUI(); save(); openM('equipM'); }
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() { localStorage.setItem(SAVE_KEY, JSON.stringify({ hero, st, skills, inventory, floor, maxFloor, sp, pp, auto })); }
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) { const d = JSON.parse(s); hero=d.hero; st=d.st; skills=d.skills; inventory=d.inventory; floor=d.floor; maxFloor=d.maxFloor; sp=d.sp; pp=d.pp; auto=d.auto||false; }
    hero.hp = hero.maxHp; toggleAuto(); toggleAuto(); // Ë°®Á§∫Êõ¥Êñ∞Áî®
}
load(); updateUI(); nextBattle();
</script>
</body>
</html>
