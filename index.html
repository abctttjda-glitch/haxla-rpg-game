<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Monster Slayer: Skill Tree v3.7.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #0d0d0d; --panel: #1a1a1a; --accent: #f1c40f; --text: #eee; --border: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family:sans-serif; height: 100dvh; display:flex; flex-direction:column; padding:8px; overflow:hidden; }
button { background:#333; color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; padding:8px; font-weight:bold; }
button:disabled { opacity: 0.3; cursor: default; }

/* ä¾é ¼çŠ¶æ³ & è–æ¯ */
.top-nav { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
.info-box { background:var(--panel); border:1px solid var(--border); padding:6px; border-radius:6px; font-size:12px; }

/* ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ï¼ˆæ•µã‚¢ã‚¤ã‚³ãƒ³é©æ­£åŒ–ï¼‰ */
.battle-area { flex: 1.2; background:var(--panel); border:1px solid #444; border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; margin-bottom:8px; position:relative; }
.enemy-visual { font-size: 60px; margin: 10px; }
.enemy-name { font-size: 18px; font-weight: bold; color: #e74c3c; }
.hp-bar { width: 80%; background:#222; height:12px; border-radius:6px; overflow:hidden; border:1px solid #555; margin-top:10px; }
.hp-fill { background:#c0392b; height:100%; width:100%; transition: width 0.1s; }

/* å‹‡è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆã‚¿ãƒƒãƒ—ã§è©³ç´°ï¼‰ */
.hero-card { background:#222; border:1px solid var(--accent); border-radius:8px; padding:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.stat-mini { font-size: 13px; line-height: 1.4; }

.footer { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-top: 8px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#222; border-radius:12px; width:95%; max-width:350px; padding:15px; border:1px solid #444; max-height: 90vh; overflow-y: auto; }

/* ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.tree-tab { display: flex; gap: 4px; margin-bottom: 10px; }
.tree-tab button { flex: 1; font-size: 10px; }
.skill-node { background:#111; border:1px solid #555; padding:8px; border-radius:6px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
.skill-info { font-size: 11px; }
.skill-info b { color: var(--accent); }
</style>
</head>
<body>

<div class="top-nav">
    <div class="info-box">ğŸ° ä¾é ¼: <span id="dungeonName">æœªé¸æŠ</span><br>ğŸš© é€²è¡Œ: <span id="step">0/10</span></div>
    <div class="info-box">âœ¨ è–æ¯Pt: <span id="holy">0</span><br>ğŸ“ æœªæ¶ˆè²»SP: <span id="sp">0</span></div>
</div>

<div class="battle-area">
    <div id="enemyName" class="enemy-name">å¾…æ©Ÿä¸­</div>
    <div id="enemyEmoji" class="enemy-visual">ğŸ’¤</div>
    <div class="hp-bar"><div id="enemyHpFill" class="hp-fill"></div></div>
</div>

<div class="hero-card" onclick="openModal('skillModal')">
    <div class="stat-mini">
        <strong>å‹‡è€… Lv.<span id="heroLv">1</span></strong> (è©³ç´°ã‚’è¡¨ç¤º)<br>
        HP: <span id="heroHp">0/0</span> | ATK: <span id="atk">0</span> | DEF: <span id="def">0</span>
    </div>
    <div style="font-size:24px;">ğŸ›¡ï¸</div>
</div>

<div class="footer">
    <button onclick="openModal('questModal')" style="background:#2980b9;">âš”ï¸ ä¾é ¼æ¿</button>
    <button onclick="openModal('holyModal')">âœ¨ è–æ¯å¼·åŒ–</button>
    <button id="autoBtn" onclick="toggleAuto()" style="background:#27ae60;">ã‚ªãƒ¼ãƒˆON</button>
</div>

<div id="questModal" class="modal">
    <div class="modal-content">
        <h3>âš”ï¸ ã‚®ãƒ«ãƒ‰ä¾é ¼æ¿</h3>
        <div style="display:grid; gap:8px;">
            <button onclick="startDungeon(0)">ğŸŸ¢ åˆç´šï¼šã‚¹ãƒ©ã‚¤ãƒ ã®æ£®</button>
            <button onclick="startDungeon(1)">ğŸŸ¡ ä¸­ç´šï¼šãªã‚‰ãšè€…ã®è¡—</button>
            <button onclick="startDungeon(2)">ğŸ”´ è¶…ç´šï¼šé­”ç‹ã®åŸè·¡</button>
        </div>
        <button onclick="closeModal('questModal')" style="width:100%; margin-top:15px; background:#444;">æˆ»ã‚‹</button>
    </div>
</div>

<div id="skillModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0;">ğŸ“ ã‚¹ã‚­ãƒ«ç¿’å¾— (SP: <span id="sp2">0</span>)</h3>
        <div class="tree-tab">
            <button onclick="showTree('warrior')">æˆ¦å£«</button>
            <button onclick="showTree('mage')">é­”å°</button>
            <button onclick="showTree('cleric')">è–è·</button>
        </div>
        <div id="skillList"></div>
        <button onclick="closeModal('skillModal')" style="width:100%; margin-top:10px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="holyModal" class="modal">
    <div class="modal-content">
        <h3>âœ¨ è–æ¯ã®åŠ è­·</h3>
        <p style="font-size:11px;">1Ptã«ã¤ãå¤§å¹…ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒä¸Šæ˜‡ã—ã¾ã™</p>
        <div id="holyRows"></div>
        <button onclick="closeModal('holyModal')" style="width:100%; margin-top:10px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
const SAVE_KEY = "Slayer_SkillTree_v3.7";
let holy=0, sp=0, autoIsOn=true, currentDungeon=null, dIdx=0, step=0, inBattle=false;
let bonus={atk:0, def:0, hp:0}, skills={};
let hero = { lv:1, exp:0, hp:100, maxHp:100, atk:10, def:5 };

const DUNGEONS = [
    { n: "ã‚¹ãƒ©ã‚¤ãƒ ã®æ£®", pow: 1, boss: "ã‚­ãƒ³ã‚°ã‚¹ãƒ©ã‚¤ãƒ ", e: "ğŸ¦" },
    { n: "ãªã‚‰ãšè€…ã®è¡—", pow: 6, boss: "é—‡ã®ã‚®ãƒ«ãƒ‰é•·", e: "ğŸ¥·" },
    { n: "é­”ç‹ã®åŸè·¡", pow: 20, boss: "ç ´å£Šç¥", e: "ğŸ’€" }
];

const SKILL_DATA = {
    warrior: [
        { id:"w1", n:"å‰›åŠ›", d:"ATK+20", effect:{atk:20}, sp:1 },
        { id:"w2", n:"ä¸å±ˆ", d:"DEF+20", effect:{def:20}, sp:1 },
        { id:"w3", n:"å¼·æ’ƒ", d:"15%ã®ç¢ºç‡ã§ãƒ€ãƒ¡ãƒ¼ã‚¸2å€", effect:{crit:0.15}, sp:2 }
    ],
    mage: [
        { id:"m1", n:"é­”åŠ›é›†æŸ", d:"ATK+40", effect:{atk:40}, sp:2 },
        { id:"m2", n:"é­”åŠ›ã®å£", d:"DEF+10, HP+100", effect:{def:10, hp:100}, sp:2 },
        { id:"m3", n:"è© å”±ç ´æ£„", d:"æ”»æ’ƒé€Ÿåº¦ãŒå°‘ã—ä¸Šæ˜‡", effect:{speed:20}, sp:3 }
    ],
    cleric: [
        { id:"c1", n:"ç¥ˆã‚Š", d:"HP+300", effect:{hp:300}, sp:1 },
        { id:"c2", n:"ãƒªã‚¸ã‚§ãƒ", d:"æ¯ã‚¿ãƒ¼ãƒ³HP5å›å¾©", effect:{reg:5}, sp:2 },
        { id:"c3", n:"ç¥ã®ç›¾", d:"DEF+50", effect:{def:50}, sp:3 }
    ]
};

function updateUI() {
    let sAtk=0, sDef=0, sHp=0;
    Object.keys(skills).forEach(id => {
        const data = [...SKILL_DATA.warrior, ...SKILL_DATA.mage, ...SKILL_DATA.cleric].find(x=>x.id===id);
        if(data.effect.atk) sAtk += data.effect.atk;
        if(data.effect.def) sDef += data.effect.def;
        if(data.effect.hp) sHp += data.effect.hp;
    });

    const g = 1 + (hero.lv - 1) * 0.05;
    hero.maxHp = Math.floor((200 + (bonus.hp * 100) + sHp + (hero.lv-1)*30) * g);
    hero.atk = Math.floor((15 + (bonus.atk * 15) + sAtk + (hero.lv-1)*5) * g);
    hero.def = Math.floor((10 + (bonus.def * 10) + sDef + (hero.lv-1)*4) * g);

    document.getElementById("holy").innerText = holy;
    document.getElementById("sp").innerText = sp;
    document.getElementById("sp2").innerText = sp;
    document.getElementById("heroLv").innerText = hero.lv;
    document.getElementById("heroHp").innerText = `${Math.floor(hero.hp)}/${hero.maxHp}`;
    document.getElementById("atk").innerText = hero.atk;
    document.getElementById("def").innerText = hero.def;

    const hr = document.getElementById("holyRows"); hr.innerHTML = "";
    [{k:'atk',n:'æ”»æ’ƒåŠ›(+15)'},{k:'def',n:'é˜²å¾¡åŠ›(+10)'},{k:'hp',n:'ä½“åŠ›(+100)'}].forEach(s => {
        const r = document.createElement("div"); r.style="display:flex; justify-content:space-between; margin-bottom:10px; background:#111; padding:8px; border-radius:6px;";
        r.innerHTML = `<span>${s.n}: ${bonus[s.k]}</span><button onclick="modHoly('${s.k}')">å¼·åŒ–</button>`;
        hr.appendChild(r);
    });
}

function startDungeon(idx) {
    dIdx = idx; currentDungeon = DUNGEONS[idx]; step = 0; inBattle = false;
    document.getElementById("dungeonName").innerText = currentDungeon.n;
    closeModal('questModal');
    nextBattle();
}

function nextBattle() {
    if(!currentDungeon || inBattle) return;
    step++;
    if(step > 10) {
        addLog("ğŸ° ä¾é ¼é”æˆï¼è–æ¯Pt+2");
        holy += 2; step = 0; save(); updateUI();
        if(autoIsOn) setTimeout(() => startDungeon(dIdx), 1000);
        return;
    }
    document.getElementById("step").innerText = `${step}/10`;
    const isBoss = (step === 10);
    const p = currentDungeon.pow * (isBoss ? 3 : 1);
    const enemy = {
        name: isBoss ? `[BOSS] ${currentDungeon.boss}` : "é­”ç‰©",
        hp: (100 + step*50) * p,
        atk: (10 + step*5) * p,
        maxHp: 0
    };
    enemy.maxHp = enemy.hp;
    document.getElementById("enemyName").innerText = enemy.name;
    document.getElementById("enemyEmoji").innerText = currentDungeon.e;
    runFight(enemy);
}

function runFight(e) {
    inBattle = true;
    const it = setInterval(() => {
        // å‹‡è€…ã®æ”»æ’ƒ
        let d = Math.max(1, hero.atk - (e.atk*0.1));
        if(skills.w3 && Math.random()<0.15) d *= 2;
        e.hp -= d;
        if(skills.c2) hero.hp = Math.min(hero.maxHp, hero.hp + 5);

        if(e.hp <= 0) {
            clearInterval(it);
            addLog(`${e.name}ã‚’æ’ƒç ´`);
            hero.exp += 40; if(hero.exp>=100){ hero.lv++; hero.exp=0; sp += 1; addLog("ğŸ†™ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼SPç²å¾—"); }
            inBattle = false; save(); updateUI();
            if(autoIsOn) setTimeout(nextBattle, 100);
        } else {
            hero.hp -= Math.max(1, e.atk - hero.def);
            document.getElementById("enemyHpFill").style.width = (e.hp/e.maxHp*100) + "%";
            updateUI();
            if(hero.hp <= 0) {
                clearInterval(it);
                addLog("ğŸ’€å…¨æ»…... å³åº§ã«å†æˆ¦", "#e74c3c");
                inBattle = false; hero.hp = hero.maxHp;
                setTimeout(nextBattle, 100);
            }
        }
    }, 150);
}

function showTree(type) {
    const list = document.getElementById("skillList"); list.innerHTML = "";
    SKILL_DATA[type].forEach(s => {
        const has = skills[s.id];
        const div = document.createElement("div"); div.className = "skill-node";
        div.innerHTML = `
            <div class="skill-info"><b>${s.n}</b> (SP:${s.sp})<br>${s.d}</div>
            <button onclick="buySkill('${s.id}', ${s.sp})" ${has||sp<s.sp?'disabled':''}>${has?'ç¿’å¾—æ¸ˆ':'ç¿’å¾—'}</button>
        `;
        list.appendChild(div);
    });
}

function buySkill(id, cost) {
    if(sp >= cost) { sp -= cost; skills[id] = true; showTree(id.startsWith('w')?'warrior':id.startsWith('m')?'mage':'cleric'); updateUI(); save(); }
}

function modHoly(k) {
    if(holy >= 1) { holy -= 1; bonus[k] += 1; updateUI(); save(); }
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("autoBtn").innerText = autoIsOn?"ã‚ªãƒ¼ãƒˆON":"ã‚ªãƒ¼ãƒˆOFF"; if(autoIsOn) nextBattle(); }
function openModal(id) { document.getElementById(id).style.display = "flex"; if(id==='skillModal') showTree('warrior'); }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function addLog(m, c="#888") {
    const l = document.getElementById("log"); // ç°¡æ˜“ãƒ­ã‚°
    console.log(m); // ä»Šå›ã¯UIä¸Šã®ãƒ­ã‚°ã‚’æ•´ç†ã—ã¾ã—ãŸ
}

function save() {
    const d = { holy, sp, bonus, skills, hero: {lv:hero.lv}, dIdx, autoIsOn };
    localStorage.setItem(SAVE_KEY, JSON.stringify(d));
}
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) {
        const d = JSON.parse(s); holy=d.holy; sp=d.sp; bonus=d.bonus; skills=d.skills; hero.lv=d.hero.lv; dIdx=d.dIdx;
    }
}
load(); updateUI();
</script>
</body>
</html>
