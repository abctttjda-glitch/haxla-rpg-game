<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯ã‚ªãƒ¼ãƒˆRPG v1.5.0</title>
<style>
body{ margin:0; background:#111; color:#eee; font-family:sans-serif; font-size:15px; padding:6px; overflow-x:hidden; }
.version { position: absolute; top: 5px; right: 10px; font-size: 11px; color: #555; }
h2{margin:4px 0;font-size:20px; color:#f1c40f;}
.panel{ background:#1a1a1a; border:1px solid #444; border-radius:6px; padding:8px; margin-bottom:6px; }
button{ width:100%; background:#333; color:#eee; border:1px solid #555; border-radius:6px; font-size:16px; padding:6px 0; margin-top:3px; cursor: pointer; }
.toggleOn{background:#2ecc71;color:#000;font-weight:bold;}
.dead{opacity:0.4; filter: grayscale(100%);}
.partyRow{ font-size:13px; margin:5px 0; border-bottom: 1px solid #333; }
.barWrap{ background:#333; height:6px; border-radius:3px; overflow:hidden; margin-top:3px; }
.bar{background:#e74c3c; height:100%; transition: width 0.1s;}
.log{ font-size:13px; height:120px; overflow-y:auto; background: #000; padding: 5px; display: flex; flex-direction: column-reverse; }
.skill-text { color: #3498db; font-weight: bold; }
.drop-text { color: #f39c12; }
.danger-text { color: #e74c3c; font-weight: bold; }
.amount-selector { display: flex; gap: 3px; margin-bottom: 5px; }
.amount-btn { font-size: 11px; padding: 3px; background: #222; }
.amount-btn.active { background: #f1c40f; color: #000; }
.warp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; }
</style>
</head>
<body>

<div class="version">v1.5.0 [High-Speed]</div>
<h2>è–æ¯ã‚ªãƒ¼ãƒˆRPG</h2>

<div class="panel">
    <strong>éšå±¤: <span id="floor">1</span> / 1000</strong> (å‘¨å›: <span id="loopCount">0</span>)<br>
    è–æ¯Pt: <span id="holy" style="color:#f1c40f;">0</span>ã€€æ’ƒç ´: <span id="kills">0</span>
    <div class="warp-grid" id="warpContainer"></div>
</div>

<div class="panel">
    <strong>è–æ¯å¼·åŒ–</strong>
    <div class="amount-selector">
        <button class="amount-btn active" onclick="setAmount(1)">x1</button>
        <button class="amount-btn" onclick="setAmount(10)">x10</button>
        <button class="amount-btn" onclick="setAmount(100)">x100</button>
        <button class="amount-btn" onclick="setAmount('MAX')">MAX</button>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:11px;">
        <div>ATK: +<span id="b-atk">0</span> <button onclick="upgrade('atk')">å¼·åŒ–</button></div>
        <div>DEF: +<span id="b-def">0</span> <button onclick="upgrade('def')">å¼·åŒ–</button></div>
        <div>HP: +<span id="b-hp">0</span> <button onclick="upgrade('hp')">å¼·åŒ–</button></div>
        <div>EXP: +<span id="b-exp">0</span>% <button onclick="upgrade('exp')">å¼·åŒ–</button></div>
    </div>
</div>

<div class="panel">
    <strong>æ•µ: <span id="enemyName"></span></strong>
    <div id="enemyText" style="font-size:11px"></div>
    <div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div class="panel">
    <strong>ãƒ‘ãƒ¼ãƒ†ã‚£</strong>
    <div id="party"></div>
</div>

<div class="panel log" id="log"></div>

<div class="panel" style="display:flex; gap:5px;">
    <button onclick="stepDungeon()" style="flex:1">é€²ã‚€</button>
    <button id="mainAutoBtn" onclick="toggleAuto()" style="flex:1">ã‚ªãƒ¼ãƒˆ</button>
</div>

<script>
/* --- è¨­å®š --- */
const BATTLE_SPEED = 20; // æˆ¦é—˜é€Ÿåº¦ï¼ˆæ•°å­—ãŒå¤§ãã„ã»ã©é€Ÿã„ï¼‰
const MAX_FLOOR = 1000;

let floor = 1, maxReachedFloor = 1, loopCount = 0, kills = 0, holy = 0;
let bonus = {atk:0, def:0, hp:0, exp:0};
let buyAmount = 1;
let autoIsOn = false;
let party = [], enemy = null;

const CHAR_DATA = [
    {name:"ãƒ¬ã‚ªãƒ³", job:"ã›ã‚“ã—", icon:"âš”ï¸"},
    {name:"ãƒŸãƒ©", job:"ã¨ã†ãã", icon:"ğŸ—¡ï¸"},
    {name:"ã‚¢ãƒ¼ã‚¯", job:"ã¾ã»ã†ã¤ã‹ã„", icon:"ğŸª„"},
    {name:"ã‚»ãƒ©", job:"ãã†ã‚Šã‚‡", icon:"ğŸ•Šï¸"}
];

const JOBS = {
    "ã›ã‚“ã—": { hp:150, atk:12, def:12, skills: [{name:"å¼·æ’ƒ", rate:0.2, power:2.0}] },
    "ã¨ã†ãã": { hp:100, atk:11, def:6, skills: [{name:"æ€¥æ‰€çªã", rate:0.25, power:2.5}] },
    "ã¾ã»ã†ã¤ã‹ã„": { hp:80, atk:20, def:4, skills: [{name:"çˆ†ç™ºé­”æ³•", rate:0.3, power:3.0}] },
    "ãã†ã‚Šã‚‡": { hp:120, atk:8, def:8, skills: [{name:"ãƒ’ãƒ¼ãƒ«", rate:0.2, power:0}] } 
};

class Character {
    constructor(d) {
        this.name=d.name; this.job=d.job; this.icon=d.icon;
        this.level=1; this.exp=0; this.hp=100; this.maxHp=100;
        this.atk=10; this.def=5; this.eqAtk=0; this.eqDef=0; this.alive=true;
    }
    updateStats() {
        const j = JOBS[this.job];
        this.maxHp = j.hp + (bonus.hp||0) + (this.level-1)*20;
        this.atk = j.atk + (bonus.atk||0) + (this.level-1)*3;
        this.def = j.def + (bonus.def||0) + (this.level-1)*2;
        if(this.hp > this.maxHp) this.hp = this.maxHp;
    }
}

function addLog(t, cls="") {
    const lb = document.getElementById("log");
    const line = document.createElement("div");
    if(cls) line.className = cls;
    line.innerHTML = t;
    lb.appendChild(line);
    if(lb.childNodes.length > 30) lb.removeChild(lb.firstChild);
}

function updateUI() {
    document.getElementById("floor").textContent = floor;
    document.getElementById("loopCount").textContent = loopCount;
    document.getElementById("kills").textContent = kills;
    document.getElementById("holy").textContent = holy;
    document.getElementById("b-atk").textContent = bonus.atk;
    document.getElementById("b-def").textContent = bonus.def;
    document.getElementById("b-hp").textContent = bonus.hp;
    document.getElementById("b-exp").textContent = bonus.exp * 10;

    const pEl = document.getElementById("party");
    pEl.innerHTML = "";
    party.forEach(c => {
        c.updateStats();
        const row = document.createElement("div");
        row.className = "partyRow " + (c.alive ? "" : "dead");
        const hpP = (c.hp / c.maxHp) * 100;
        row.innerHTML = `<div>${c.icon}${c.name} Lv${c.level} <span style="font-size:10px; color:#777;">(âš”ï¸${c.eqAtk} ğŸ›¡ï¸${c.eqDef})</span></div>
                         <div class="barWrap"><div class="bar" style="width:${hpP}%"></div></div>`;
        pEl.appendChild(row);
    });
    updateWarpButtons();
}

function updateWarpButtons() {
    const container = document.getElementById("warpContainer");
    container.innerHTML = "";
    for(let i=1; i<=maxReachedFloor; i+=100) {
        const b = document.createElement("button");
        b.className = "warp-btn"; b.textContent = i + "F";
        b.onclick = () => { if(!enemy){ floor = i; addLog(i + "Fã¸ãƒ¯ãƒ¼ãƒ—"); updateUI(); save(); }};
        container.appendChild(b);
    }
}

function battleLoop() {
    const it = setInterval(() => {
        if(!enemy) { clearInterval(it); return; }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³
        party.forEach(c => {
            if(!c.alive || !enemy || enemy.hp <= 0) return;
            
            let skillTriggered = false;
            const j = JOBS[c.job];
            
            // ã‚¹ã‚­ãƒ«åˆ¤å®š
            if(Math.random() < j.skills[0].rate) {
                if(c.job === "ãã†ã‚Šã‚‡") {
                    party.forEach(m => { if(m.alive) m.hp = Math.min(m.maxHp, m.hp + 50); });
                    addLog(`${c.icon} å…¨å“¡å›å¾©!`, "skill-text");
                } else {
                    let sdmg = Math.max(1, (c.atk + c.eqAtk) * j.skills[0].power - enemy.def);
                    enemy.hp -= sdmg;
                    addLog(`${c.icon}${j.skills[0].name}! ${Math.floor(sdmg)}ãƒ€ãƒ¡`, "skill-text");
                }
                skillTriggered = true;
            }

            if(!skillTriggered) {
                let dmg = Math.max(1, (c.atk + c.eqAtk) - enemy.def);
                enemy.hp -= dmg;
            }

            if(enemy.hp <= 0) {
                enemy.hp = 0; addLog(`${enemy.name}æ’ƒç ´`);
                kills++;
                // ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®š
                if(Math.random() < 0.2) {
                    const t = party[Math.floor(Math.random()*4)];
                    const val = Math.floor(Math.random()*(floor/5 + loopCount*20))+1;
                    if(Math.random()>0.5) { if(val > t.eqAtk){t.eqAtk=val; addLog(`æ­¦å™¨UP+${val}`,"drop-text");}}
                    else { if(val > t.eqDef){t.eqDef=val; addLog(`é˜²å…·UP+${val}`,"drop-text");}}
                }
                // éšå±¤æ›´æ–°
                if(floor >= MAX_FLOOR) { floor = 1; loopCount++; addLog("â˜…1000å±¤çªç ´! å‘¨å›æ•°UP", "drop-text"); }
                else { floor++; }
                if(floor > maxReachedFloor) maxReachedFloor = floor;
                
                clearInterval(it); enemy = null; save();
                if(autoIsOn) setTimeout(stepDungeon, 100);
                updateUI();
            }
        });

        // æ•µã®æ”»æ’ƒã‚¿ãƒ¼ãƒ³
        if(enemy) {
            const target = party.find(c => c.alive);
            if(!target) {
                clearInterval(it); 
                addLog(`æ•—åŒ—... 10éšå±¤ãƒ€ã‚¦ãƒ³`, "danger-text");
                floor = Math.max(1, floor - 10);
                party.forEach(c => { c.hp = c.maxHp; c.alive = true; });
                enemy = null; save();
                if(autoIsOn) setTimeout(stepDungeon, 500);
                updateUI(); return;
            }
            let eDmg = Math.max(1, enemy.atk - (target.def + target.eqDef));
            target.hp -= eDmg; if(target.hp <= 0) { target.hp = 0; target.alive = false; }
        }
        
        updateUI();
        if(enemy) {
            document.getElementById("enemyName").textContent = enemy.name;
            document.getElementById("enemyText").textContent = `HP: ${Math.floor(enemy.hp)}`;
            document.getElementById("enemyHpBar").style.width = (enemy.hp/enemy.maxHp*100) + "%";
        }
    }, 1000 / BATTLE_SPEED);
}

function stepDungeon() {
    if(enemy) return;
    const p = (1 + loopCount + floor/100);
    enemy = { 
        name: (floor%10===0?"ğŸ‘¹BOSS":"ğŸ‘¾MON"), 
        maxHp: (60 + floor*25) * p, 
        hp: (60 + floor*25) * p, 
        atk: (6 + floor*2.5) * p, 
        def: (3 + floor) * p 
    };
    if(floor%10===0) holy += (1 + loopCount); 
    battleLoop();
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("mainAutoBtn").className = autoIsOn ? "toggleOn" : ""; if(autoIsOn) stepDungeon(); }

function setAmount(a) { buyAmount = a; document.querySelectorAll('.amount-btn').forEach(b => b.classList.toggle('active', b.textContent.includes(a))); }

function upgrade(t) {
    let cost = (buyAmount === 'MAX') ? holy : buyAmount;
    if(holy < cost || cost <= 0) return;
    holy -= cost;
    bonus[t] += (t === "hp" ? cost * 20 : cost * 3);
    updateUI(); save();
}

function save() {
    const data = { floor, maxReachedFloor, loopCount, kills, holy, bonus, party: party.map(c => ({
        level: c.level, exp: c.exp, hp: c.hp, eqAtk: c.eqAtk, eqDef: c.eqDef
    }))};
    localStorage.setItem("holyRPG_v150", JSON.stringify(data));
}

function load() {
    party = CHAR_DATA.map(d => new Character(d));
    const saved = localStorage.getItem("holyRPG_v150");
    if(saved) {
        const d = JSON.parse(saved);
        floor = d.floor || 1; maxReachedFloor = d.maxReachedFloor || 1;
        loopCount = d.loopCount || 0; kills = d.kills || 0;
        holy = d.holy || 0; bonus = d.bonus || bonus;
        d.party.forEach((p, i) => {
            if(party[i]){
                party[i].level = p.level; party[i].exp = p.exp; party[i].hp = p.hp;
                party[i].eqAtk = p.eqAtk; party[i].eqDef = p.eqDef;
            }
        });
    }
}

load();
updateUI();
</script>
</body>
</html>
