<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>聖杯オートRPG</title>
<style>
body{
  margin:0;
  background:#111;
  color:#eee;
  font-family:sans-serif;
  font-size:17px;
  padding:6px;
}
h2{margin:4px 0;font-size:22px}
.panel{
  background:#1a1a1a;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
  margin-bottom:6px;
}
button{
  width:100%;
  background:#333;
  color:#eee;
  border:1px solid #555;
  border-radius:6px;
  font-size:20px;
  padding:10px 0;
  margin-top:4px;
}
button:active{background:#666;}
.toggleOn{background:#2ecc71;color:#000}
.dead{opacity:0.4}

.partyRow{
  font-size:18px;
  margin:2px 0;
}
.barWrap{
  background:#333;
  height:10px;
  border-radius:5px;
  overflow:hidden;
}
.bar{background:#e74c3c;height:100%;}

.log{
  font-size:20px;
  max-height:150px;
  overflow-y:auto;
  line-height:1.3;
}
</style>
</head>
<body>

<h2>聖杯オートRPG</h2>

<div class="panel">
階層 <span id="floor">1</span>　
撃破 <span id="kills">0</span>　
聖杯Pt <span id="holy">0</span>
</div>

<div class="panel">
<strong>敵</strong>
<div id="enemyName"></div>
<div id="enemyText"></div>
<div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div class="panel">
<strong>パーティ</strong>
<div id="party"></div>
</div>

<div class="panel">
<strong>聖杯強化</strong>
<button onclick="upgrade('atk')">ATK +</button>
<button onclick="upgrade('def')">DEF +</button>
<button onclick="upgrade('hp')">HP +</button>
<button onclick="upgrade('exp')">EXP +</button>
<button id="autoBtn" onclick="toggleAutoUpgrade()">自動振り OFF</button>
</div>

<div class="panel log" id="log"></div>

<div class="panel">
<button onclick="stepDungeon()">進む</button>
<button onclick="toggleAuto()">オート</button>
</div>

<script>
/* ===== 定数 ===== */
const SPEED = 8;
const ENEMY_NAMES=["スライム","ゴブリン","オーク","スケルトン"];
const CHAR_DATA=[
 {name:"レオン",job:"せんし"},
 {name:"ミラ",job:"とうぞく"},
 {name:"アーク",job:"まほうつかい"},
 {name:"セラ",job:"そうりょ"}
];
const JOBS={
 せんし:{hp:140,atk:10,def:8},
 とうぞく:{hp:110,atk:9,def:5},
 まほうつかい:{hp:90,atk:14,def:3},
 そうりょ:{hp:100,atk:6,def:4}
};

/* ===== クラス ===== */
class Character{
 constructor(d,bonus){
  const j=JOBS[d.job];
  this.name=d.name;
  this.job=d.job;
  this.level=1;
  this.exp=0;
  this.maxHp=j.hp+bonus.hp;
  this.atk=j.atk+bonus.atk;
  this.def=j.def+bonus.def;
  this.hp=this.maxHp;
  this.alive=true;
 }
}
class Enemy{
 constructor(floor){
  this.name=ENEMY_NAMES[Math.floor(Math.random()*ENEMY_NAMES.length)];
  this.maxHp=50+floor*10;
  this.hp=this.maxHp;
  this.atk=6+floor*2;
  this.def=2+floor;
 }
}

/* ===== 状態 ===== */
let floor=1;
let kills=0;
let holy=0;
let bonus={atk:0,def:0,hp:0,exp:0};
let autoUpgrade=false;
let party=[];
let enemy=null;
let autoTimer=null;
let logQueue=[];
let logTimer=null;

/* ===== DOM ===== */
const partyEl=document.getElementById("party");
const enemyName=document.getElementById("enemyName");
const enemyText=document.getElementById("enemyText");
const enemyHpBar=document.getElementById("enemyHpBar");
const floorEl=document.getElementById("floor");
const killsEl=document.getElementById("kills");
const holyEl=document.getElementById("holy");
const log=document.getElementById("log");
const autoBtn=document.getElementById("autoBtn");

/* ===== ログ ===== */
function addLog(t){
 logQueue.push(t);
 if(!logTimer) runLogQueue();
}
function runLogQueue(){
 if(logQueue.length===0){ logTimer=null; return; }
 const line = logQueue.shift();
 log.innerHTML = line + "<br>" + log.innerHTML;
 log.scrollTop = 0;
 logTimer = setTimeout(runLogQueue, 400);
}

/* ===== 成長 ===== */
function expNeed(lv){return 20+lv*10}
function gainExp(c,val){
 c.exp+=val*(1+bonus.exp*0.1);
 while(c.exp>=expNeed(c.level)){
  c.exp-=expNeed(c.level);
  c.level++;
  c.maxHp+=10;
  c.atk+=2;
  c.def+=1;
  addLog(c.name+" LvUP!");
 }
}

/* ===== 初期化 ===== */
function initParty(){
  if(party.length===0){
    party = CHAR_DATA.map(d=>new Character(d, bonus));
  } else {
    party.forEach(c=>{
      const j=JOBS[c.job];
      c.maxHp = j.hp + bonus.hp + (c.level-1)*10;
      c.atk = j.atk + bonus.atk + (c.level-1)*2;
      c.def = j.def + bonus.def + (c.level-1);
      if(c.hp>c.maxHp)c.hp=c.maxHp;
      c.alive = c.hp>0;
    });
  }
}

/* ===== バトル ===== */
function battle(end){
  enemy.hp = enemy.hp>0?enemy.hp:enemy.maxHp;
  const it = setInterval(()=>{
    // パーティ攻撃
    party.forEach(c=>{
      if(!c.alive) return;
      const dmg=Math.max(1,c.atk-enemy.def);
      enemy.hp-=dmg;
      if(enemy.hp<0) enemy.hp=0;
      addLog(`${c.name} は ${enemy.name} に ${dmg} のダメージ！`);
    });
    updateEnemyUI();

    if(enemy.hp<=0){
      clearInterval(it);
      kills++;
      party.forEach(c=>gainExp(c,5));
      addLog(`${enemy.name} を倒した！`);
      if(kills%10===0){holy++; addLog("聖杯Pt +1"); if(autoUpgrade) autoSpend();}
      floor++;
      updateUI();
      end();
      return;
    }

    // 敵攻撃
    const t = party.find(c=>c.alive);
    if(!t){
      party.forEach(c=>{c.hp=c.maxHp;c.alive=true;});
      addLog("全滅→復活");
      updateUI();
      return;
    }
    const dmg=Math.max(1,enemy.atk-t.def);
    t.hp-=dmg;
    if(t.hp<0)t.hp=0;
    addLog(`${enemy.name} は ${t.name} に ${dmg} のダメージ！`);
    if(t.hp<=0){t.alive=false; addLog(`${t.name} は倒れた！`);}
    updateUI();
  },800/SPEED);
}

/* ===== 操作 ===== */
function stepDungeon(){enemy=new Enemy(floor);updateEnemyUI();battle(()=>{save();});}
function toggleAuto(){autoTimer?(clearInterval(autoTimer),autoTimer=null):(autoTimer=setInterval(stepDungeon,2000/SPEED));}
function upgrade(t){if(holy<=0)return;holy--;bonus[t]+=t==="hp"?10:1;initParty();addLog("聖杯強化："+t);save();updateUI();}
function autoSpend(){const k=["atk","def","hp","exp"];upgrade(k[Math.floor(Math.random()*4)]);}
function toggleAutoUpgrade(){autoUpgrade=!autoUpgrade;autoBtn.textContent=autoUpgrade?"自動振り ON":"自動振り OFF";autoBtn.className=autoUpgrade?"toggleOn":"";save();}

/* ===== UI ===== */
function updateUI(){
 floorEl.textContent=floor;
 killsEl.textContent=kills;
 holyEl.textContent=holy;
 partyEl.innerHTML="";
 party.forEach(c=>{
  const d=document.createElement("div");
  d.className="partyRow "+(c.alive?"":"dead");
  d.textContent=`${c.name} Lv${c.level} HP${c.hp}/${c.maxHp} ATK${c.atk} DEF${c.def}`;
  partyEl.appendChild(d);
 });
}
function updateEnemyUI(){
 enemyName.textContent=enemy.name;
 enemyText.textContent=`HP ${enemy.hp}/${enemy.maxHp}`;
 enemyHpBar.style.width=(enemy.hp/enemy.maxHp*100)+"%";
}

/* ===== セーブ/ロード ===== */
function save(){
 const data = {
  floor,kills,holy,bonus,autoUpgrade,
  party:party.map(c=>({name:c.name,job:c.job,level:c.level,exp:c.exp,hp:c.hp,maxHp:c.maxHp,atk:c.atk,def:c.def,alive:c.alive}))
 };
 localStorage.setItem("holyRPG",JSON.stringify(data));
}
function load(){
 const r=localStorage.getItem("holyRPG");
 if(!r) return;
 const d=JSON.parse(r);
 floor=d.floor;kills=d.kills;holy=d.holy;
 bonus=d.bonus;autoUpgrade=d.autoUpgrade;
 if(d.party){
   party=d.party.map(p=>{
     const c=new Character({name:p.name,job:p.job},bonus);
     c.level=p.level;c.exp=p.exp;c.hp=p.hp;c.maxHp=p.maxHp;c.atk=p.atk;c.def=p.def;c.alive=p.alive;
     return c;
   });
 }
}

/* ===== 起動 ===== */
load();
initParty();
updateUI();
</script>
</body>
</html>