<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Job Master Tower v4.4.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --bg: #050505; --panel: #111; --accent: #d4af37; --text: #ccc; --border: #222; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--bg); color:var(--text); font-family: 'Consolas', monospace; height: 100dvh; display:flex; flex-direction:column; padding:8px; overflow:hidden; }
button { background:#222; color:#eee; border:1px solid #444; border-radius:4px; cursor:pointer; padding:10px; font-size:12px; }
button:active { background: #444; }
button:disabled { opacity: 0.1; }

.tower-header { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; border: 1px solid #333; padding: 6px; margin-bottom: 4px; }
.enemy-box { text-align: center; padding: 10px; border: 1px solid var(--border); background: #000; margin-bottom: 6px; }
.hp-bar { width: 100%; background:#200; height:10px; border:1px solid #400; margin-top:4px; }
.hp-fill { background:#a00; height:100%; width:100%; transition: width 0.2s; }

.log-area { flex: 1; background:#000; border:1px solid var(--border); overflow-y:auto; padding:8px; font-size:11px; line-height:1.5; display:flex; flex-direction:column-reverse; margin-bottom:6px; }

.battle-actions { display: flex; gap: 8px; margin-bottom: 8px; }
#btnAttack { flex: 1; height: 50px; background: #300; border: 1px solid #622; font-weight: bold; }

.btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }

.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.98); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#111; border:1px solid #333; width:95%; height:92%; padding:15px; overflow-y:auto; }
.list-row { border-bottom:1px solid #222; padding:10px 0; display:flex; justify-content:space-between; align-items:center; }
</style>
</head>
<body>

<div class="tower-header">
    <button onclick="changeFloor(-1)">â—€</button>
    <b style="color:var(--accent)">Tower: <span id="floor">1</span>F</b>
    <button onclick="changeFloor(1)">â–¶</button>
</div>

<div class="enemy-box">
    <div id="eName" style="font-weight:bold;">---</div>
    <div class="hp-bar"><div id="eHpFill" class="hp-fill"></div></div>
    <div id="eHpNum" style="font-size:10px;">0 / 0</div>
</div>

<div class="log-area" id="log"></div>

<div class="battle-actions">
    <button id="btnAttack">ãŸãŸã‹ã† (é•·æŠ¼ã—é€£æ‰“)</button>
</div>

<div class="btn-grid">
    <button onclick="openM('statM')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
    <button onclick="openM('jobM')">ã‚¸ãƒ§ãƒ–</button>
    <button onclick="openM('skillM')">ã‚¹ã‚­ãƒ«</button>
    <button onclick="openM('equipM')">ã‚¢ã‚¤ãƒ†ãƒ </button>
</div>

<div id="statM" class="modal"><div class="modal-content">
    <h3>ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (PP:<span id="mPp">0</span>)</h3>
    <div class="list-row"><span>Lv / HP</span> <span><b id="stLv">1</b> / <b id="stHp">100</b></span></div>
    <div class="list-row"><span>åŠ› (ATK)</span><div style="display:flex; align-items:center; gap:10px;"><button onclick="modST('atk',-1)">-</button><b id="stAtk">0</b><button onclick="modST('atk',1)">+</button></div></div>
    <div class="list-row"><span>å®ˆ (DEF)</span><div style="display:flex; align-items:center; gap:10px;"><button onclick="modST('def',-1)">-</button><b id="stDef">0</b><button onclick="modST('def',1)">+</button></div></div>
    <button onclick="closeM('statM')" style="width:100%; margin-top:20px;">é–‰ã˜ã‚‹</button>
</div></div>

<div id="jobM" class="modal"><div class="modal-content"><h3>ğŸ›¡ï¸ ã‚¸ãƒ§ãƒ–é¸æŠ</h3><div id="jobList"></div><br><button onclick="closeM('jobM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<div id="skillM" class="modal"><div class="modal-content"><h3>ğŸ“ <span id="curJobTitle"></span> ã‚¹ã‚­ãƒ« (SP:<span id="mSp">0</span>)</h3><div id="sList"></div><br><button onclick="closeM('skillM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<div id="equipM" class="modal"><div class="modal-content"><h3>ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ </h3><div id="iList"></div><br><button onclick="closeM('equipM')" style="width:100%">æˆ»ã‚‹</button></div></div>

<script>
const SAVE_KEY = "Slayer_v4.4.0";
let floor=1, maxFloor=1, sp=0, pp=0, inBattle=false;
let st = { atk:10, def:10, hp:200 }; 
let hero = { lv:1, exp:0, job:'warrior', eq:{w:null, a:null} };
let inventory = [], skills = {};

const JOBS = {
    warrior: { n: "æˆ¦å£«", s: [
        {id:"w1", n:"å¼·æ’ƒ", type:"A", d:"15%ã§ãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€", max:10},
        {id:"w2", n:"é‡è£…æ­©å…µ", type:"P", d:"DEF +5", max:10, eff:{def:5}},
        {id:"w3", n:"ä¸€é–ƒ", type:"A", d:"10%ã§ãƒ€ãƒ¡ãƒ¼ã‚¸2.0å€", max:10},
        {id:"w4", n:"é€†é±—", type:"P", d:"ATK +5", max:10, eff:{atk:5}},
        {id:"w5", n:"ä¸æ’“ä¸å±ˆ", type:"P", d:"æœ€å¤§HP +50", max:10, eff:{hp:50}}
    ]},
    thief: { n: "ç›—è³Š", s: [
        {id:"t1", n:"æ€¥æ‰€ç‹™ã„", type:"A", d:"10%ã§ä¼šå¿ƒæ’ƒ", max:10},
        {id:"t2", n:"è»½æ¥­", type:"P", d:"å›é¿ç‡ã‚¢ãƒƒãƒ—", max:10},
        {id:"t3", n:"ç›®åˆ©ã", type:"P", d:"EXP +10%", max:10, eff:{exp:0.1}},
        {id:"t4", n:"å¥‡è¥²", type:"A", d:"æˆ¦é—˜é–‹å§‹æ™‚ãƒ€ãƒ¡ãƒ¼ã‚¸", max:10},
        {id:"t5", n:"ä¿Šæ•", type:"P", d:"ATK +3", max:10, eff:{atk:3}}
    ]}
};

function updateUI() {
    let sA=0, sD=0, sH=0, sE=0;
    Object.keys(skills).forEach(j => {
        JOBS[j].s.forEach(s => {
            const lv = skills[j][s.id] || 0;
            if(s.type === "P" && lv > 0) {
                if(s.eff.atk) sA += s.eff.atk * lv;
                if(s.eff.def) sD += s.eff.def * lv;
                if(s.eff.hp) sH += s.eff.hp * lv;
                if(s.eff.exp) sE += s.eff.exp * lv;
            }
        });
    });
    
    let eA = hero.eq.w ? hero.eq.w.atk : 0;
    let eD = hero.eq.a ? hero.eq.a.def : 0;

    hero.maxHp = st.hp + sH;
    hero.atk = st.atk + sA + eA;
    hero.def = st.def + sD + eD;
    hero.expBonus = sE;

    document.getElementById("floor").innerText = floor;
    document.getElementById("stLv").innerText = hero.lv;
    document.getElementById("stHp").innerText = hero.maxHp;
    document.getElementById("stAtk").innerText = st.atk;
    document.getElementById("stDef").innerText = st.def;
    document.getElementById("mPp").innerText = pp;
    document.getElementById("mSp").innerText = sp;
}

function modST(k, v) {
    if(v > 0 && pp > 0) { st[k]++; pp--; }
    else if(v < 0 && st[k] > 1) { st[k]--; pp++; }
    updateUI(); save();
}

function changeFloor(v) {
    let next = floor + v;
    if(next < 1) next = 1;
    if(next > maxFloor) next = maxFloor;
    if(next !== floor) {
        floor = next;
        addLog(`${floor}Fã¸ç§»å‹•ã—ã¾ã—ãŸã€‚`);
        inBattle = false;
        nextBattle();
    }
}

function generateEName(f) {
    const pre = ["è¡€ã«é£¢ãˆãŸ", "å½·å¾¨ãˆã‚‹", "é‚ªæ‚ªãª", "æ·±æ·µã®", "å‘ªã‚ã‚ŒãŸ", "ç‹‚æš´ãª"];
    const mid = ["ã‚´ãƒ–ãƒªãƒ³", "ã‚ªãƒ¼ã‚¯", "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", "ã‚¦ãƒ«ãƒ•", "ãƒªã‚¶ãƒ¼ãƒ‰", "ãƒ¬ã‚¤ã‚¹"];
    const seed = f % 6;
    const seed2 = (f * 3) % 6;
    return pre[seed] + mid[seed2] + (f % 50 === 0 ? "ãƒ»ãƒ­ãƒ¼ãƒ‰" : "");
}

let currentEnemy = null;
function nextBattle() {
    if(inBattle) return;
    const isB = (floor % 50 === 0);
    const p = Math.pow(1.06, floor-1) * (isB ? 5 : 1);
    currentEnemy = {
        name: generateEName(floor),
        hp: Math.floor((100 + floor*20) * p),
        atk: Math.floor((8 + floor*2) * p),
    };
    currentEnemy.maxHp = currentEnemy.hp;
    document.getElementById("eName").innerText = currentEnemy.name;
    document.getElementById("eName").style.color = isB ? "#f22" : "#ccc";
    inBattle = true; updateEnemyUI();
}

function updateEnemyUI() {
    if(!currentEnemy) return;
    document.getElementById("eHpFill").style.width = (currentEnemy.hp/currentEnemy.maxHp*100) + "%";
    document.getElementById("eHpNum").innerText = `${Math.floor(currentEnemy.hp)} / ${currentEnemy.maxHp}`;
}

function playerAttack() {
    if(!inBattle || !currentEnemy) return;
    let d = Math.max(1, hero.atk - currentEnemy.atk*0.05);
    currentEnemy.hp -= d;
    updateEnemyUI();
    if(currentEnemy.hp <= 0) {
        addLog(`${currentEnemy.name}ã‚’å€’ã—ãŸã€‚`);
        hero.exp += (20 + floor) * (1 + hero.expBonus);
        if(hero.exp >= 100) {
            hero.lv++; hero.exp=0; sp++; pp++; st.hp += 10;
            addLog(`LvUP! HP+10 PP+1 SP+1`, "#3498db");
        }
        if(Math.random() < 0.2 || floor % 50 === 0) dropItem();
        if(floor === maxFloor) maxFloor++;
        floor++; inBattle = false; save(); updateUI();
        setTimeout(nextBattle, 500);
    }
}

function enemyTurn() {
    if(!inBattle || !currentEnemy) return;
    hero.hp -= Math.max(1, currentEnemy.atk - hero.def);
    updateUI();
    if(hero.hp <= 0) {
        addLog(`${floor}Fã§åŠ›å°½ããŸ...`, "#e74c3c");
        hero.hp = hero.maxHp; inBattle = false;
        setTimeout(nextBattle, 1500);
    }
}

function dropItem() {
    const isW = Math.random() > 0.5;
    const lv = Math.floor(floor/5) + 1;
    const item = isW ? 
        {id:Date.now(), n:`é‹¼ã®å‰£+${lv}`, type:'w', atk:lv*5, def:0} :
        {id:Date.now(), n:`é‹¼ã®é§+${lv}`, type:'a', atk:0, def:lv*4};
    inventory.push(item);
    addLog(`å…¥æ‰‹ï¼š${item.n}`, "#2ecc71");
}

function addLog(msg, col="") {
    const l = document.getElementById("log");
    const d = document.createElement("div");
    if(col) d.style.color = col;
    d.innerText = `> ${msg}`;
    l.prepend(d);
    if(l.childNodes.length > 20) l.removeChild(l.lastChild);
}

// ãŸãŸã‹ã†ãƒœã‚¿ãƒ³
const atkBtn = document.getElementById("btnAttack");
let atkTimer;
const startAtk = (e) => { e.preventDefault(); playerAttack(); atkTimer = setInterval(playerAttack, 120); };
const endAtk = () => clearInterval(atkTimer);
atkBtn.addEventListener("mousedown", startAtk); atkBtn.addEventListener("mouseup", endAtk);
atkBtn.addEventListener("touchstart", startAtk); atkBtn.addEventListener("touchend", endAtk);

// ã‚ªãƒ¼ãƒˆé€²è¡Œ
setInterval(() => { if(inBattle) playerAttack(); }, 600);
setInterval(() => { if(inBattle) enemyTurn(); }, 1200);

function openM(id) {
    document.getElementById(id).style.display = "flex";
    const d = document.getElementById(id==='jobM'?'jobList':id==='skillM'?'sList':'iList');
    if(!d) return;
    d.innerHTML = "";
    if(id==='jobM') Object.keys(JOBS).forEach(k => {
        d.innerHTML += `<div class="list-row"><b>${JOBS[k].n}</b><button onclick="changeJob('${k}')">ãƒã‚§ãƒ³ã‚¸</button></div>`;
    });
    if(id==='skillM') {
        document.getElementById("curJobTitle").innerText = JOBS[hero.job].n;
        JOBS[hero.job].s.forEach(s => {
            if(!skills[hero.job]) skills[hero.job] = {};
            const lv = skills[hero.job][s.id] || 0;
            d.innerHTML += `<div class="list-row"><div><b>${s.n} Lv.${lv}</b><br><small>${s.d}</small></div>
                <button onclick="buyS('${s.id}')" ${lv>=s.max||sp<1?'disabled':''}>å¼·åŒ–</button></div>`;
        });
    }
    if(id==='equipM') {
        inventory.forEach(i => {
            const isEq = hero.eq.w?.id === i.id || hero.eq.a?.id === i.id;
            d.innerHTML += `<div class="list-row"><div><b>${i.n}</b><br><small>${i.atk?`ATK+${i.atk}`:`DEF+${i.def}`}</small></div>
                <div><button onclick="eqI(${i.id})" ${isEq?'disabled':''}>è£…å‚™</button><button onclick="sellI(${i.id})">å»ƒæ£„</button></div></div>`;
        });
    }
}

function changeJob(k) { hero.job = k; updateUI(); save(); openM('jobM'); addLog(`${JOBS[k].n}ã«ã‚¸ãƒ§ãƒ–ãƒã‚§ãƒ³ã‚¸ã—ãŸã€‚`); }
function buyS(id) { if(sp>=1){ sp--; skills[hero.job][id] = (skills[hero.job][id]||0)+1; updateUI(); save(); openM('skillM'); } }
function eqI(id) { const i = inventory.find(x=>x.id===id); hero.eq[i.type]=i; updateUI(); save(); openM('equipM'); }
function sellI(id) { inventory = inventory.filter(x=>x.id!==id); if(hero.eq.w?.id===id)hero.eq.w=null; if(hero.eq.a?.id===id)hero.eq.a=null; updateUI(); save(); openM('equipM'); }
function closeM(id) { document.getElementById(id).style.display = "none"; }

function save() { localStorage.setItem(SAVE_KEY, JSON.stringify({ hero, st, skills, inventory, floor, maxFloor, sp, pp })); }
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) { const d = JSON.parse(s); hero=d.hero; st=d.st; skills=d.skills; inventory=d.inventory; floor=d.floor; maxFloor=d.maxFloor; sp=d.sp; pp=d.pp; }
    hero.hp = hero.maxHp;
}
load(); updateUI(); nextBattle();
</script>
</body>
</html>
