<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è–æ¯RPGï¼šãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ»ãƒãƒ³ã‚¿ãƒ¼ v3.4.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<style>
:root { --main-bg: #0d0d0d; --panel-bg: #1a1a1a; --accent: #f1c40f; --text: #eee; --border: #333; }
* { touch-action: manipulation; box-sizing: border-box; -webkit-user-select: none; }
body { margin:0; background:var(--main-bg); color:var(--text); font-family:sans-serif; font-size:12px; height: 100dvh; display:flex; flex-direction:column; padding:6px; overflow:hidden; }
button { background:#333; color:#eee; border:1px solid #555; border-radius:4px; cursor:pointer; padding:6px; }
button:active { background: #555; }
.toggleOn { background:#27ae60 !important; }

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é‡è¦– */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; background:var(--panel-bg); padding:6px; border-radius:6px; border:1px solid var(--border); }
.main-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 6px; overflow-y: auto; align-content: start; }
.char-card { background:var(--panel-bg); border:1px solid var(--border); padding:8px; border-radius:8px; }
.char-name { font-weight:bold; color:var(--accent); font-size:11px; margin-bottom:2px; display:flex; justify-content:space-between; }
.equip-text { font-size:9px; color:#aaa; margin-top:2px; }

/* æ•µãƒ»é€²è¡Œã‚¨ãƒªã‚¢ */
.battle-panel { background:#222; border:1px solid #c0392b; padding:6px; border-radius:6px; margin-bottom:6px; }
.progress-bar { background:#111; height:4px; border-radius:2px; margin-top:4px; }
.progress-fill { background:var(--accent); height:100%; width:0%; transition:0.3s; }

/* ãƒ­ã‚°ãƒ»é€šçŸ¥ */
.log-area { height: 60px; background:#000; border:1px solid var(--border); border-radius:6px; margin: 4px 0; padding:4px; overflow-y:auto; font-size:10px; color:#888; display:flex; flex-direction:column-reverse; }

.footer { display: grid; grid-template-columns: 1fr 2.5fr; gap: 6px; height: 46px; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal { display: none; position: fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; justify-content:center; align-items:center; }
.modal-content { background:#222; border:1px solid #444; border-radius:10px; width:90%; max-width:300px; padding:15px; }
.dungeon-list { display: grid; gap: 8px; margin-top: 10px; }
.dungeon-btn { padding:12px; text-align:left; display:flex; justify-content:space-between; }
</style>
</head>
<body>

<div class="header">
    <div><strong>è–æ¯Pt: <span id="holy">0</span></strong></div>
    <div style="display:flex; gap:4px;">
        <button onclick="openModal('upgradeModal')">âœ¨å¼·åŒ–</button>
        <button onclick="openModal('gachaModal')">ğŸã‚¬ãƒãƒ£</button>
    </div>
</div>

<div class="battle-panel">
    <div style="display:flex; justify-content:space-between; font-size:11px;">
        <span id="targetName">å¾…æ©Ÿä¸­...</span>
        <span id="battleStep">0 / 10</span>
    </div>
    <div class="progress-bar"><div id="pFill" class="progress-fill"></div></div>
</div>

<div class="main-grid" id="partyList"></div>

<div class="log-area" id="log"></div>

<div class="footer">
    <button onclick="openModal('dungeonModal')" id="dqBtn" style="background:#2980b9;">ğŸ°æ½œã‚‹</button>
    <button id="autoBtn" onclick="toggleAuto()">ã‚ªãƒ¼ãƒˆé–‹å§‹</button>
</div>

<div id="dungeonModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0; text-align:center;">ğŸ° ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³é¸æŠ</h3>
        <div class="dungeon-list">
            <button class="dungeon-btn" onclick="startDungeon(0)"><span>ğŸŸ¢ åˆç´šï¼šé™ã‹ãªæ£®</span><span>Lv1~</span></button>
            <button class="dungeon-btn" onclick="startDungeon(1)"><span>ğŸŸ¡ ä¸­ç´šï¼šè’ã‚ŒãŸå»ƒéƒ½</span><span>Lv15~</span></button>
            <button class="dungeon-btn" onclick="startDungeon(2)"><span>ğŸ”´ è¶…ç´šï¼šç«œã®å·£</span><span>Lv40~</span></button>
        </div>
        <button onclick="closeModal('dungeonModal')" style="width:100%; margin-top:10px;">æˆ»ã‚‹</button>
    </div>
</div>

<div id="upgradeModal" class="modal">
    <div class="modal-content">
        <h3 style="margin:0; text-align:center;">âœ¨ è–æ¯å¼·åŒ–</h3>
        <div id="upRows" style="margin:15px 0;"></div>
        <button onclick="closeModal('upgradeModal')" style="width:100%;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="gachaModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 style="margin:0;">ğŸ è–æ¯ã‚¬ãƒãƒ£</h3>
        <div id="gachaResult" style="height:80px; display:flex; align-items:center; justify-content:center; font-weight:bold; color:var(--accent); font-size:18px;">ï¼Ÿ</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
            <button onclick="playGacha(1)">1å› (1Pt)</button>
            <button onclick="playGacha(10)" style="background:#8e44ad;">10å› (10Pt)</button>
        </div>
        <button onclick="closeModal('gachaModal')" style="width:100%; margin-top:10px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
const SAVE_KEY = "HolyRPG_v3.4.0";
let holy=0, autoIsOn=false, currentDungeon=null, step=0, inBattle=false;
let bonus={atk:0, def:0, hp:0, exp:0}, party=[];

const DUNGEONS = [
    { name:"é™ã‹ãªæ£®", lv:1, pow:1, boss:"å¤§æ£®ã®ç‹" },
    { name:"è’ã‚ŒãŸå»ƒéƒ½", lv:15, pow:5, boss:"äº¡å›½ã®é¨å£«" },
    { name:"ç«œã®å·£", lv:40, pow:15, boss:"å¤ã®ç„”ç«œ" }
];

class Char {
    constructor(n, j, i) { 
        this.name=n; this.job=j; this.icon=i; this.lv=1; this.exp=0; this.hp=100; this.maxHp=100; this.atk=10; this.def=5;
        this.wName="æœ¨ã®æ"; this.wVal=0; this.aName="å¸ƒã®æœ"; this.aVal=0;
    }
    update() {
        // ã‚¤ãƒ³ãƒ•ãƒ¬æŠ‘åˆ¶ã®ãŸã‚ä¿‚æ•°ã‚’0.07â†’0.03ã«ã€å›ºå®šå€¤ã‚’å¾®å¢—
        const g = 1 + (this.lv-1)*0.03;
        const baseH = (this.job==="ã›ã‚“ã—"?220:150);
        this.maxHp = Math.floor((baseH + bonus.hp + (this.lv-1)*20) * g);
        this.atk = Math.floor((15 + bonus.atk + (this.lv-1)*3 + this.wVal) * g);
        this.def = Math.floor((10 + bonus.def + (this.lv-1)*2 + this.aVal) * g);
        if(this.hp > this.maxHp || isNaN(this.hp)) this.hp = this.maxHp;
    }
}

function updateUI() {
    document.getElementById("holy").innerText = holy;
    const pl = document.getElementById("partyList"); pl.innerHTML = "";
    party.forEach(c => {
        c.update();
        const d = document.createElement("div"); d.className = "char-card";
        d.innerHTML = `
            <div class="char-name"><span>${c.icon}${c.name}</span><span>Lv${c.lv}</span></div>
            <div style="font-size:10px; color:#ff7675;">HP: ${Math.floor(c.hp)}/${c.maxHp}</div>
            <div class="equip-text">âš”ï¸[${c.wName}+${c.wVal}]</div>
            <div class="equip-text">ğŸ›¡ï¸[${c.aName}+${c.aVal}]</div>
        `;
        pl.appendChild(d);
    });
    const ur = document.getElementById("upRows"); ur.innerHTML = "";
    [{k:'atk',n:'æ”»æ’ƒ'},{k:'def',n:'é˜²å¾¡'},{k:'hp',n:'ä½“åŠ›'}].forEach(s => {
        const r = document.createElement("div"); r.style="display:flex; justify-content:space-between; margin-bottom:5px;";
        r.innerHTML = `<span>${s.n}:${bonus[s.k]}</span><div><button onclick="modBonus('${s.k}',-1)">-</button><button onclick="modBonus('${s.k}',1)">+</button></div>`;
        ur.appendChild(r);
    });
}

function startDungeon(idx) {
    currentDungeon = DUNGEONS[idx];
    step = 0; inBattle = false;
    closeModal('dungeonModal');
    addLog(`ğŸ° ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã€Œ${currentDungeon.name}ã€ã«é€²å…¥`);
    nextBattle();
}

function nextBattle() {
    if(!currentDungeon) return;
    step++;
    document.getElementById("battleStep").innerText = `${step} / 10`;
    document.getElementById("pFill").style.width = (step*10) + "%";
    
    if(step > 10) {
        addLog(`ğŸ‰ ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚¯ãƒªã‚¢ï¼è–æ¯Pt+3`);
        holy += 3; currentDungeon = null; inBattle = false; save(); updateUI(); return;
    }

    const isBoss = (step === 10);
    const p = currentDungeon.pow * (isBoss ? 3 : 1);
    const e = {
        name: isBoss ? `[BOSS] ${currentDungeon.boss}` : "é­”ç‰©",
        hp: (150 + step*50) * p,
        atk: (10 + step*5) * p,
        def: (5 + step*3) * p
    };
    document.getElementById("targetName").innerText = e.name;
    battle(e, isBoss);
}

function battle(e, isBoss) {
    inBattle = true;
    const it = setInterval(() => {
        party.forEach(c => {
            if(e.hp <= 0 || !c.alive) return;
            let d = Math.max(1, c.atk - e.def);
            if(Math.random()<0.1) { d *= 2; addLog(`${c.name}ã®å¿…æ®ºï¼`); }
            e.hp -= d;
        });

        if(e.hp <= 0) {
            clearInterval(it);
            addLog(`${e.name}ã‚’æ’ƒç ´`);
            if(isBoss) dropUnique();
            party.forEach(c => { c.exp += 40; if(c.exp>=100){ c.lv++; c.exp=0; addLog(`${c.name}LvUP`); } });
            inBattle = false; save(); updateUI();
            if(autoIsOn) setTimeout(nextBattle, 1000);
        } else {
            const t = party.find(c => c.hp > 0);
            if(!t) { clearInterval(it); addLog("å…¨æ»…..."); currentDungeon=null; inBattle=false; updateUI(); return; }
            t.hp -= Math.max(1, e.atk - t.def);
            if(t.hp <= 0) t.hp = 0;
            updateUI();
        }
    }, 150);
}

function dropUnique() {
    const target = party[Math.floor(Math.random()*4)];
    const prefixes = ["ä¼èª¬ã®", "å¤ã³ãŸ", "å…‰è¼ã", "è¡€å¡—ã‚‰ã‚ŒãŸ", "è–ãªã‚‹"];
    if(Math.random() > 0.5) {
        target.wName = prefixes[Math.floor(Math.random()*5)] + "å‰£";
        target.wVal += (currentDungeon.pow * 5);
        addLog(`ğŸ ${target.name}ãŒã€Œ${target.wName}ã€ã‚’å…¥æ‰‹ï¼`, "#f1c40f");
    } else {
        target.aName = prefixes[Math.floor(Math.random()*5)] + "é§";
        target.aVal += (currentDungeon.pow * 5);
        addLog(`ğŸ ${target.name}ãŒã€Œ${target.aName}ã€ã‚’å…¥æ‰‹ï¼`, "#f1c40f");
    }
}

function playGacha(t) {
    if(holy < t) return;
    holy -= t;
    let res = "";
    for(let i=0; i<t; i++) {
        const c = party[Math.floor(Math.random()*4)];
        if(Math.random()>0.5) { c.wVal += 2; res = "æ­¦å™¨å¼·åŒ–ï¼"; }
        else { c.aVal += 2; res = "é˜²å…·å¼·åŒ–ï¼"; }
    }
    document.getElementById("gachaResult").innerText = t > 1 ? "10é€£å¼·åŒ–å®Œäº†ï¼" : res;
    updateUI(); save();
}

function modBonus(k, v) {
    if(v > 0) { if(holy>=1){ bonus[k]+=1; holy-=1; } }
    else { if(bonus[k]>0){ bonus[k]-=1; holy+=1; } }
    updateUI(); save();
}

function toggleAuto() { autoIsOn = !autoIsOn; document.getElementById("autoBtn").classList.toggle("toggleOn", autoIsOn); if(autoIsOn && !inBattle) nextBattle(); }
function openModal(id) { document.getElementById(id).style.display = "flex"; }
function closeModal(id) { document.getElementById(id).style.display = "none"; }
function addLog(m, col="#888") {
    const l = document.getElementById("log"); const d = document.createElement("div");
    d.style.color = col; d.innerText = m; l.appendChild(d);
    if(l.childNodes.length > 20) l.removeChild(l.firstChild);
}

function save() {
    const d = { holy, bonus, party: party.map(c => ({n:c.name, j:c.job, i:c.icon, lv:c.lv, wN:c.wName, wV:c.wVal, aN:c.aName, aV:c.aVal}))};
    localStorage.setItem(SAVE_KEY, JSON.stringify(d));
}
function load() {
    const s = localStorage.getItem(SAVE_KEY);
    if(s) {
        const d = JSON.parse(s); holy=d.holy; bonus=d.bonus;
        party = d.party.map(p => { 
            let c=new Char(p.n, p.j, p.i); c.lv=p.lv; c.wName=p.wN; c.wVal=p.wV; c.aName=p.aN; c.aVal=p.aV; return c; 
        });
    } else {
        party = [new Char("ãƒ¬ã‚ªãƒ³","ã›ã‚“ã—","âš”ï¸"), new Char("ãƒŸãƒ©","ã¨ã†ãã","ğŸ—¡ï¸"), new Char("ã‚¢ãƒ¼ã‚¯","ã¾ã»ã†ã¤ã‹ã„","ğŸª„"), new Char("ã‚»ãƒ©","ãã†ã‚Šã‚‡","ğŸ•Šï¸")];
    }
}
load(); updateUI();
</script>
</body>
</html>
