<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>聖杯オートRPG</title>

<style>
body{
  margin:0;
  background:#111;
  color:#eee;
  font-family:sans-serif;
  font-size:14px;
  padding:6px;
}
h2{font-size:18px;margin:4px 0;}
.panel{
  background:#1a1a1a;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
  margin-bottom:6px;
}
.buttons{display:flex;gap:4px;}
button{
  flex:1;
  background:#333;
  color:#eee;
  border:1px solid #555;
  border-radius:6px;
  font-size:18px;
  padding:12px 0;
}
button:active{background:#666;}
.dead{opacity:0.4;}
.barWrap{background:#333;height:10px;border-radius:5px;overflow:hidden;}
.bar{background:#e74c3c;height:100%;}
.partyRow{display:flex;align-items:center;gap:6px;margin:2px 0;}
.icon{width:16px;height:16px;border-radius:4px;}
.log{font-size:12px;max-height:80px;overflow:hidden;}
</style>
</head>

<body>

<h2>聖杯オートRPG</h2>

<div class="panel">
距離 <span id="distance">0</span>m /
転生 <span id="rebirth">0</span> /
聖杯Pt <span id="holy">0</span>
</div>

<div class="panel">
<strong>敵</strong>
<div id="enemyName"></div>
<div id="enemyText"></div>
<div class="barWrap"><div id="enemyHpBar" class="bar"></div></div>
</div>

<div class="panel">
<strong>パーティ</strong>
<div id="party"></div>
</div>

<div class="panel">
<strong>聖杯強化（恒久）</strong>
<div class="buttons">
<button onclick="upgrade('atk')">ATK+</button>
<button onclick="upgrade('def')">DEF+</button>
<button onclick="upgrade('hp')">HP+</button>
</div>
</div>

<div class="panel log" id="log"></div>

<div class="panel buttons">
<button onclick="stepDungeon()">進む</button>
<button onclick="toggleAuto()">オート</button>
<button onclick="rebirth()">転生</button>
</div>

<script>
/* ===== キャラ定義 ===== */
const CHAR_DATA=[
 {name:"レオン",job:"せんし",color:"#3498db"},
 {name:"ミラ",job:"とうぞく",color:"#f1c40f"},
 {name:"アーク",job:"まほうつかい",color:"#9b59b6"},
 {name:"セラ",job:"そうりょ",color:"#2ecc71"}
];

const JOBS={
 せんし:{hp:140,atk:10,def:8},
 とうぞく:{hp:100,atk:9,def:5},
 まほうつかい:{hp:80,atk:14,def:3},
 そうりょ:{hp:90,atk:6,def:4}
};

/* ===== 敵 ===== */
const ENEMY_NAMES=["スライム","ゴブリン","オーク","スケルトン"];

class Enemy{
 constructor(dist){
  this.name=ENEMY_NAMES[Math.floor(Math.random()*ENEMY_NAMES.length)];
  this.maxHp=40+dist*0.6;
  this.hp=this.maxHp;
  this.atk=6+dist*0.05;
  this.def=dist*0.02;
 }
}

/* ===== キャラ ===== */
class Character{
 constructor(d,bonus){
  const j=JOBS[d.job];
  this.name=d.name;
  this.job=d.job;
  this.color=d.color;
  this.level=1;
  this.exp=0;
  this.maxHp=j.hp+bonus.hp;
  this.atk=j.atk+bonus.atk;
  this.def=j.def+bonus.def;
  this.hp=this.maxHp;
  this.alive=true;
 }
}

/* ===== 状態 ===== */
let party=[];
let distance=0;
let rebirthCount=0;
let holyPoint=0;
let bonus={atk:0,def:0,hp:0};
let currentEnemy=null;
let autoTimer=null;

/* ===== ログ ===== */
function addLog(t){
 log.innerHTML=t+"<br>"+log.innerHTML;
}

/* ===== セーブ ===== */
function saveGame(){
 localStorage.setItem("holyRPG",JSON.stringify({
  distance,rebirthCount,holyPoint,bonus,party
 }));
}
function loadGame(){
 const r=localStorage.getItem("holyRPG");
 if(!r) return false;
 const d=JSON.parse(r);
 distance=d.distance;
 rebirthCount=d.rebirthCount;
 holyPoint=d.holyPoint;
 bonus=d.bonus;
 party=d.party.map((p,i)=>new Character(CHAR_DATA[i],bonus));
 party.forEach((c,i)=>c.level=d.party[i].level);
 return true;
}

/* ===== 初期化 ===== */
function initParty(){
 party=CHAR_DATA.map(d=>new Character(d,bonus));
}

/* ===== バトル ===== */
function battle(enemy,end){
 const it=setInterval(()=>{
  party.forEach(c=>{
   if(!c.alive) return;
   enemy.hp-=Math.max(1,c.atk-enemy.def);
  });
  updateEnemyUI();
  if(enemy.hp<=0){
   clearInterval(it);
   party.forEach(c=>c.exp+=10);
   end();
   return;
  }
  const t=party.find(c=>c.alive);
  t.hp-=Math.max(1,enemy.atk-t.def);
  if(t.hp<=0)t.alive=false;
  updateUI();
 },800/8);
}

/* ===== 進行 ===== */
function stepDungeon(){
 distance+=10;
 currentEnemy=new Enemy(distance);
 updateEnemyUI();
 battle(currentEnemy,()=>{
  saveGame();
  updateUI();
 });
}

/* ===== UI ===== */
function updateUI(){
 distanceEl.textContent=distance;
 rebirthEl.textContent=rebirthCount;
 holyEl.textContent=holyPoint;
 partyEl.innerHTML="";
 party.forEach(c=>{
  const r=document.createElement("div");
  r.className="partyRow "+(c.alive?"":"dead");
  const i=document.createElement("div");
  i.className="icon";i.style.background=c.color;
  r.appendChild(i);
  r.appendChild(document.createTextNode(
   `${c.name}(${c.job}) Lv${c.level} HP${c.hp}/${c.maxHp} ATK${c.atk} DEF${c.def}`
  ));
  partyEl.appendChild(r);
 });
}
function updateEnemyUI(){
 if(!currentEnemy)return;
 enemyName.textContent=currentEnemy.name;
 enemyText.textContent=`HP ${currentEnemy.hp}/${currentEnemy.maxHp}`;
 enemyHpBar.style.width=(currentEnemy.hp/currentEnemy.maxHp*100)+"%";
}

/* ===== 操作 ===== */
function toggleAuto(){
 autoTimer?
 (clearInterval(autoTimer),autoTimer=null):
 (autoTimer=setInterval(stepDungeon,2000/8));
}

/* ===== 転生 ===== */
function rebirth(){
 if(distance<100){addLog("100m未満では転生不可");return;}
 rebirthCount++;
 holyPoint+=Math.floor(distance/100);
 distance=0;
 initParty();
 addLog("転生して聖杯Pt獲得");
 saveGame();
 updateUI();
}

/* ===== 聖杯強化 ===== */
function upgrade(type){
 if(holyPoint<=0)return;
 holyPoint--;
 bonus[type]+= type==="hp"?10:1;
 initParty();
 addLog(`${type.toUpperCase()}を強化`);
 saveGame();
 updateUI();
}

/* ===== DOM ===== */
const distanceEl=document.getElementById("distance");
const rebirthEl=document.getElementById("rebirth");
const holyEl=document.getElementById("holy");
const partyEl=document.getElementById("party");
const enemyName=document.getElementById("enemyName");
const enemyText=document.getElementById("enemyText");
const enemyHpBar=document.getElementById("enemyHpBar");
const log=document.getElementById("log");

/* ===== 起動 ===== */
if(!loadGame()) initParty();
updateUI();
</script>

</body>
</html>